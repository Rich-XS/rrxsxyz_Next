# 三层决策落实 - 快速参考卡片

**用途**: 当需要 Claude Code 执行重要决策时，直接复制粘贴使用

---

## 🚀 标准 Prompt 模板（复制使用）

```
!规则变更 请实施以下决策，并确保三层同步：

【决策内容】
- [具体说明要做什么]
- [触发条件是什么]
- [预期效果是什么]

【三层验证要求】
1. Layer 1（progress.md）：记录决策编号（D-XX）、内容、触发条件
2. Layer 2（CLAUDE.md 或相关模块文档）：更新规则说明、使用场景
3. Layer 3（Agent 配置 或 自动化脚本）：实现自动触发逻辑

【验收标准】
- 提供决策编号（D-XX）
- 列出更新的文件和具体行号
- 提供触发测试方法
- 回答验证问题：下次我说"[触发关键词]"时，你会做什么？

【优先级】
P0 / P1 / P2
```

---

## 📋 触发关键词速查表

| 关键词 | 适用场景 | Layer 2 文件 | Layer 3 文件 |
|--------|---------|-------------|-------------|
| **!规则变更** | 强制执行规则 | CLAUDE.md | Agent 配置 或 脚本 |
| **!Agent更新** | 修改 Agent 行为 | agent_config.md | .claude/agents/*.md |
| **!工作流优化** | 流程改进 | workflow_rules.md | Agent 配置 或 脚本 |
| **!架构调整** | 技术架构变更 | architecture_guide.md | - |
| **!成本优化** | 预算策略调整 | cost_optimization.md | Agent 配置 |

---

## ✅ 验收问题模板（检查是否真正落实）

**问题1（Layer 3 验证）**:
```
下次我说"[触发关键词]"时，你会做什么？
期望回答：[详细步骤1] → [步骤2] → [步骤3]
```

**问题2（失败处理）**:
```
如果 Layer 3 执行失败（如脚本报错），你会怎么办？
期望回答：记录错误到 progress.md + 发出警告 + 不阻塞后续任务
```

**问题3（触发条件）**:
```
这个决策的触发条件是什么？
期望回答：[列出所有触发条件，包括关键词、优先级、文件类型等]
```

**问题4（涉及文件）**:
```
这个决策涉及哪些文件？
期望回答：
- Layer 1: progress.md (行号: XX-YY)
- Layer 2: [文件名] (行号: XX-YY)
- Layer 3: [文件名] (行号: XX-YY)
```

---

## 🎯 常见场景快速模板

### 场景1: 要求自动执行某操作

```
!规则变更 请实施以下决策，并确保三层同步：

【决策内容】
- 每次 [触发条件] 时，必须自动 [执行操作]
- 不允许理由：[列出不接受的借口]
- 唯一例外：[如果有例外情况，说明]

【三层验证要求】
1. Layer 1（progress.md）：记录 D-XX 决策
2. Layer 2（CLAUDE.md）：更新工作流规范
3. Layer 3（scripts/xxx.js + package.json）：创建自动化脚本

【验收标准】
- 提供 npm 命令：npm run xxx
- 实际执行一次，展示结果
- 回答：下次触发时，你会先做什么？

【优先级】P0
```

---

### 场景2: 修改 Agent 行为

```
!Agent更新 请调整 [Agent名称] agent，并确保三层同步：

【调整内容】
- 当 [触发条件] 时，Agent 必须 [新行为]
- 禁止 [旧行为或错误行为]

【三层验证要求】
1. Layer 1（progress.md）：记录 Agent 调整决策
2. Layer 2（.claude/agent_config.md）：更新 Agent 职责说明
3. Layer 3（.claude/agents/[agent-name].md）：修改 Agent 提示词

【验收标准】
- 提供 Agent 配置文件的 diff（修改了哪些行）
- 模拟测试：当用户说"[触发词]"时，Agent 的执行步骤是什么？

【优先级】P0
```

---

### 场景3: 禁止某行为

```
!规则变更 请实施以下禁止规则，并确保三层同步：

【决策内容】
- 禁止 [具体行为]
- 即使 [特殊情况] 也不允许
- 唯一例外：[如果有，明确说明]

【三层验证要求】
1. Layer 1（progress.md）：记录禁止规则决策
2. Layer 2（CLAUDE.md 或 workflow_rules.md）：添加禁止规则说明
3. Layer 3（Agent 配置）：在所有相关 Agent 中添加检查逻辑

【验收标准】
- 提供检查逻辑代码（如适用）
- 回答：如果我要求你做 [被禁止的行为]，你会怎么办？
- 期望回答：拒绝 + 引用决策编号 + 提供替代方案

【优先级】P0
```

---

## ⚠️ 常见错误识别

**错误信号1**: Claude Code 只说"已记录到 progress.md"
- ❌ 问题：可能只完成了 Layer 1
- ✅ 追问：Layer 2 和 Layer 3 呢？请提供文件和行号

**错误信号2**: Claude Code 说"已更新文档"但没有提供测试方法
- ❌ 问题：可能 Layer 3 未实施
- ✅ 追问：如何触发测试？下次我说X时，你会做什么？

**错误信号3**: Claude Code 修改了 Agent 配置但没有模拟测试
- ❌ 问题：Agent 提示词可能写得不够明确
- ✅ 追问：请在当前对话中模拟一次触发，展示 Agent 的新行为

---

## 📊 三层验证清单（用户自查）

完成决策后，用户应检查：

```
[ ] Layer 1（progress.md）
    [ ] 搜索决策编号（D-XX），确认已记录
    [ ] 检查记录是否包含：决策内容、触发条件、时间戳

[ ] Layer 2（相关文档）
    [ ] 搜索关键词，确认文档已更新
    [ ] 检查是否包含：使用场景、注意事项、示例

[ ] Layer 3（自动化执行）
    [ ] 如果是脚本：执行 npm run xxx，确认命令可用
    [ ] 如果是 Agent 配置：在对话中触发一次，确认行为改变
    [ ] 检查失败处理逻辑是否存在

[ ] 验证问题（全部通过才算合格）
    [ ] 下次触发时的执行步骤？
    [ ] 失败时的处理方式？
    [ ] 涉及的文件和行号？
    [ ] 触发条件列表？
```

---

## 🎯 实战案例（直接复制修改）

### 案例1: 要求自动生成测试报告

```
!规则变更 请实施以下决策，并确保三层同步：

【决策内容】
- 每次运行 npm test 后，必须自动生成测试报告
- 报告格式：Markdown，包含通过率、失败用例、执行时间
- 报告路径：test_reports/TEST_REPORT_YYYYMMDD_HHMMSS.md

【三层验证要求】
1. Layer 1（progress.md）：记录 D-XX 测试报告自动生成决策
2. Layer 2（docs/TESTING_GUIDE.md）：创建测试文档，说明报告功能
3. Layer 3（scripts/generateTestReport.js + package.json）：实现自动化脚本

【验收标准】
- 提供 npm 命令：npm run test（应自动生成报告）
- 实际执行一次，展示生成的报告文件
- 回答：下次运行测试时，你会先做什么？（期望：运行测试 → 生成报告 → 记录结果）

【优先级】P1
```

---

### 案例2: 禁止直接修改生产环境文件

```
!规则变更 请实施以下禁止规则，并确保三层同步：

【决策内容】
- 禁止直接修改 production/ 目录下的文件
- 即使用户明确要求，也必须先警告并要求确认
- 唯一例外：用户说"已确认，允许修改生产环境"

【三层验证要求】
1. Layer 1（progress.md）：记录 D-XX 生产环境保护规则
2. Layer 2（CLAUDE.md 或 deployment_security.md）：添加生产环境保护说明
3. Layer 3（所有 Agent 配置）：添加路径检查逻辑

【验收标准】
- 回答：如果我说"请修改 production/config.js"，你会怎么办？
- 期望回答：拒绝 + 警告 + 引用决策编号 + 提供测试环境替代方案
- 提供 Agent 配置修改的 diff

【优先级】P0
```

---

**创建时间**: 2025-10-17 12:10
**用途**: 日常使用的快速参考
**配套文档**: `.claude/DECISION_3LAYER_TEMPLATE.md`（完整版）
