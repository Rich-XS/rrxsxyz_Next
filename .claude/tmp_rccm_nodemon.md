# RCCM 分析 - nodemon 软重启失效问题

**时间戳**: 2025-10-19 01:31 (GMT+8)
**决策编号**: D-74
**决策类型**: RCCM 分析 + 规则变更（开发环境工具链）
**优先级**: P0（影响开发调试效率）

---

## 问题现象
- 服务器日志显示"timeout after 20s"而非"timeout after 60s"
- 重试计数超过3次限制，达到26+次
- DeepSeek专家调用成功，但领袖调用失败

---

## 5 WHY 分析

**WHY #1**: 为什么超时错误显示"20s"而不是"60s"？
- **答**: 因为运行中的服务器进程使用的是旧代码

**WHY #2**: 为什么服务器进程使用旧代码？
- **答**: 因为nodemon的自动重启没有真正加载新代码（文件已正确保存为60s）

**WHY #3**: 为什么nodemon重启后未加载新代码？
- **答**: 因为Node.js的require缓存未被清除，有2个node.exe进程在运行（PID 22264和8028），导致重启混乱

**WHY #4**: 为什么require缓存未被清除？
- **答**: 因为有大量异步API调用正在进行（26+次重试循环），nodemon无法干净地终止旧进程

**WHY #5**: 为什么nodemon无法干净终止旧进程？
- **答**: 无限重试循环占用了事件循环 + nodemon的软重启机制在异步操作密集时不可靠 + 多个node进程并存

---

## Root Cause（根本原因）

**nodemon在高负载异步操作下的软重启失效问题**：
- 当代码修改触发重启时，如果有大量异步操作（API调用、重试循环）正在进行
- nodemon的SIGTERM信号无法立即终止进程
- 导致旧进程残留，新代码未能加载
- 多个 node.exe 进程并存，导致端口冲突和代码版本混乱

---

## Short-Term CM（P0 - 已执行）

✅ **立即对策**：手动强制重启服务器，清除所有node进程缓存
- **执行方法**：
  1. 停止所有 nodemon 进程
  2. 杀死所有残留的 node.exe 进程（PID 22264, 8028）
  3. 重新启动后端服务器（npm run dev）
- **执行结果**：服务器已在端口3001成功启动
- **验证状态**：✅ 需要测试确认60s超时和3次重试限制是否生效

---

## Long-Term CM（P1 - 待规划）

**建议对策**（按优先级排序）：

1. **P1 - 添加进程管理工具（PM2）替代nodemon**
   - 优势：更可靠的进程管理、自动重启、日志聚合、集群模式
   - 实施时间：1-2小时
   - 风险：需要学习新工具，修改启动脚本

2. **P1 - 实现优雅关闭机制（graceful shutdown）**
   - 在 server.js 中添加 SIGTERM/SIGINT 信号处理器
   - 关闭所有活跃连接、停止重试循环、清理资源
   - 实施时间：30-60分钟

3. **P2 - 添加服务器版本号检查机制**
   - 在代码中添加版本号常量（如 `SERVER_VERSION = "1.0.1"`）
   - 每次重启后在日志中打印版本号
   - 验证代码是否真正更新
   - 实施时间：15分钟

4. **P2 - 优化重试机制，避免无限循环**
   - 确保所有API调用的重试次数严格遵守限制（max 3次）
   - 添加全局重试计数器和熔断机制
   - 实施时间：30分钟

---

## 三层同步状态

- ✅ **Layer 1（progress.md）**：本决策记录
- ⏭️ **Layer 2（无需更新）**：开发环境工具选择，不涉及文档指导层
- ⏭️ **Layer 3（无需更新）**：开发环境配置，不涉及 agent 行为

---

## 预期效果

- **短期**：服务器重启成功，代码更新立即生效，调试效率恢复
- **长期**：使用 PM2 后，进程管理更稳定，开发体验显著提升

---

## 关联决策

- **D-65**: 端口分配规则（多项目端口隔离机制）
- **相关协议**: Night-Auth 无间断工作协议（避免人工重启依赖）

---

## 验证标记

✅ Short-Term CM 已执行（服务器重启完成）
⏳ Long-Term CM 待用户确认后规划实施

---

**记录人**: progress-recorder agent
**审核状态**: 待用户确认 Long-Term CM 实施优先级
