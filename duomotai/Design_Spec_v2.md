# 多魔汰风暴辩论系统设计规范 (Design Spec v2)

## 1. 系统架构设计

### 1.1 系统整体架构

多魔汰系统采用前后端分离架构，包含以下核心组件：
- **前端**：基于单文件HTML的轻量级前端界面，实现用户交互
- **后端**：Node.js + Express框架的API服务，处理业务逻辑
- **AI服务**：Qwen API（主）→ DeepSeek → OpenAI（降级）的多模型支持
- **数据存储**：JSON文件存储和LocalStorage本地存储相结合

### 1.2 技术栈

- **前端技术**：JavaScript (ES6+)、HTML5、CSS3
- **后端技术**：Node.js 18+、Express
- **AI服务**：Qwen API（主）→ DeepSeek → OpenAI（降级）
- **邮件服务**：Nodemailer（QQ邮箱）
- **部署环境**：支持本地开发环境和容器化部署

## 2. 核心功能设计

### 2.1 用户流程设计

#### 2.1.1 整体用户流程
1. 登录/注册 → 2. 填写问题背景 → 3. 选择角色 → 4. 确定轮次 → 5. 策划策略 → 6. 开始辩论 → 7. 查看报告 → 8. 导出报告

#### 2.1.2 流程细节
- 流程可视化：通过清晰的阶段指示器显示当前辩论进度
- 路径追踪：每个用户操作都有明确的反馈和记录机制
- 状态保存：支持中断恢复和本地数据保存

### 2.2 角色系统设计

#### 2.2.1 角色配置模块 (roles.js)

系统配置16个专家角色，每个角色具有以下属性：
- **唯一标识**(key)：角色在系统中的唯一ID
- **角色名称**(name)：完整角色名称
- **简称**(shortName)：简化的角色称谓
- **颜色编码**(layer)：用于界面视觉分类（蓝色核心层、紫色外部层、绿色价值层）
- **图标**(icon)：角色在界面上的视觉标识
- **系统提示词**(systemPrompt)：用于AI对话的提示词模板

#### 2.2.2 角色分类说明

- **核心分析层**（蓝）：第一性原理专家、时间穿越专家、上帝视角专家
- **外部威胁与机遇层**（紫）：杠精专家、买单客户、竞争友商、领袖(委托代理)
- **价值与行动层**（绿）：落地执行者、风险管理者、性能追求者、情绪追求者、社会认同者、潜在威胁、开发协调者、时间穿越者

### 2.3 辩论引擎模块 (debateEngine.js)

负责处理完整的5阶段辩论流程：

#### 2.3.1 阶段1：准备阶段（Preparation）
- 用户输入议题和背景信息
- 选择参与辩论的角色（必选角色+可选角色）
- 确定辩论轮次（3-10轮，支持自定义）

#### 2.3.2 阶段2：策划阶段（Planning）
- 领袖(委托代理)角色生成个性化辩论策略
- 针对委托人的特殊输入进行信息提取和确认
- 生成结构化的轮次主题规划和实施路径

#### 2.3.3 阶段3：确认阶段（Confirmation）
- 委托人审查和确认策略规划
- 可行性验证与优化建议提交
- 多轮对话的实时调整和确认

#### 2.3.4 阶段4：风暴辩论阶段（Storm Debate）
基于清晰的辩论框架和交互控制机制，实现：
1. **结构化流程框架**：定义完整的5阶段流程和各阶段核心目标
2. **决策演进规范**：建立每轮发言的内容递进机制和知识累积原则
3. **交互控制标准**：语音与文字同步、流式输出、发言顺序等交互控制规范
4. **专家发言标准**：定义不同阶段发言的内容结构、显示规范和交互标注

**风暴辩论核心架构**

**A. 流程结构规范**：
- **第1轮开篇**：
  - 核心：领袖(委托代理)开场明确陈述，并向委托人索取补充信息（关键路径）
  - 输出：构建完整的背景信息+角色构成+辩论重心
  - 交互：根据委托人信息会话"开场补充"，确保信息维持完整性及连贯性

- **多轮执行**：
  - 每轮遵循"轮流发言→中场转场→补充发言"的结构
  - 每轮中，领袖主导并分段展示讨论成果结构，管控议题走向
  - 发言过程展示内容层次递进关系

- **逻辑递进机制**：
  - 每轮发言必须体现前一轮关键信息
  - 支持专家间观点回应和论据深化
  - 知识积累：鼓励将前一轮的重要观点，在本轮发言中明确指出并强化

**B. 专家发言行为标准**：
- **第一性原则**：专家测试各类前提假设和行为模式
- **上帝视角**：综合评判过程细节，为决策提供视角视角保障
- **杠精专家**：直击核心问题，构建批判性视角
- **买单客户（目标导向）**：从实践和实效角度审视
- **竞争友商（压力视角）**：提供竞争环境下的技术或商业视角
- **时间穿越者**：允许时时建构和反思性参与

- **发言人行为规范**：
  - 直接引用和评估前面专家的观点（通过引用式定向）
  - 道歉性承认跃入实际情境中的extrinsic原因（例如：我承认原内容提出场景有些太理想）
  - 显示就事（议题）讨论的完整性概率：基于时间段评估（可引用每个专家任务时间及研究所消耗比例，用于统计决策准确性）

**C. 流程控制标准**：
- **流式处理机制**：语音流输出基于演讲完成信号，文字详情对齐
- **会话连贯性**：每次发言内容与上一轮对话相关，非独立片段
- **内容完整性**：每轮发言必须整合前段关键信息，避免EGO式无效发言

**D. 交互控制机制**：
- **流式同步**：文字和语音的流式输出应保持同步，文字"处理完成"后进行转义
- **交互反馈**：对委托人补充必须进行应及时处理并作为议程流动的调整信号
- **发言控制**：基于专家角色定位安排适量发言顺序，确保流程进行时政治正确和专业性
- **多轮事件处理**：
  - 如轮次含1轮以上，即独立进行各组主体讨论处理
  - 确保"重复异常"不会在连续的环节中发生
  - 避免连续投资片段处理而无协调与信息重建

**E. 决策交付机制**：
- 5轮流程完成后，需进行读取最终上报、内容整合与输出结构整理，并提取关键信息向用户提供可导出文本或图表（在结果窗口中）
- 系统必须自动从专家全部言论中提取摘要信息形成并发（向原来的DELEGATE的个人贡献价值链和各角色贡献比例分次分析）
- 提供可导出报告，带可定量分析和文献参考（知识框架、可量化合理度评价、冲突程度、贡献度、知识密度分布等）

#### 2.3.5 阶段5：交付阶段（Delivery）
- 生成完整的决策报告
- 提供可导出的数据格式和可视化展示
- 委托人反馈收集和系统优化建议

### 2.4 高级功能模块

#### 2.4.1 递进逻辑处理机制
在专家发言阶段实现接续性内容处理机制：
- **历史内容收集**：在handleRoleSpeak函数中收集前1-2轮发言内容
- **递进处理函数**：enhanceProgressiveLogic函数基于前几轮内容构建新发言
- **内容连贯性保证**：在专家发言中明确提及和引用前一轮专家的关键观点和结论
- **逻辑演进**：确保每轮专家发言都能体现之前的讨论进展

#### 2.4.2 文字流处理机制
- **流式增量显示**：通过handleRoleSpeak函数处理发言渲染，提供渐进式内容展示
- **状态同步**：实现流式更新（isStreaming）和完成更新（isComplete）两种状态
- **用户交互匹配**：根据状态自动滚动到最新发言内容

#### 2.4.3 语音同步模块 (Synctxt&voice v1.0)
- **语音输出控制**：提供语音开启/关闭开关，语音速度调节（1x-10x）
- **语音输入功能**：支持按住麦克风录音输入
- **语音与文字同步**：确保发言过程中的语音和文字内容同步显示
- **语音播放策略**：
  - 语音关闭：固定延迟500ms
  - 语音打开：等待语音播放完成并显示延迟控制机制

#### 2.4.4 专家发言格式化
- **关键词加粗**：对建议、问题、风险、机会、数据、挑战等关键词进行加粗显示
- **分项列表**：按意愿格式化显示文档，确保逻辑清晰
- **段落美化**：注重重点段落的大小和间距优化
- **轮次主题突显**：基于轮次主题的标题突出显示增强理解效果

#### 2.4.5 交互控制机制
- **输入控制**：流式输出和阻塞式操作相结合，在企业环境自动切换
- **权限控制**：专家发言与委托人输入整合控制
- **流程拦截**：用户暂停和明智取消流程训练机制

## 3. 界面设计规范

### 3.1 设计原则
遵循苹果风格设计规范：
1. **简洁性**：去除冗余元素，保持界面清爽
2. **圆角**：12px-16px动画圆角元素
3. **柔和阴影**：避免生硬边框，营造良好视觉体验
4. **高品质字体**：SF Pro Display / SF Pro Text / -apple-system
5. **渐变色**：增强视觉层次和专业感
6. **响应式**：移动端自适应设计
7. **动画**：流畅的过渡动画和交互反应
8. **留白**：充分利用空白区域提高阅读效率

### 3.2 色彩方案
- **核心蓝**：#007AFF（iOS 系统蓝）
- **外部红**：#FF3B30（iOS 警告红）
- **价值绿**：#34C759（iOS 成功绿）
- **背景暖米白**：#FFFAF0（模态框背景）

### 3.3 界面组件设计

#### 3.3.1 阶段指示器
- 显示当前辩论所处阶段
- 实时状态反馈，直观指示大概进度
- 支持用户在各阶段间定位和厘清进度

#### 3.3.2 角色卡片设计
- 金边标记必选角色，确保只能选择的专家
- 基于颜色分层分类：核心（蓝色）、外部（紫色）、价值（绿色）
- 显示专家形象和简要描述，强化委托人映射和认知

#### 3.3.3 发言区域设计
- 不同角色使用不同背景颜色区分
- 明确标注角色身份和发言顺序
- 专家类型标记和发言标签清晰易识别

#### 3.3.4 控制面板设计
- 语音控制：音量调节与语音开关并列
- 速度控制：文字和语音同步速度调节
- 输入控件：提供用户自我表达渠道

## 4. 系统交互流程设计

### 4.1 多魔汰系统5阶段流程详解

#### 4.1.1 准备阶段
- 用户输入核心问题和背景信息
- 接受选择的角色（可选组合）
- 设置辩论轮数（3-10轮）
- 支持并行技术文档和用户体验优化先关列表

#### 4.1.2 策划阶段
- 领袖AI评估议题和专家配置，按时间线和挑战提问
- 输出结构化策略，确保专家参与全面性；提示词中明确体现出专家侧重点、实际使用案例和风格匹配信息
- 启动与用户之间的优化访谈交互机制，收集关于对科普对象偏好、当前关注焦点和极端情况顾虑具体分析

#### 4.1.3 确认阶段
- 用户确认和确认策划提案
- 提供主动反馈空间以便快速选定专家、内容方向和管理权重
- 投射个性化风格和评级预算，明确访问端口和实用性衡量指标和评估机制

#### 4.1.4 辩论阶段
- Phase 1：轮流讨论：专家首次发言，设定基础观点和结构
- Phase 2：补充讨论：专家进行二次采纳，提出新论点和深化策略
- 委托人互动环节：每轮均提供委托人输入机制和评论和调整机会

#### 4.1.5 交付阶段
- 生成结构化报告
- 提供导出选项（PDF、JSON）
- 交互式模型综合评估和分析系统

### 4.2 用户控制设计

#### 4.2.1 控制接口面板
- 实时反馈各功能模块状态
- 多维度交互出口点位配置
- 权限措施及内容保护策略

#### 4.2.2 文字速度控制机制
- 用户可调整速度倍数（0.1x至5.0x）
- 控制通过state.textStreamingSpeed变量控制字符显示延迟
- 支持文本输出过程中的调节，实现流畅阅读

#### 4.2.3 停止/调整机制
- 实时暂停和取消功能设计
- 提供快闪图标和引导使用户能够启用/切换
- 总结退撤/暂停状态标识，用于跟踪会议节奏

## 5. 数据管理规范

### 5.1 用户数据存储
- **前端数据**：LocalStorage存储用户配置和对话历史
- **后端数据**：JSON文件存储用户选择和维度数据
- **数据结构**：统一的数据结构和key命名规范

### 5.2 上下文管理
- **对话持久化**：ContextDatabase模块实现对话过程的双向持久化
- **多轮对话支持**：支持历史对话记忆和状态一致性保障
- **状态追踪**：确保辩论过程中的上下文连续性

### 5.3 性能优化措施
- **避免大文件读取触发compacting**：通过模块化设计避免单文件加载问题
- **合理使用缓存机制**：优化核心组件加载速度
- **降低AI调用频率**：减少token消耗优化成本

## 6. 安全与部署规范

### 6.1 安全措施
- **环境变量配置**：通过.env配置访问和权限信息
- **API访问控制**：限制API调用频次和类型
- **输入数据过滤**：保护用户数据为不传输至第三方
- **权限管理机制**：严格控制各模块访问权限

### 6.2 部署要求
- **本地开发环境支持**：支持Python 3+环境搭建本地静态服务器
- **Node.js环境配置**：Node.js 18+运行时环境
- **生产环境部署**：容器化部署支持

## 7. 质量控制与验收标准

### 7.1 测试规范
- **系统启动验证**：5分钟内正常启动
- **快速辩论流程**：3轮辩论30分钟内完成
- **语音与文字流同步**：5轮辩论15分钟内完成
- **边界情况测试**：针对各种输入情况的测试

### 7.2 性能指标监控
- **AI响应时间**：< 3秒
- **首屏加载时间**：< 2秒（移动端）/ 1秒（PC端）
- **Token消耗统计**：控制维度

### 7.3 验收标准
每个交付阶段应满足：
1. 功能完整性和一致性
2. 用户体验易用性
3. 系统稳定性和性能表现
4. 数据准确性和完整性

## 8. 项目发展方向和优化路线

### 8.1 已实现功能
1. 标准5阶段辩论系统
2. 16角色扁平化设计系统
3. 语音同步和文字流式显示机制
4. 递进逻辑处理功能
5. 用户体验优化和界面美化

### 8.2 待优化特性
1. 专家自定义与专业知识融合机制
2. 系统故障容错处理
3. 行为预测与自动优化框架
4. 多语言和可视化系统
5. 系统部署自动加载机制

---
**版本历史：**
- 2.0.0: 第二版设计规范，整合v13文档改进建议