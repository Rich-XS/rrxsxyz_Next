# 多魔汰风暴辩论系统设计规范 (Design Spec v2.1 - 交付标准版)

## 1. 系统架构设计

### 1.1 系统整体架构

多魔汰系统采用前后端分离架构，包含以下核心组件：

- **前端模块**：基于单文件HTML的轻量级前端界面，实现用户交互
- **后端服务**：Node.js + Express框架的API服务，处理业务逻辑
- **AI服务**：Qwen API（主）→ DeepSeek → OpenAI（降级）的多模型支持
- **数据存储**：JSON文件存储和LocalStorage本地存储相结合
- **语音服务**：集成Web Speech API支持语音输入输出处理

### 1.2 技术栈及实现标准

- **前端技术**：JavaScript (ES6+)、HTML5、CSS3，确保苹果风格设计规范
- **后端技术**：Node.js 18+、Express，RESTful API设计
- **AI服务**：Qwen API（主）→ DeepSeek → OpenAI（降级）
- **邮件服务**：Nodemailer（QQ邮箱）用于测试邮件发送验证
- **部署环境**：支持本地开发环境和容器化部署

## 2. 核心功能设计

### 2.1 用户流程设计

#### 2.1.1 核心用户流程（交付标准）

1. **身份认证与注册**：用户可通过手机号快速注册/登录
2. **问题输入**：用户定义核心问题和业务背景（最少100字符）
3. **专家配置**：选择必选角色+可选角色，显示专家介绍（含昵称）
4. **轮次设置**：可设置3-10轮次，默认为5轮
5. **策划决策**：领袖AI基于委托人需求和专家配置生成优化策略
6. **风暴辩论**：多轮专家辩论（交替发言+补充讨论）+委托人互动
7. **报告生成**：生成决策报告，包含关键点总结与建议
8. **结果导出**：支持PDF和JSON格式导出

#### 2.1.2 流程环节标准（每个环节的具体形式）

1. **信息完整性验证**：每个步骤必须确保信息输入质量（核心问题70字符以上）
2. **可视化反馈机制**：每个操作均需有进度、状态、错误信息展示
3. **状态管理机制**：支持会话中断恢复和状态旁路监控
4. **控制空间优化**：关键操作必须提供"已知操作"标识（如确认/取消按钮）

### 2.2 角色系统设计

#### 2.2.1 角色配置监控（标准清单）

| 角色名称 | 英文名 | 唯一标识Key | 简称 | 颜色 | 图标 | 系统提示词工程参数 |
|---------|--------|------------|------|------|------|------------------|
| 第一性原理专家 | Elon | first_principle | FP | 蓝色核心层 | ⚛️ | 前提假设检验机制 |
| 时间穿越专家 | Clara | time_traveller | TT | 蓝色核心层 | ⏳ | 时序判断流程 |
| 上帝视角专家 | Zeus | god_view | GV | 蓝色核心层 | 🌟 | 全局权衡模型 |
| 杠精专家 | Donald | contrarian | CT | 紫色外部层 | ⚠️ | 批判性思维 |
| 买单客户 | Chloe | customer | CB | 紫色外部层 | 👤 | 业务反馈机制 |
| 竞争友商 | Eve | competitor | CP | 紫色外部层 | 📊 | 市场竞争模型 |
| 领袖(委托代理) | Victoria | delegate | DL | 紫色外部层 | 🏆 | 任务分割机制 |
| 落地执行者 | Owen | executor | EX | 绿色价值层 | 🛠️ | 实施负荷评估 |
| 风险管理者 | Rick | risk_manager | RM | 绿色价值层 | 🛡️ | 潜在风险预测 |
| 性能追求者 | Jason | performance | PP | 绿色价值层 | ⚡ | 效率效能模型 |
| 情绪追求者 | Joy | emotion | EM | 绿色价值层 | 🫶 | 情绪倾向分析 |
| 社会认同者 | Liam | social | SA | 绿色价值层 | 👥 | 群体认知模型 |
| 潜在威胁 | Jack | threat | TH | 绿色价值层 | ⚠️ | 不稳定因素识别 |
| 开发协调者 | Mary | coordinator | CD | 绿色价值层 | 🆘 | 协作度评估 |
| 时间穿越者 | Clara | time_revisitor | TR | 绿色价值层 | 🔄 | 承诺一致性 |

#### 2.2.2 角色人员分配机制

为支持项目实施，角色可分配给具体人员，以下为专家角色与具体人员的对应关系：

| 角色名称 | 英文名 | 具体人员 | 性别 | 说明 |
|---------|--------|---------|------|------|
| 第一性原理专家 | Elon | Elon | 男 | 第一性原理专家 |
| 时间穿越专家 | Clara | Clara | 女 | 时间穿越专家 |
| 上帝视角专家 | Zeus | Zeus | 男 | 上帝视角专家 |
| 杠精专家 | Donald | Donald | 男 | 杠精专家 |
| 买单客户 | Chloe | Chloe | 女 | 买单客户 |
| 竞争友商 | Eve | Eve | 女 | 竞争友商 |
| 领袖(委托代理) | Victoria | Victoria | 女 | 领袖(委托代理) |
| 落地执行者 | Owen | Owen | 男 | 落地执行者 |
| 风险管理者 | Rick | Rick | 男 | 风险管理者 |
| 性能追求者 | Jason | Jason | 男 | 性能追求者 |
| 情绪追求者 | Joy | Joy | 女 | 情绪追求者 |
| 社会认同者 | Liam | Liam | 男 | 社会认同者 |
| 潜在威胁 | Jack | Jack | 男 | 潜在威胁 |
| 开发协调者 | Mary | Mary | 女 | 开发协调者 |
| 时间穿越者 | Clara | Clara | 女 | 时间穿越者 |
| VC投资人 | Mark | Mark | 男 | VC投资人 |
| 行业专家 | Jane | Jane | 女 | 行业专家 |

**角色保护机制**：用于增强角色间互动的必要性设计
- 必选角色：领袖(委托代理)、第一性原理专家、上帝视角专家
- 可选角色：其余13个角色，可按需选择，最多不超过4个

### 2.3 辩论引擎模块 (debateEngine.js) - 核心交付标准

#### 2.3.1 阶段1：准备阶段（Preparation）- 交付标准

- **输入校验规范**：核心问题输入要求最少70字符，立体描述
- **信息收集验证**：通过前后端联动确认信息合规性
- **之前模块检查**：防止重复数据输入和无效数据句读取
- **标准记录格式**：统一的数据储存方式（json数据建模导出）

#### 2.3.2 阶段2：策划阶段（Planning）- 交付标准规范

- **策略生成机制**：AI生成3轮结构化策略，含：
  - 每轮设定目标（主题+规则）
  - 专家评论机制说明
  - 关键瓶颈预测表
- **状态登记机制**：创建谈话记录（P-1）说明文档建立
- **协同模式整备**：每个AI专家的群讨论调控队列

#### 2.3.3 阶段3：确认阶段（Confirmation）- 交付出标准

- **确认流控机制**：委托人需对3个关键点确认（题项、轮数、专家）
- **确认处理流程**：应对处理器通过API回调处理
- **确认结果化**：生成最终确认摘要

#### 2.3.4 阶段4：风暴辩论阶段（Storm Debate）- 交付标准核心

**A. 风暴辩论整体结构要求**

- **定义维度引擎**：01#计划系统：辩论安排矩阵，路径清晰
- **流程控制流**：微博分段，每轮必须定义主题
- **知识链管理**：形成合理结构的线性知识目录，支持找回和评估
- **路径执行装置**：系统必须包含"路径执行"检查逻辑

**B. 风暴辩论标准流程（基于ideas.md 616-630行要求）**

**1. 领袖(委托代理)关键作用**
领袖是整个风暴辩论的关键人物，必须展现承上启下的关键作用：

**2. 第1轮开场要求**
- 介绍整个风暴辩论的问题点与背景总结信息
- 介绍委托人和与会专家（含昵称）
- 介绍整个多轮风暴辩论的计划（各轮主题）
- 介绍执行方式（先轮流发言，中场小结后进入下半轮补充发言，最后总结）

**3. 每轮标准流程**

**轮开场阶段**
- 领袖：轮开场，点明本轮轮次、主题等Opening重要内容，并询问委托人"开场补充"
- 委托人："开场补充"

**上半轮-轮流发言阶段**
- 领袖："轮流发言"开场：领袖根据委托人"开场补充"，强调要点之后，宣布进入上半轮"轮流发言"
- 各专家：各专家轮流进行"轮流发言"环节

**中场转场阶段**
- 领袖：上半轮"轮流发言"结束，进入"中场转场前"，领袖继续上半轮"轮流发言小结"，邀请委托人补充
- 委托人：中场补充
- 领袖：委托人补充后，进入"中场转场后"，根据委托人补充，宣布进入下半场"补充发言"，邀请部分专家补充，其他专家也可自由风暴辩论发言

**下半轮-补充发言阶段**
- 各专家：下半轮各专家进行"补充发言"
- 领袖：下半轮"补充发言小结"，领袖就下半轮"补充发言"进行简单小结，之后邀请委托人做"本轮补充"
- 委托人："本轮补充"

**本轮总结阶段**
- 领袖：基于"轮流发言小结"/委托人"中场补充"/"补充发言小结"，结合委托人"本轮补充"，进行"本轮最终总结"，并宣布进入下一环节

**C. 专家发言行为细节标准**

**1. 内容递进规范**
- 每轮发言必须有效引用前一轮发言信息（必须引用1次以上）
- 专家发言内容结构：**背景引入** → **分析观点** → **对应建议**
- 引用标准：不能"我再说说"或者"我再补充一下"，而是指明：如"Y观点延续"或"X观点关联"
- 保证专家发言的递进关系（基于之前轮和本轮发言的信息汇总）

**2. 信息完整性控制**
- 发言内容渗透度设定，可做四语句格子化管理
- 每轮业务内容贡献被标记和表示（无形中点线形式展示）
- 若出现"룰 disadvantage"需采用专家自动替换修正（Governor)

**3. 信息发布机制**
- 字符精确度：不超过350字符/段
- 语言普适性：避免过长术语表达、避免技术腐蚀
- 对象匹配机制：根据角色属性确定发言优先级

**D. 流程交互控制标准**

1. **语音流平衡机制**
- 语音未开启时，文字展现滞后于音频500-1000ms延时匹配
- 语音开启时，必须等待当时段"AppleUNICATION COMPLETED"后继续下一专家
- 文字显示应该使用逐步光标设置，严禁一次性显示

2. **多轮数据库反馈机制**
- 每轮结束时需生成段落句号标记(NL)
- 段落空间有效：在后端返回时必须截断或合并前后MNV处理

3. **语言状态标识机制**
- 发言状态标记：in-progress，有效，中止，完成
- 重播控制：同一段内容默认30秒内不可重播

**E. 专家角色参与规范**

1. **发言参与机制**
- 第1轮区分后台说法分析与方案指导
- 技术类术语统计方式可使用tag概念识别样本块
- 多轮时，可添加"片断延续分析"观点视角标注

2. **对话队列控制标准**
- 专家队列保持循环展示形式的轮播逻辑
- 每轮内可不保持首次顺序可能

#### 2.3.5 阶段5：交付阶段（Delivery）- 交付标准

- **决策报告生成**：基于5轮发言内容生成最终结论报告
- **报告展示机制**：支持图表曲线与条形图形成算法
- **导出功能**：PDF、JSON格式统一设计
- **评价收集机制**：记录用户对5轮辩论结果的打分（1-10分）
- **机制up吻合**：统计每个问题与对应约束完成程度

### 2.4 高级功能模块

#### 2.4.1 递进逻辑处理机制（标准版）

- **历史内容收集**：
  - 收集前1-2轮发言内容存储为上下文记忆池
  - 收集依据关键语义点命中3-5次以上判断为有效信息

- **递进处理函数**：
  - 基于前几轮内容构建新发言时构建递进模型
  - 包含："引用获得"、"回应逻辑"、"展开共识"、"表达延续"四个维度评估

- **内容连贯性保证**：
  - 专家发言中应明确提及和引用前一轮专家的关键观点和结论（每轮至少2次引用）
  - 状态标记为：isProgressiveEnhanced (true/false)用于控制段落生成

#### 2.4.2 文字流处理机制（双向同步）

- **流式增量显示**：通过handleRoleSpeak函数实时渲染发言内容
- **状态同步**：
  - 显示形式状态：isStreaming、isComplete
  - 可行性思想后端统一下发："显示后必须打标记untouched，
    发言突出安排"（EventEM TERM）

#### 2.4.3 语音同步模块 (Synctxt&voice v1.0 - OCR标准)

- **语音输出控制**：支持语音开关/速度调节（1x-10x）
- **语音输入功能**：按住麦克风录音输入（与文字输入协同）
- **语音与文字同步**：
  - 文字输出时确保不与前一段语音冲突
  - 张口后出现<tool_call>器（最快1.0s）开始语音标签+文字性别检测
- **语音播放策略**：
  - 固定延迟500ms（语音关闭）
  - 等待语音播放完成（语音打开）

#### 2.4.4 专家发言格式化器（3S模板）

- **关键词格式化规则**：关键词加粗赋予重imps
- **结构化段落**：每段3-5句构成，每句控制在100-150字符
- **文字美化功能**：使用段落边界逻辑，支持首行缩进或首段加粗
- **轮次主题符号**：以主题标题作为在牌状片段中唯一标识（区分平衡）

#### 2.4.5 交互控制机制（机制原点）

- **输入控制**：流式输出和阻塞式操作协同模式
- **权限控制**：专家发言与委托人输入捆绑控制
- **流程拦截**：用户暂停/取消逻辑具备图章机制（确认动作）

## 3. 界面设计规范

### 3.1 设计原则（苹果风格践行）

1. **简洁性**：去除冗余元素，保持界面清爽
2. **圆角**：12px-16px动画圆角元素
3. **柔和阴影**：避免生硬边框，营造良好视觉体验
4. **高品质字体**：SF Pro Display / SF Pro Text / -apple-system
5. **渐变色**：增强视觉层次和专业感
6. **响应式**：移动端自适应设计
7. **动画**：流畅的过渡动画和交互反应
8. **留白**：充分利用空白区域提高阅读效率

### 3.2 色彩方案

- **核心蓝**：#007AFF（iOS 系统蓝）- 委托人/专家主色
- **外部红**：#FF3B30（iOS 警告红）- 区分警告提示
- **价值绿**：#34C759（iOS 成功绿）- 成功状态标记
- **背景暖米白**：#FFFAF0（模态框背景）

### 3.3 界面组件设计

#### 3.3.1 阶段指示器
- 显示当前辩论所处阶段（只显示序号+分段符）
- 实时状态反馈，直观看进度条
- 支持用户在各阶段间定位及预先设定

#### 3.3.2 角色卡片设计
- 金边标记必选角色（支持动态界定）
- 基于颜色分层分类（核心蓝/外部紫/价值绿）
- 显示专家形象和简要描述（附嘲讽词）

#### 3.3.3 发言区域设计
- 不同角色使用不同背景颜色区分
- 明确标注角色身份和发言顺序
- 专家类型标记和发言标签清晰易识别

#### 3.3.4 控制面板设计
- 语音控制：音量调节与语音开关并列
- 速度控制：文字和语音同步速度调节
- 输入控件：提供用户自我表达渠道

## 4. 系统交互流程设计

### 4.1 多魔汰系统5阶段流程详解（全过程交付型）

#### 4.1.1 准备阶段
- 用户输入核心问题和背景信息（70字符以上）
- 接受选择的角色（限定角色不超过16个）
- 设置辩论轮数（最低3轮，最高10轮）
- 专家配置需验证完整度（至少跨层配置）

#### 4.1.2 策划阶段
- 领袖AI评估议题和专家配置，构建章节方案
- 输出结构化策略，含明确定义的建议、框架、冲突点
- 启动与用户间优化访谈对话机制

#### 4.1.3 确认阶段
- 用户确认和确认策划提案
- 提供主动反馈宏空间（点选完后自动创建简要问答）
- 进行能力扩展性测试（如评审）

#### 4.1.4 辩论阶段
- 轮流发言（3轮）→ 中场转场→ 补充发言（2轮）
- 每轮参与约2-3次的修正板交互（提升切分数）

#### 4.1.5 交付阶段
- 生成结构化报告并展示（中英文略）
- 提供导出选项（PDF、JSON格式）
- 支持NO模型参评

### 4.2 用户控制设计（地面工具管控）

#### 4.2.1 控制接口面板
- 实时反馈各功能模块状态（触发器驱动）
- 多维度交互出口点位配置
- 权限措施及内容保护策略

## 5. 数据管理规范

### 5.1 用户数据存储
- **前端数据**：LocalStorage存储用户配置和对话历史
- **后端数据**：JSON文件存储用户选择和维度数据
- **数据结构**：统一的数据结构和key命名规范

### 5.2 上下文管理
- **对话持久化**：ContextDatabase模块实现对话过程的双向持久化
- **多轮对话支持**：支持历史对话记忆和状态一致性保障
- **状态追踪**：确保辩论过程中的上下文连续性

### 5.3 性能优化措施
- **避免大文件读取触发compacting**：通过模块化设计避免单文件加载问题
- **合理使用缓存机制**：优化核心组件加载速度
- **降低AI调用频率**：减少token消耗优化成本

## 6. 安全与部署规范

### 6.1 安全措施
- **环境变量配置**：通过.env配置访问和权限信息
- **API访问控制**：限制API调用频次和类型
- **输入数据过滤**：保护用户数据为不传输至第三方
- **权限管理机制**：严格控制各模块访问权限

### 6.2 部署要求
- **本地开发环境支持**：支持Python 3+环境搭建本地静态服务器
- **Node.js环境配置**：Node.js 18+运行时环境
- **生产环境部署**：容器化部署支持

## 7. 质量控制与验收标准

### 7.1 测试规范
- **系统启动验证**：5分钟内正常启动
- **快速辩论流程**：3轮辩论30分钟内完成
- **语音与文字流同步**：5轮辩论15分钟内完成
- **边界情况测试**：针对各种输入情况的测试

### 7.2 性能指标监控
- **AI响应时间**：< 3秒
- **首屏加载时间**：< 2秒（移动端）/ 1秒（PC端）
- **Token消耗统计**：控制维度

### 7.3 验收标准
每个交付阶段应满足：
1. **功能完整性和一致性**：所有功能按规范实现
2. **用户体验易用性**：操作流程逻辑合理
3. **系统稳定性和性能表现**：部署验证通过
4. **数据准确性和完整性**：数据流验证无遗漏

## 8. 项目发展方向和优化路线

### 8.1 已实现功能
1. 标准5阶段辩论系统
2. 16角色扁平化设计系统
3. 语音同步和文字流式显示机制
4. 递进逻辑处理功能
5. 用户体验优化和界面美化

### 8.2 待优化特性
1. 专家自定义与专业知识融合机制（v2.2版）
2. 系统故障容错处理（v2.3版）
3. 行为预测与自动优化框架（v3.0版）
4. 多语言和可视化系统（v3.5版）
5. 系统部署自动加载机制（v3.7版）

---
**版本历史：**
- 2.1.0: 交付标准版 - 全面重构，达到项目交付颗粒度
- 2.0.0: 第二版设计规范，整合v13文档改进建议