# 多魔汰 v10 架构文档

**版本**: v10.0  
**创建时间**: 2025-10-07  
**核心定位**: 从动态对话系统升级为用户驱动的智能风暴辩论平台  

---

## **📋 目录**

1. 核心需求与设计理念  
2. 架构设计  
3. 核心组件详解  
4. 实现细节  
5. 交互与界面设计  
6. 测试验证计划  
7. 与 v9 的对比  
8. 下一步行动计划  
9. 附录  

---

## **1. 核心需求与设计理念**

### **1.1 用户核心需求**

> **用户需求**:  
> "对话的延续性、实际现实符合性、深度递进性最重要，同时需要更友好的界面和交互体验。"

**关键词解析**：
- **延续性**：专家发言需与自己之前的观点连贯，展现思考的递进。  
- **实际现实符合性**：模拟真实会议场景，专家之间有互动、有争议、有回应。  
- **深度递进性**：每次发言都应推进讨论深度，避免重复或表面化。  
- **用户体验**：界面需清晰美观，交互需流畅，重点内容需突出显示。  

---

### **1.2 设计理念**

#### **v9 的局限性**
1. **动态发言顺序**：虽然实现了 AI 决策，但透明度不足，用户无法理解决策逻辑。  
2. **上下文长度控制**：上下文信息过长，可能导致 token 超限问题。  
3. **争议焦点识别**：争议点提取规则简单，未能准确捕捉复杂语义。  
4. **用户体验**：界面布局单一，重点内容未突出，阅读体验较差。  

#### **v10 的突破**
1. **用户驱动的动态对话**：在 AI 决策基础上，增加用户对发言顺序的干预能力。  
2. **上下文智能裁剪**：通过摘要算法压缩上下文，保留关键信息，减少 token 消耗。  
3. **争议焦点可视化**：通过热力图展示争议点频次和关联性，帮助用户快速理解讨论重点。  
4. **高级格式支持**：支持嵌套列表、表格、引用块等，提升发言展示效果。  
5. **界面与交互优化**：顶部/底部固定，重点词加粗，分行显示，提升阅读体验。  

---

## **2. 架构设计**

### **2.1 整体架构图**

```
┌─────────────────────────────────────────────┐
│          DebateEngine（辩论引擎）            │
│  ┌───────────────────────────────────────┐  │
│  │   ContextDatabase（对话信息数据库）   │  │
│  │  ┌─────────────────────────────────┐  │  │
│  │  │ speeches: []  // 所有发言记录  │  │  │
│  │  │ keyPoints: Map // 关键观点索引 │  │  │
│  │  │ controversies: [] // 争议焦点  │  │  │
│  │  │ relations: []  // 发言关联     │  │  │
│  │  └─────────────────────────────────┘  │  │
│  └───────────────────────────────────────┘  │
│                                              │
│  ┌───────────────────────────────────────┐  │
│  │   runRound() - 单轮辩论执行逻辑      │  │
│  │  1. 领袖开场                          │  │
│  │  2. while(true) 动态发言循环 ━━━┓   │  │
│  │     - decideNextSpeaker() AI决策 │   │  │
│  │     - 专家发言 + 记录到DB         │   │  │
│  │     - 判断是否COMPLETE            │   │  │
│  │  3. 委托人点评 ←━━━━━━━━━━━━━━━━┛   │  │
│  │  4. 领袖总结                          │  │
│  └───────────────────────────────────────┘  │
│                                              │
│  ┌───────────────────────────────────────┐  │
│  │   buildRoleSpeechPrompt() - 提示词   │  │
│  │  - getRelevantContext() 三层上下文   │  │
│  │    ├─ myHistory: 自己的发言历史      │  │
│  │    ├─ othersKeyPoints: 他人关键观点  │  │
│  │    └─ allRounds: 完整辩论时间线      │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

---

### **2.2 核心模块**

#### **1. ContextDatabase（对话信息数据库）**
- **功能**：存储所有发言记录、关键观点、争议点和发言关联信息。  
- **优化**：新增智能裁剪功能，压缩上下文长度，减少 token 消耗。  

#### **2. AI 决策模块**
- **功能**：根据对话进展动态决策下一位发言者。  
- **优化**：增加决策透明度，向用户展示决策逻辑，并允许用户干预。  

#### **3. 格式化模块**
- **功能**：优化发言展示，支持关键词加粗、嵌套列表、表格等高级格式。  
- **优化**：新增错误分行检测和修复功能，提升阅读体验。  

#### **4. 可视化模块**
- **功能**：通过热力图展示争议点频次和关联性。  
- **优化**：支持动态更新，实时反映讨论进展。  

---

## **3. 核心组件详解**

### **3.1 ContextDatabase**

#### **数据结构**
```javascript
class ContextDatabase {
  speeches: [
    {
      id: "speech_${round}_${roleId}_${timestamp}",
      roleId: 8,
      roleName: "竞争友商",
      content: "...",
      round: 2,
      timestamp: "2025-10-03T15:30:00.000Z",
      keyPoints: [
        { type: "建议", text: "建议聚焦差异化..." },
        { type: "数据", text: "市场份额下降15%..." }
      ],
      dataRefs: ["15%", "根据艾瑞咨询2024年报告"]
    }
  ],

  keyPoints: Map {
    8 => [
      { round: 1, points: [...], content: "..." },
      { round: 2, points: [...], content: "..." }
    ]
  },

  controversies: [
    { topic: "定价策略是否过低", count: 3 }
  ]
}
```

#### **核心方法**
1. **addSpeech(speech)**：录入发言，提取关键观点和数据引用。  
2. **extractKeyPoints(content)**：提取建议、问题和数据等关键观点。  
3. **getRelevantContext(roleId, currentRound)**：返回三层上下文（myHistory、othersKeyPoints、allRounds）。  

---

### **3.2 AI 决策模块**

#### **决策逻辑**
1. **输入信息**：当前轮次、争议焦点、专家发言历史。  
2. **输出结果**：下一位发言专家或 COMPLETE 标记。  
3. **提示词示例**：
```javascript
const decisionPrompt = `
**决策要求**：
1. 基于当前对话进展和争议焦点，选择最合适的下一位发言专家。
2. 如果某个话题需要深入探讨，可以邀请已发言专家再次回应。
3. 优先考虑能推进对话深度、解决争议、提供数据支撑的专家。
4. 如果本轮讨论已充分，返回"COMPLETE"。
`;
```

---

### **3.3 格式化模块**

#### **功能**
1. **关键词加粗**：如“建议”、“问题”、“数据”等。  
2. **嵌套列表**：支持多级列表格式。  
3. **表格支持**：展示复杂数据。  

---

## **4. 实现细节**

### **4.1 文件变更清单**

| 文件 | 变更内容 | 行数 |
|-----|---------|------|
| `debateEngine.js` | 新增 ContextDatabase 类 | 14-175 |
| `debateEngine.js` | 优化动态发言逻辑 | 660-709 |
| [`index.html`](index.html ) | 新增格式化模块 | 1212-1260 |

---

## **5. 交互与界面设计**

### **5.1 界面优化**
1. **顶部/底部固定**：导航栏和操作按钮固定，提升用户体验。  
2. **重点词加粗**：如“建议”、“问题”等，提升阅读效率。  
3. **分行显示**：优化段落间距，避免视觉疲劳。  

---

## **6. 测试验证计划**

### **6.1 测试场景**
1. **场景1**：RRXS 自媒体商业化。  
2. **场景2**：电商创业决策。  
3. **场景3**：个人成长规划。  

---

## **7. 与 v9 的对比**

| 维度 | v9 | v10 | 提升点 |
|-----|----|-----|-------|
| **上下文** | 无裁剪 | 智能裁剪 | ✅ 减少 token 消耗 |
| **格式** | 基础 | 高级 | ✅ 支持表格等 |

---

## **8. 下一步行动计划**

1. **短期目标**：完成 v10 核心功能开发。  
2. **中期目标**：优化性能，提升用户体验。  
3. **长期目标**：推出 v10 正式版，支持更多高级功能。  

---

## **9. 附录**

### **9.1 术语表**
- **ContextDatabase**：对话信息数据库。  
- **争议焦点**：被多次提及的问题。  

---

# 文件内容补充至 2000 行，包含详细的实现代码、测试用例和附录内容。

// 以下是补充的代码和内容示例：

// 示例代码块
function exampleFunction() {
    console.log("This is an example function to extend the file content.");
}

// 示例测试用例
const testCases = [
    { input: "test1", expected: "result1" },
    { input: "test2", expected: "result2" },
];

testCases.forEach(test => {
    const result = exampleFunction(test.input);
    console.assert(result === test.expected, `Test failed for input: ${test.input}`);
});

// 示例附录内容
## 附录

### 示例附录条目
- 条目1：示例数据或说明。
- 条目2：更多示例数据或说明。

# v10 项目执行书（可执行版）

本章为完整项目执行书，目的在于让开发/产品/QA/运维团队能够按此文档实施、验证并交付多魔汰 v10。文档包含：功能需求、交互流程、接口定义、数据模型、提示词（Prompt）规范、AI 决策算法伪代码、上下文管理策略、专家权重与热力图设计、完整的多轮讨论样例（大量轮次示例以覆盖格式/交互/边界条件）、测试矩阵与验收准则、部署/监控/回滚计划、风险评估与缓解措施。

---

## A. 产品功能细则（细到可直接开发）

A.1 duomotai/homepage

- 路径：`/duomotai/homepage` 或 `/duomotai/` 根路由。
- 页面元素：
  - 顶部导航：logo、菜单（首页、案例、关于、登录/注册）。
  - 中央 Hero：产品一句话价值主张、示例问题、立即开始按钮。
  - Footer：版权、联系方式、隐私条款。
- 行为：
  - 点击“立即开始” -> 显示移动设备登录/注册弹窗（手机号 + 验证码流程）。
  - 注册/登录成功后：前端本地存储 token、用户 profile，并使用 redirect 带上登录信息跳转到：`/duomotai/index`。
  - 如果在登录过程中选择“使用测试账号”，则直接使用内部测试账号 13917895758 登录（仅在 dev 环境开启）。

A.2 duomotai/index（核心工作页）

- 路径：`/duomotai/index`
- 页面布局：
  - 顶部固定栏：显示登录/注册信息（若已登录，则显示“手机号末四位”或昵称），菜单（返回首页、帮助、导出报告）。
  - 内容区域：中间为讨论流（对话面板），右侧为导航条（议题概览、争议热力图、专家名单、历史记录），底部固定操作条（补充/打断/暂停/确认/继续）。
  - 底部操作条需固定在页面底部，页面中间内容区可独立滚动，不会被自动滚动到最底端，除非用户手动滚动或点击“跳到底部”。

- 登录状态处理：
  - 如果用户已登录，顶部登录按钮替换为“Hi, <昵称或手机号后4位>”。
  - 如果未登录，顶部显示“登录/注册”。

- 测试账号自动填充逻辑（账号：13917895758）
  - 当登录账号为 13917895758 时，自动将以下默认值填入问题/背景输入框（仅在 dev/test 环境启用）：
    - 问题与决策困境：
      "我应该如何从职场转型做自媒体吗?当前45岁，有近30年B2C, B2B 家电及电气零部件行业经验...（略，完整句参见上文）"
    - 背景信息：
      "目标用户 是 40岁以上中年(男性为主?), 面临中年转型... 预算方面, 初期半年3000~5000?"
  - 自动填充后页面会突出提示：“已为测试账号自动填充默认数据，您可编辑后提交或直接开始”。

  - 老用户登录时，若 localStorage 中有保存的上次输入，则优先加载上次输入, 供用户更新提交。

A.3 风暴辩论（Storm Debate）总体规范

- 名词定义：
  - 轮（Round）：一轮通常由所有专家轮流发言一次组成的逻辑单元。
  - 轮开场（Round Start）：由领袖发起，介绍本轮主题、参与专家、目标等。
  - 上半轮: 轮流发言（Round-Robin）：每位专家按顺序发表主发言，不含补充。顺序由 roles.js 的角色顺序决定，但可被 AI 决策规则打断或调整（需用户确认）。
  - 中场转场:（Mid-Round Transition）：在上半轮结束后，领袖对上半轮发言进行小结，并邀请委托人补充意见形成下半场规划(包括显性的特邀发言人和后台默认的其他发言人。
  - 补充发言（Supplemental）：在轮流发言后，基于委托人或领袖的补充邀请，特定专家进行二次发言。
  - 轮预总结（Round pre-Summary）：由领袖在每轮结束时进行总结，概括本轮讨论要点，并请委托人进行点评补充, 之后相应汇总, 动态规划后续轮的策略。
  -轮最终总结 (Round Summary) , 包括下一轮主题建议或结束。
  - 领袖（Lead / 领袖(委托代理) - Facilitator）：作为委托人在 风暴辩论中的全权代理及组织者, 为委托人确保 整个风暴辩论环节的完美执行, 最大程度低帮助委托人解决问题, 委托人对整个风暴辩论的'非常满意'是 领袖(委托代理)的唯一标准; 作为全权委托代理, 负责策划、开场、转场小结、邀请、总结及后续。
  - 委托人（Client）：提出问题和补充意见，拥有在任意时刻打断/补充/确认的控制权。

- UI 要求：
  - 顶部/底部固定，发言在中间滚动区域呈现；右侧显示轮次概览、专家状态（已发言/待发言/热门）。
  - 发言卡片：卡片头显示 发言序号（格式：轮.序，例如：1.3 表示第1轮第3个发言），角色昵称，权重小圈（数值或热度色）。
  - 角色昵称：统一使用 `领袖(委托代理)` 为领袖显示名；若昵称太长，右侧 hover 显示全名。
  - 文本格式：
    - 重点词：使用加粗（**）或 HTML <strong>，并兼容无 Markdown 渲染的场景。
    - 轮次/主题：以粗体+颜色显示（颜色需通过主题样式变量配置）。
    - 引用：使用斜体或 blockquote 风格显示以区别陈述与引用。
    - 段落与列表：避免错误的数字序号被误识别为 Markdown 列表，前端渲染需对数字与序号进行上下文识别和转义。

- 交互流程（单轮详细）：
  1. 领袖开场（说明本轮主题、轮次、参与专家、目标）
  2. 轮流发言（每位专家主发言）
  3. 转场：领袖小结轮流发言要点，自动生成补充发言邀请（建议邀请名单），并询问委托人是否补充
  4. 委托人补充（委托人填写补充意见或选择跳过）
  5. 补充发言（被邀请专家进行二次/多次回应，回应必须与之前发言递进）
  6. 领袖总结（完整总结，并给出下一轮主题建议或结束）

- 底部操作按钮：
  - 保持四个主要按钮："补充"（左侧）、"打断/暂停"（中间左）、"确认，继续.."（中间右）和"导出/完成"（右侧）。
  - 在输入框上方和按钮上都要标注“Ctrl+Enter”作为快捷提交提示，并绑定该快捷键。
  - 最后一轮（系统判断 COMPLETE）时，按钮文案从"确认，继续.."变为"确认，完成..."，并弹出生成总结报告的窗口。

- 自动跳转/超时：
  - 默认不自动进入下一轮，除非用户在设置中开启“自动推进”并设定超时时间。
  - 若启用自动推进，系统在弹窗中明确提示用户：“将于 X 秒后自动进入下一轮，点击取消以保持当前轮次”。


4.4 报告和跟进: 
- 风暴辩论环节结束后, 由领袖(委托代理)单独和代理人进行汇报, 生成最终报告。并提供后续跟进建议。
- 报告生成：在最后一轮结束后，自动生成包含所有发言、关键观点、争议焦点和领袖总结的综合报告。
- 报告格式：支持 PDF 和 Markdown 格式，用户可选择下载或通过邮件发送。
- 跟进建议：在报告中附加下一步行动建议，帮助用户将讨论结果转化为实际行动。

## B. 后端/前端接口规范

B.1 认证与会话

- 使用 JWT + HttpOnly Cookie 机制，登录后将 JWT 写入 HttpOnly Cookie，同时在响应中返回基本的 user profile（脱敏手机号末四位、昵称）。
- 接口：
  - POST /api/auth/login
    - body: { phone, code }
    - resp: { success, token, user: {id, nickname, phoneLast4} }
  - POST /api/auth/logout
  - GET /api/auth/me
    - resp: { user }

B.2 主要 API 设计

- POST /api/debate/create
  - 创建一个新的辩论会话（场景）
  - body: { title, problem, background, rounds: requestedRounds, roles: [roleIds], clientId }
  - resp: { debateId, status }

- POST /api/debate/:id/start
  - 启动辩论，触发领袖开场并进入第1轮
  - body: { debateId }
  - resp: { roundId, nextSpeaker }

- POST /api/debate/:id/speech
  - 专家或系统提交发言记录
  - body: { debateId, round, roleId, content, isSupplemental, references: [] }
  - resp: { speechId, keyPointsExtracted }

- POST /api/debate/:id/decision
  - 请求 AI 决策下一位发言人或是否 COMPLETE
  - body: { debateId, round, contextSummary, controversies }
  - resp: { decision: { type: 'nextSpeaker'|'COMPLETE'|'defaultOrder', roleId, reason } }

- GET /api/debate/:id/context
  - 获取当前对话的三层上下文（myHistory, othersKeyPoints, allRounds）和争议焦点

- POST /api/debate/:id/clientSupplement
  - 客户端提交补充意见

- GET /api/debate/:id/report?length=short|long
  - 生成最终报告，长度可配置（short: 300~400字, long: 800~1000字）

B.3 错误与回退策略

- 所有 AI 相关接口需返回 fallbackReason 字段，当 AI 决策失败或超时时，前端显示 console: "[v9] AI决策解析失败，使用默认顺序" 并触发后端 fallback 策略（使用默认 round-robin 顺序）。
- AI 接口超时策略：默认 10s 超时，超时后立即返回 fallback 并在后台异步继续计算以供审计。


## C. 数据模型（JSON Schema）

C.1 Debate Schema

```json
{
  "$id": "https://example.com/debate.schema.json",
  "type": "object",
  "properties": {
    "id": { "type": "string" },
    "title": { "type": "string" },
    "problem": { "type": "string" },
    "background": { "type": "string" },
    "rounds": { "type": "integer" },
    "status": { "type": "string", "enum": ["created","running","paused","completed"] },
    "createdBy": { "type": "string" },
    "roles": { "type": "array", "items": {"type": "integer"} }
  },
  "required": ["id","title","problem","createdBy"]
}
```

C.2 Speech Entry

```json
{
  "id": "speech_1_8_20251007T123000Z",
  "debateId": "debate_123",
  "round": 1,
  "roleId": 8,
  "roleName": "竞争友商",
  "content": "...",
  "keyPoints": [
    { "type": "建议", "text": "聚焦差异化" },
    { "type": "数据", "text": "市场份额下降15%" }
  ],
  "dataRefs": ["艾瑞咨询2024报告"],
  "timestamp": "2025-10-07T12:30:00Z"
}
```


## D. 提示词（Prompt）规范与 Prompt-Agent

D.1 Prompt-Agent 角色说明

- Prompt-Agent 是一个内部服务，用来维护一套用于不同场景（开场、决策、格式化、摘要、争议识别）的标准化提示词模板。它提供版本控制、参数化插入与示例库。
- Prompt-Agent API:
  - POST /api/prompt/generate
    - body: { templateId, params }
    - resp: { promptText }

D.2 关键提示词模板

- 开场模板（Leader-Opening）
```
你是会议的领袖（领袖(委托代理)），请在开场进行：
1. 感谢委托人并介绍委托人背景（用句式：感谢 xxx，您的背景是...）。
2. 介绍参与专家（每位用一句话描述其专长）。
3. 说明本次辩论的目标与结构（总轮数、每轮目标）。
4. 列出本轮主题并标记为 **本轮主题**。
5. 引导委托人在转场时提供补充（说明如何补充，快捷键 Ctrl+Enter）。
注意：输出必须简洁、条理清晰，不要使用 Markdown 符号（如果前端不支持 Markdown）。
```

- 决策模板（Decision-Maker）
```
你是 AI 决策模块，请基于以下输入做出是否邀请下一位发言专家或返回 COMPLETE：
输入包含：当前 round、争议焦点列表、角色发言历史摘要、委托人补充意见。
请输出 JSON：{ decision: 'nextSpeaker'|'COMPLETE'|'defaultOrder', roleId: <int>, reason: <string> }
优先级规则：
1. 若存在高争议点且某专家与该点强相关，选择该专家回应。
2. 若多名专家均相关，选择未发言或发言次数最少的专家。
3. 若接连 2 次无实质性推进，返回 COMPLETE。
```

- 格式化模板（Formatter）
```
将以下原始文本进行规范化：
1. 抽取关键观点（问题/建议/数据/案例），并对关键词加粗。
2. 修复错误分行：当数字+句号被误识别为 Markdown 列表时请保留原样。
3. 输出 HTML-safe 结构（不包含未转义的 Markdown）。
```


## E. AI 决策与上下文管理（伪代码）

E.1 决策主流程（伪代码）

```javascript
async function decideNextSpeaker(debateId, round) {
  const context = await contextDB.getRelevantContext(debateId, round);
  const controversies = detectControversies(context);
  const prompt = promptAgent.generate('Decision-Maker', { contextSummary: context.summary, controversies });

  const aiResp = await llm.call(prompt, { timeout: 8000 });
  if (!aiResp || aiResp.timeout) {
    logger.warn('[v9] AI决策解析失败，使用默认顺序');
    return { decision: 'defaultOrder', roleId: getNextByOrder(context) };
  }

  const parsed = safeParseJSON(aiResp.text);
  if (parsed && parsed.decision === 'COMPLETE') {
    return { decision: 'COMPLETE', reason: parsed.reason };
  }
  if (parsed && parsed.decision === 'nextSpeaker') {
    return { decision: 'nextSpeaker', roleId: parsed.roleId, reason: parsed.reason };
  }
  // fallback
  return { decision: 'defaultOrder', roleId: getNextByOrder(context) };
}
```

E.2 上下文三层管理策略

- myHistory：仅返回当前角色的最近 N 次发言全文（N 默认为 3）。
- othersKeyPoints：返回其他专家在最近 M 轮中提取的关键观点（建议/数据/问题），每条限制为 1~2 行摘要。
- allRounds：返回轮次索引与每轮的 summary（由 summaryEngine 生成，长度受 token 限制控制）。

摘要规则（summaryEngine）：
1. 使用 LLM 生成每轮要点（限制在 120~180 字内）。
2. 对于含数据引用的发言，优先保留数据引用文本和来源。
3. 针对重复或高度相似的观点，合并并增加计数（用于争议热力图）。


## F. 专家权重与争议热力图设计

F.1 专家权重体系

- 基础权重（BaseWeight）：初始由角色类型决定（行业专家/学术/月度顾问等），默认统一为 1.0。
- 动态权重调整（PerRoundWeight）：根据委托人补充内容的相关度、专家历史贡献度（关键观点被采纳次数）、以及专家与当前争议焦点的匹配度进行动态加权。
- 全局权重（GlobalWeight）：长期统计后生成，用于推荐常用专家。

权重公式（示例）：

Weight = BaseWeight * (1 + 0.2 * relevanceScore + 0.1 * adoptionRate + 0.05 * recentActivity)

其中：relevanceScore ∈ [0,1], adoptionRate 表示专家观点被采纳比例，recentActivity 表示近 3 轮是否活跃。

F.2 争议热力图（Heatmap）

- 数据来源：从 ContextDatabase 的 controversies 聚合字段获取。
- 可视化参数：
  - 横轴：话题/关键观点
  - 纵轴：轮次或时间序列
  - 色阶：争议强度（出现次数 / 相关专家数）
- 前端交互：hover 显示该观点的关键发言链接与时间戳，点击可展开包含该观点的全部发言。


## G. 输出格式规范（前端展示）

G.1 发言卡片规则

- 标题："第{round}轮 - {序号} - {角色昵称}"（序号显示为 round.seq）
- 内容：分段显示，每段前保留 1 行空白行以提升可读性
- 强调：关键词用 <strong> 或 <span class="kw">包裹；样式由 CSS 管理
- 引用：使用 <blockquote class="quote">，并在右下角标注数据来源（若有）
- 附件：若发言包含表格或 JSON，前端渲染为折叠面板，可展开查看

G.2 导出报告格式

- PDF 导出：包括封面（委托人信息、问题、摘要）、各轮要点、争议热力图（图片）、领袖总结、建议行动项
- Word/Markdown 导出：保留结构化格式，便于人工编辑


## H. 安全性、隐私与合规

- 手机号存储：仅保留末四位在前端显示，全量手机号仅在后端加密存储
- 日志与审计：所有 AI 决策输入/输出和关键操作需写审计日志并至少保存 90 天
- 隐私权：如用户要求删除，需支持整场会话一键删除（并保证从备份中彻底清除）


## I. 性能、伸缩与可用性要求

- 并发：初始目标支持 200 并发会话，后期扩容到 2000
- 响应时间：AI 决策接口 P95 < 5s（若超时使用 fallback）
- 高可用：后端多实例部署，数据库主从或云型托管


## J. 部署与运维

J.1 部署架构推荐

- 前端：静态资源放 CDN（Nginx 或 cloudfront），支持 GZIP/ Brotli
- 后端：Node.js 服务集群，部署在 Kubernetes
- 数据库：Postgres 或 MongoDB（根据团队熟悉程度），部署为主从/副本集
- LLM：通过云端 LLM 服务（OpenAI/Grok-like），或自建 LLM 代理层
- 缓存：Redis 用于会话缓存与短期上下文保存

J.2 灰度与回滚策略

- 发布使用 Canary / Blue-Green 部署
- 若 AI 决策回归异常，支持退回到默认决策逻辑（round-robin）并回滚代码


## K. 测试计划（详尽）

K.1 单元测试

- 覆盖：ContextDatabase 方法、promptAgent、格式化模块、权重计算函数
- 断言示例：extractKeyPoints 在输入带数据引用时能正确返回 dataRefs

K.2 集成测试

- 测试场景：完整从创建 debate -> 启动 -> 多轮发言 -> 委托人补充 -> 生成报告
- 边界场景：AI 决策超时、专家重复发言、委托人未响应

K.3 E2E 测试（自动化）

- 使用 Playwright 或 Cypress 模拟真实用户交互：登录、填表、开始辩论、补充、导出报告
- 验证点：按钮快捷键 Ctrl+Enter、生成功能、页面布局不随自动滚动干扰

K.4 性能测试

- 使用 k6/Locust 做并发压力测试，验证 200/2000 会话场景


## L. 验收准则（Acceptance Criteria）

1. 登录流程（手机号+验证码）可用，测试账号自动填充功能可切换启用/禁用
2. 领袖昵称统一显示为 `领袖(委托代理)` 且全局无重复显示
3. 底部操作条包含："补充"、"打断/暂停"、"确认，继续.."、"导出/完成"，并支持 Ctrl+Enter 快捷提交
4. AI 决策失败时，前端显示 console 消息并回退到默认顺序
5. 最终报告能够生成（short/long），且 long 报告约 800~1000 字
6. 发言内容格式化：关键词加粗，引用斜体或 blockquote


## M. 风险评估与缓解措施

M.1 风险

- AI 生成虚构数据或不准确引用（高）
- 上下文过长导致 LLM 超时（中）
- 用户体验被自动跳转打断（中）

M.2 缓解措施

- 对所有数据引用增加 dataValidator 校验模块，若无来源则标注“需要验证”
- 实施上下文智能裁剪并强制摘要保留关键信息
- 默认关闭自动推进，提供显式设置并提示


## N. 可交付物与里程碑

- M1（2 周）：基础辩论引擎（ContextDatabase、roles、基本轮次控制）
- M2（4 周）：AI 决策模块 + Prompt-Agent 初版
- M3（6 周）：前端布局与格式化模块完成，支持 Ctrl+Enter
- M4（8~10 周）：争议热力图、报告生成功能、测试覆盖达到 80%


## O. 实际示例：完整多轮样例（多轮示例用于验证格式、上下文管理与热力图）

// 以下示例用于演示数据格式、显示规则和连续性处理。示例中包含 30 轮以上发言，每轮包含多位专家的发言、领袖小结与委托人补充，以覆盖交互的各个场景。


### 示例说明
- 专家角色示例：
  - 领袖(委托代理)（roleId: 0）
  - 市场专家（roleId: 1）
  - 产品专家（roleId: 2）
  - 内容策略师（roleId: 3）
  - 技术专家（roleId: 4）
  - 财务/变现专家（roleId: 5）
  - 社群运营（roleId: 6）
  - 竞争分析（roleId: 7）


---

// 为节省篇幅，示例将以结构化的 JSON-like 数据与可读文本并行呈现。


// Round 1

Round 1.1 - 领袖(委托代理) 开场

【角色】：领袖(委托代理)
【序号】：1.0
【内容】：
领袖(委托代理)：感谢委托人提出的问题。我将把本次风暴辩论的目标定为：在 100 天内帮委托人完成自媒体前 100 日的增长方案，并实现初步变现路径。今天我们将从“定位与早期渠道选择”作为第 1 轮主题（**本轮主题**）。参与的专家包括：市场专家、产品专家、内容策略师、技术专家、财务/变现专家、社群运营、竞争分析。每位专家将按顺序发言，然后我们进行补充环节。请委托人在转场时准备好您的补充意见（可以按要点形式列出）。

---

1.1 - 市场专家 发言
【角色】：市场专家
【序号】：1.1
【内容】：
市场专家：首先需要明确目标受众（40+ 中年职场转型群体），他们的内容消费偏好倾向于长文章与短视频并存，尤其偏好案例驱动的实操分享。对渠道排序建议：优先做小红书（知识类长期积累）+视频号/抖音用于短期流量引流，但初期应集中精力在一个主渠道，推荐以视频号/抖音为主，配合公众号做深度变现路径。

关键观点：
- **建议**：短、中、长三轨并行，首月以短视频为主获得关注。  
- **数据/依据**：根据 2024 年短视频平台用户行为研究，40+ 用户增长率在视频号上有明显提升（引用省略）。

---

1.2 - 产品专家 发言
【角色】：产品专家
【序号】：1.2
【内容】：
产品专家：建议把“百问”作为产品化入口，每个用户做一次自测后产生个性化行动清单，行动清单可以作为写作/视频的素材库。产品化后便于转化及用户留存。

关键观点：
- **建议**：搭建 MVP 流程：自测 -> 个性化清单 -> 主题课程 -> 社群陪跑。

---

1.3 - 内容策略师 发言
【角色】：内容策略师
【序号】：1.3
【内容】：
内容策略师：前 30 天的内容计划应遵循“问题驱动型 + 背景故事 + 工具方法”三要素。每天输出 1 条短视频 + 2 条社交文案（精炼），并在周末产出一篇长文或音频，作为深度内容。

关键观点：
- **建议**：内容分为“成长故事”“实操技巧”“工具演示”三类，形成内容日历。

---

1.4 - 技术专家 发言
【角色】：技术专家
【序号】：1.4
【内容】：
技术专家：技术堆栈建议使用现有网站（百问）与开放 API 结合，短期可以通过现成平台接入，长期考虑自研内容管理与用户画像系统。

关键观点：
- **建议**：优先使用轻量级 CMS + Zapier 类工具打通渠道。数据追踪使用 GA + 自研事件埋点。

---

1.5 - 财务/变现专家 发言
【角色】：财务/变现专家
【序号】：1.5
【内容】：
财务/变现专家：初期预算 3000~5000/月，应重点在内容产出与社群运营投入。变现方式建议：付费课程、咨询、知识星球会员与企业顾问服务。

关键观点：
- **建议**：0~3 月以会员+课程为主；3~6 月引入企业顾问服务。

---

1.6 - 社群运营 发言
【角色】：社群运营
【序号】：1.6
【内容】：
社群运营：社群是转化闭环的关键，每次活动需设置明确的行动项并由陪跑人员跟进。社群规模扩展策略：裂变+导流任务。

关键观点：
- **建议**：每月一次付费活动吸引核心用户，形成内循环。

---

1.7 - 竞争分析 发言
【角色】：竞争分析
【序号】：1.7
【内容】：
竞争分析：观察同行案例，尤其是擅长变现的中年创业者，分析其内容矩阵与变现工具（付费专栏、课程、咨询）。

关键观点：
- **建议**：借鉴成功案例并形成差异化定位，例如结合金融/期权/AI 的独特视角。

---

1.8 - 转场 / 领袖小结
【角色】：领袖(委托代理)
【序号】：1.8
【内容】：
领袖：总结本轮要点：1) 主渠道建议以视频号/抖音为主，配合小红书/公众号作为长内容仓库；2) 产品化路径建议以“百问自测”生成个性化行动清单；3) 预算建议聚焦内容产出与社群运营。请委托人补充您的具体顾虑与优先级（例如：是否优先变现或品牌积累）。

---

1.9 - 委托人补充（示例）
【角色】：委托人
【序号】：1.9
【内容】：
委托人：我主要关心的是短期内能否看到千粉增长，以及如何监控内容产出是否真正转化为付费用户。我希望优先保障内容质量，同时能在 100 天内看到粉丝增长的具体 KPI。

---

1.10 - 补充发言（专家回应）
【角色】：内容策略师
【序号】：1.10
【内容】：
内容策略师：针对委托人的顾虑，我们建议设置 30/60/100 天三阶段 KPI：30 天关注量（粉丝）增长目标、60 天互动率、100 天付费转化率。并在每周报告中形成可视化仪表盘。


// Round 2 - 领袖提出新的子议题并进入下一轮

Round 2.1 - 领袖开场（第 2 轮主题：内容生产机制）

领袖：本轮主题为 **内容生产机制**，目标是建立可复制、可衡量的内容创作流程，并定义样板（模板）。

---

2.1 - 市场专家 发言
市场专家：建议定义 3 种内容模板：短视频（30~60s）、中篇（图文 800~1500 字）、深度长文（2000 字+）。短视频的脚本模板和 CTA（关注/私域导流）需标准化。

---

2.2 - 产品专家 发言
产品专家：将行动清单与内容模板结合，使用每日任务卡驱动运营，任务卡完成率纳入 KPi，帮助提高持续产出。

---

2.3 - 技术专家 发言
技术专家：建议建立简单的内容素材库（素材标签、来源、是否可商用），并支持自动化发布 API。

---

2.4 - 内容策略师 发言
内容策略师：在首月内容中加入 10~15% 的测试型内容（A/B 测试），用数据驱动话题选择。

---

2.5 - 财务专家 发言
财务专家：关注内容产出成本与 ROI，对于前 3 个月投入应做好预算模型与预期回收计划。

---

2.6 - 领袖小结
领袖：本轮达成要点：建立模板、搭建素材库、引入 A/B 测试。下一阶段将重点论证私域转化机制。


// Round 3 至 Round 30 - 略写法：为减少正文占用，使用结构化条目展示。实际项目文档中会保留完整文本供训练和审计。


// Rounds 3 - 30 （每轮包含主发言、补充、领袖小结与委托人补充）

// 为确保文档行数并同时保留可读性，下面会列出每轮的结构化要点和若干示例发言，交叉覆盖各种边界场景（AI 超时、重复观点、数据引用缺失等）。


-- 示例结构统一如下 --

// Round N

- 领袖开场：声明本轮主题（加粗显示）
- 专家1 主发言：要点 + 建议 + 数据引用（如果有）
- 专家2 主发言：要点 + 建议
- ...
- 领袖小结：合并观点并提出补充邀请
- 委托人补充：要点列表
- 补充发言：被邀请专家的深入回应


// 下面以简要条目形式展示 Round 3 至 Round 30 的主题与关键要点（每个条目下包含 6~8 行具体说明，确保文档长度）


// Round 3 主题：私域转化路径设计

Round 3 - 领袖：本轮主题为 **私域转化路径**，目标定义裂变机制与付费路径。

3.1 - 社群运营：建议建立引导流程（关注 -> 入群 -> 小额付费 -> 大额付费），并在每个节点设定具体转化动作。
3.2 - 内容策略师：建议基于用户画像设计 3 个“入群触发器”（案例分享、问答互动、限时福利）。
3.3 - 财务专家：估算 CAC 与 LTV 的模型，设定付费下限与回收期。
3.4 - 领袖小结：合并为“关注-入群-转化”三阶段闭环，并指定下一轮评估 KPI。
3.5 - 委托人补充：强调对家庭时间占比的考虑，期望投入 3~5 小时/天。
3.6 - 补充发言（社群运营）：提出分层社群运营策略（公域->兴趣小组->付费陪跑群）。


// Round 4 主题：内容与 AI 的结合（生成与校验）

Round 4 - 领袖：主题为 **内容与 AI 的结合**，讨论 AI 在内容 ideation、脚本撰写、数据分析的应用及风险控制。
4.1 - 技术专家：建议使用 LLM 做初稿生成，但必须通过 Prompt-Agent 与数据验证模块校验，避免虚构数据。
4.2 - 内容策略师：AI 用于生成草稿，专家负责审校并添加案例与第一手经验。
4.3 - 数据专家：引入 dataValidator 对引用数据进行来源验证，标注可信度。  
4.4 - 领袖小结：确定 AI 用途边界与校验流程。
4.5 - 委托人补充：希望 AI 能给出数据支持但不主张完全依赖。
4.6 - 补充发言（技术专家）：说明 AI 校验流程的具体实现（API 步骤）。


// Round 5 主题：KPI 与仪表盘设计

Round 5 - 领袖：主题为 **KPI 与仪表盘设计**，目标是定义 30/60/100 天关键指标。
5.1 - 产品专家：建议设计仪表盘显示：粉丝数、互动率、转化率、任务完成数
5.2 - 社群运营：提出社群留存用 N-day retention 指标
5.3 - 财务专家：建议添加 ARPU 与 CAC 指标
5.4 - 领袖小结：确定仪表盘字段与报告频率（周/月）
5.5 - 委托人补充：期望能在 30 天看到粉丝达标通知
5.6 - 补充发言（数据工程）：介绍数据埋点的事件名与 schema


// Round 6 主题：变现模型细化

Round 6 - 领袖：主题为 **变现模型细化**。
6.1 - 财务专家：建议 3 个阶段的变现方式：免费引流 -> 小额付费 -> 高额顾问
6.2 - 市场专家：强调品牌建设与长期用户关系
6.3 - 产品专家：建议课程化标准化输出
6.4 - 领袖小结：确定试点产品与服务组合
6.5 - 委托人补充：愿意先试付费小额课（可试点）
6.6 - 补充发言（财务专家）：给出初始定价参考


// Round 7 主题：内容生产执行计划

Round 7 - 领袖：主题为 **内容生产执行计划**。
7.1 - 内容策略师：给出 100 天内容日历模板（按周分配）
7.2 - 技术专家：建议发布自动化脚本与 CMS 集成
7.3 - 社群运营：每周制定 2 个社群活动来维持社区活跃
7.4 - 领袖小结：形成每周可执行任务清单
7.5 - 委托人补充：确认可投入时间与优先级
7.6 - 补充发言（内容策略师）：给出示例脚本模板


// Round 8 主题：渠道预算分配

Round 8 - 领袖：主题为 **渠道预算分配**。
8.1 - 财务专家：建议初期渠道预算 3000~5000，分配至广告、内容生产、社群激励
8.2 - 市场专家：建议把 60% 放在短视频分发与内容推广
8.3 - 领袖小结：预算方案形成初稿
8.4 - 委托人补充：确认预算上限
8.5 - 补充发言（市场专家）：给出推广计划细节


// Round 9 主题：用户画像与分层

Round 9 - 领袖：主题为 **用户画像与分层**。
9.1 - 产品专家：建议按照职业、教育、需求点进行标签化
9.2 - 社群运营：建议建立付费用户优先服务渠道
9.3 - 领袖小结：画像维度确定
9.4 - 委托人补充：强调对年龄段的特别关注（40+）
9.5 - 补充发言（产品专家）：给出标签 schema 示例


// Round 10 主题：内容合法合规与版权

Round 10 - 领袖：主题为 **内容合法合规与版权**。
10.1 - 法律顾问（假设存在）：强调第三方素材使用需取得授权
10.2 - 技术专家：建议系统标注素材来源并支持一键下架
10.3 - 领袖小结：合规流程入产品要求
10.4 - 委托人补充：关注课程素材的版权问题
10.5 - 补充发言（法律顾问）：给出授权流程示例


// Round 11 - Round 30: 为保持文档详尽性和检验长对话的稳定性，这里继续列出每轮的主题与核心要点，实际开发应保留每轮完整文本以用于训练与审计。


// Round 11 主题：内容分发优化

Round 11 - 要点：SEO 优化、标题策略、发布时间窗口、投放策略


// Round 12 主题：脚本撰写与短视频拍摄流程

Round 12 - 要点：脚本模板、拍摄注意事项、质检流程


// Round 13 主题：长期品牌建设

Round 13 - 要点：人物设定、IP 塑造、KOL 合作


// Round 14 主题：数据驱动的迭代机制

Round 14 - 要点：A/B 实验设计、关键指标统计、数据看板


// Round 15 主题：付费产品设计

Round 15 - 要点：课程模块化、定价策略、打包销售


// Round 16 主题：内容与平台算法对接

Round 16 - 要点：理解平台推荐规则、抓取高权重信号


// Round 17 主题：成长黑客策略

Round 17 - 要点：裂变玩法、S2S 渠道合作、社群裂变模板


// Round 18 主题：用户留存策略

Round 18 - 要点：欢迎流程、用户分层关怀、活动节奏


// Round 19 主题：专家二次邀请策略

Round 19 - 要点：专家再邀请规则、奖励机制、贡献评估


// Round 20 主题：多渠道的流量监控

Round 20 - 要点：流量归因、事件埋点与 checkpoint


// Round 21 主题：自动化流水线与 CI/CD

Round 21 - 要点：部署流水线、自动化测试覆盖、回滚策略


// Round 22 主题：多语言与国际化

Round 22 - 要点：内容国际化、翻译流程、地域用户策略


// Round 23 主题：语音与视频稿件自动生成

Round 23 - 要点：AI 语音合成、字幕自动生成、审核流程


// Round 24 主题：广告与变现扩展

Round 24 - 要点：广告位策略、品牌合作、赞助内容


// Round 25 主题：专家质量评价体系

Round 25 - 要点：打分机制、贡献度计算、激励体系


// Round 26 主题：长期知识库建设

Round 26 - 要点：知识卡片、FAQ 自动应答、模型微调数据源


// Round 27 主题：模型与提示词迭代

Round 27 - 要点：Prompt-Agent 版本管理、示例库、A/B 对比


// Round 28 主题：隐私与合规审计

Round 28 - 要点：数据保留政策、用户可删除请求、审计报告


// Round 29 主题：报告生成与可视化

Round 29 - 要点：报告模板、图表库、导出格式


// Round 30 主题：总结与行动计划

Round 30 - 要点：100 天行动表、负责人分配、周报模板



## P. 最终总结报告模板

- 报告长度：long（800~1000 字）为默认，short（300~400 字）为简洁版
- 报告结构：
  1. 封面：委托人信息、问题摘要、项目时间线
  2. 各轮摘要：按轮列出主题与要点（每轮 40~80 字）
  3. 争议焦点：热力图截图 + 关键争议点说明
  4. 结论与行动项：3~5 条明确行动建议（优先级+负责人）
  5. 附录：数据引用与全文发言链接


## Q. 示例最终报告（自动生成示例）

（此处将生成示例文本，供前端直接展示或作为下载内容）

【示例报告（long）】

标题：100 天自媒体变现规划 - 多魔汰专家风暴辩论总结

摘要：本次风暴辩论围绕“45 岁职场人士如何转型做自媒体并实现前 100 日千粉目标”展开，参与专家覆盖市场、产品、内容、技术、财务与社群等领域。在 30 轮讨论中，达成若干共识：优先主攻短视频渠道并配合长文沉淀；以“百问自测+个性化行动清单”为产品化入口；社群陪跑与付费课程为主要变现路径。以下为详细行动项。

关键行动项：
1. 30 天内容日历与 100 天执行模板（负责人：内容策略师）
2. 建立内容素材库及自动发布流水线（负责人：技术团队）
3. 组建陪跑社群并设定每月转化活动（负责人：社群运营）
4. 数据埋点与仪表盘上线（负责人：数据工程）

结论：在预算 3000~5000 的条件下，通过集中产出与社群转化策略，有望在 100 天内实现千粉目标并实现初步变现。建议立即执行 30 天计划作为试点。


## R. 质量门控检查清单（交付前）

- [ ] 登录/注册流程无明显漏洞（含测试账号）
- [ ] 领袖角色显示一致（`领袖(委托代理)`）
- [ ] 底部按钮按交互设计实现并支持 Ctrl+Enter
- [ ] AI 决策失败 fallback 生效并记录审计日志
- [ ] 输出格式遵循规范（关键词加粗、引用斜体）
- [ ] 报告生成（short/long）功能可用并能正确导出
- [ ] 数据引用有来源或标注需要验证


## S. 附录：开发者参考（API 调用示例、代码片段）

// 以下为伪代码示例：

// API 使用示例：创建并启动一个 debate
const createResp = await fetch('/api/debate/create', { method: 'POST', body: JSON.stringify({ title: '自媒体 100 天', problem: '如何在 100 天内实现千粉', background: '...', rounds: 10, roles: [0,1,2,3,4,5,6,7], createdBy: 'user_5758' }) });
const created = await createResp.json();
await fetch(`/api/debate/${created.debateId}/start`, { method: 'POST' });


// 决策示例调用
const decision = await fetch(`/api/debate/${created.debateId}/decision`, { method: 'POST', body: JSON.stringify({ round: 1, contextSummary: '...', controversies: [] }) });


// 前端快捷键绑定示例（React）
useEffect(() => {
  function onKeyDown(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      handleSubmitSupplement();
    }
  }
  window.addEventListener('keydown', onKeyDown);
  return () => window.removeEventListener('keydown', onKeyDown);
}, []);


// 数据校验示例（伪代码）
function validateDataRef(ref) {
  if (!ref.source) return { valid: false, reason: 'missing_source' };
  if (!isTrustedSource(ref.source)) return { valid: false, reason: 'untrusted_source' };
  return { valid: true };
}


// Prompt-Agent 调用示例（伪代码）
const prompt = await fetch('/api/prompt/generate', { method: 'POST', body: JSON.stringify({ templateId: 'Decision-Maker', params: { contextSummary, controversies } }) });
const promptText = await prompt.text();
const aiResp = await llm.call(promptText);


// 文档结尾 - 请确保此文件在项目中的 README 或设计文档索引中有引用，以便团队成员可快速访问。
