# 多魔汰风暴辩论系统设计规范 (Design Spec)

## 1. 系统架构设计

### 1.1 整体架构
多魔汰系统采用前后端分离架构，包含：
- 前端：基于单文件HTML的轻量级前端界面
- 后端：Node.js + Express框架的API服务
- 数据存储：JSON文件存储和LocalStorage

### 1.2 技术栈
- 前端技术：JavaScript (ES6+)、HTML5、CSS3
- 后端技术：Node.js 18+、Express
- AI服务：Qwen API（主）→ DeepSeek → OpenAI（降级）
- 邮件服务：Nodemailer（QQ邮箱）

## 2. 功能模块设计

### 2.1 角色配置模块 (roles.js)
系统配置16个专家角色，每个角色具有：
- 唯一标识(key)
- 角色名称(name)
- 简称(shortName)
- 颜色编码(layer)
- 图标(icon)
- 系统提示词(systemPrompt)

#### 角色分类：
1. **核心分析层** (蓝色)：第一性原则专家、时间穿越专家、上帝视角专家
2. **外部威胁与机遇层** (紫色)：杠精专家、买单客户、竞争友商、领袖(委托代理)
3. **价值与行动层** (绿色)：落地执行者、风险管理者、性能追求者、情绪追求者、社会认同者、潜在威胁、开发协调者、时间穿越者

### 2.2 辩论引擎模块 (debateEngine.js)
负责处理5阶段辩论流程：
1. **准备阶段**：接收用户输入，初始化辩论配置
2. **策划阶段**：领袖角色生成策略
3. **确认阶段**：委托人确认策略
4. **辩论阶段**：
   - 轮流发言
   - 中场转场
   - 补充发言
5. **交付阶段**：生成报告并提供后续服务选项

### 2.3 文字流处理模块
支持流式增量显示专家发言内容：
- 使用handleRoleSpeak函数处理发言渲染
- 实现流式更新（isStreaming）和完成更新（isComplete）
- 根据状态自动滚动到最新发言

### 2.4 语音同步模块 (Synctxt&voice v1.0)
实现以下功能：
- 语音输出开关控制
- 语音速度调节（范围1x~10x，默认5x）
- 语音输入功能（按住麦克风录音）
- 语音与文字同步显示

### 2.5 专家发言格式化
- 关键词加粗（建议、问题、风险、机会、数据、挑战等）
- 分项列表分行显示
- 段落美化（重点段落加大间距）
- 基于轮次主题的标题突显

### 2.6 递进逻辑处理机制
- 在嘉宾发言函数（handleRoleSpeak）中，收集前1-2轮的专家发言内容
- 递进逻辑处理函数（enhanceProgressiveLogic）基于前几轮内容构建新发言
- 递进内容包含：对前一轮内容的确认、补充和扩展信息
- 在专家发言中明确提及和引用前一轮专家的关键观点和结论，确保逻辑连贯

## 3. 界面设计规范

### 3.1 设计原则
遵循苹果风格设计规范：
1. 简洁性：去除冗余元素
2. 圆角：12px-16px
3. 柔和阴影：避免生硬边框
4. 高品质字体：SF Pro Display / SF Pro Text / -apple-system
5. 渐变色：增强视觉层次
6. 响应式：移动端自适应
7. 动画：流畅的过渡动画
8. 留白：充分利用空白区域

### 3.2 色彩方案
- 核心蓝：#007AFF（iOS 系统蓝）
- 外部红：#FF3B30（iOS 警告红）
- 价值绿：#34C759（iOS 成功绿）
- 背景暖米白：#FFFAF0（模态框背景）

### 3.3 界面组件
- 阶段指示器：显示当前辩论阶段状态
- 角色卡片：金边标记必选角色
- 发言区域：不同角色区分背景色
- 控制面板：语音控制、速度调节、输入控件

## 4. 交互流程设计

### 4.1 多魔汰系统5阶段流程
1. **准备阶段**：用户输入问题和背景、选择角色、确定轮次
2. **策划阶段**：领袖生成策略、委托人确认和补充
3. **确认阶段**：委托人确认策略、开始正式辩论
4. **辩论阶段**：
   - 专家轮流发言（轮播）
   - 中场转场（委托人补充）
   - 补充发言（专家自由发挥）
5. **交付阶段**：生成报告、提供导出选项和后续服务

### 4.2 文字速度控制机制
通过JavaScript函数adjustTextRate实现：
- 用户点击+/-按钮调整速度倍数
- 速率范围：[0.1, 0.2, 0.5, 1.0, 2.0, 5.0]x
- 通过state.textStreamingSpeed变量控制字符显示延迟

### 4.3 模块化设计
- 所有模块独立封装：userAuth.js、userProfile.js、contextDatabase.js等
- 遵循模块化、轻量化原则
- 支持按需加载

## 5. 数据管理规范

### 5.1 用户数据存储
- 前端数据：LocalStorage存储
- 后端数据：JSON文件存储
- 使用统一的数据结构和key命名规范

### 5.2 上下文管理
- ContextDatabase模块实现上下文持久化
- 支持多轮对话记忆
- 确保辩论过程中的状态一致性

### 5.3 性能优化措施
- 避免大文件读取触发compacting
- 合理使用缓存机制
- 降低AI调用频率以减少token消耗

## 6. 测试规范

### 6.1 测试用例设计
基于PRE_TEST_CHECKLIST.md定义的测试流程：
1. 系统启动验证（5分钟）
2. 快速辩论流程（3轮，15分钟）
3. 语音与文字流同步测试（5轮，15分钟）
4. 边界情况测试（5分钟）

### 6.2 性能指标监控
- AI响应时间：< 3秒
- 首屏加载时间：< 2秒（移动端）/ 1秒（PC端）
- Token消耗统计

## 7. 安全与部署

### 7.1 安全措施
- 环境变量配置（.env）
- API调用安全策略
- 输入数据过滤与验证
- 权限管理机制

### 7.2 部署要求
- 支持本地开发环境运行
- Node.js 18+环境
- Python 3+环境（用于静态服务器）

---

**版本历史：**
- 1.0.0: 设计规范第一版，基于多魔汰v3.0架构定义