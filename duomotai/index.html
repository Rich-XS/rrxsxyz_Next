<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šé­”æ±°é£æš´è¾©è®ºç³»ç»Ÿ v3 - RRXS.XYZ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .slogan {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .header .version-tag {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 30px;
        }

        .input-group label {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .roles-section {
            margin: 30px 0;
        }

        .roles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .layer-legend {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }

        .layer-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .role-card {
            position: relative;
            border: 3px solid;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        /* ä¸‰å±‚é¢œè‰²æ ·å¼ */
        .role-card.layer-core {
            border-color: #007BFF;
        }

        .role-card.layer-external {
            border-color: #FF4500;
        }

        .role-card.layer-value {
            border-color: #28A745;
        }

        .role-card.layer-system {
            border-color: #FFD700;
        }

        /* å¿…é€‰è§’è‰²é‡‘è¾¹é«˜äº® */
        .role-card.required {
            border-width: 4px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .role-card.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .role-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .role-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .role-name {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 8px;
            color: #333;
        }

        .role-desc {
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }

        .role-badges {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
        }

        .role-badge.required {
            background: #FFD700;
            color: #333;
        }

        .role-badge.layer-core {
            background: #007BFF;
        }

        .role-badge.layer-external {
            background: #FF4500;
        }

        .role-badge.layer-value {
            background: #28A745;
        }

        .role-badge.facilitator {
            background: #FFD700;
            color: #333;
        }

        .rounds-selector {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .round-btn {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 500;
        }

        .round-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .round-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .action-btn {
            padding: 16px 48px;
            font-size: 1.2em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .info-text {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            color: #1976d2;
            font-size: 0.95em;
        }

        .nav-links {
            text-align: center;
            margin-top: 30px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-size: 1.1em;
            transition: opacity 0.3s;
        }

        .nav-links a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* è¾©è®ºåŒºåŸŸæ ·å¼ */
        #debateArea {
            display: none;
        }

        .phase-indicator {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .phase-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .phase-step::after {
            content: 'â†’';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ccc;
            font-size: 1.5em;
        }

        .phase-step:last-child::after {
            display: none;
        }

        .phase-step.active {
            color: #667eea;
            font-weight: bold;
        }

        .phase-step.completed {
            color: #28A745;
        }

        .debate-round {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .round-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .speech-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid;
            transition: all 0.3s;
        }

        .speech-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* è§’è‰²å‘è¨€é¢œè‰²ç¼–ç  */
        .speech-item.layer-core {
            border-left-color: #007BFF;
        }

        .speech-item.layer-external {
            border-left-color: #FF4500;
        }

        .speech-item.layer-value {
            border-left-color: #28A745;
        }

        .speech-item.layer-system {
            border-left-color: #FFD700;
        }

        .speech-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speech-role-icon {
            font-size: 1.3em;
        }

        .speech-content {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .delegate-prompt {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .delegate-prompt textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            margin-top: 10px;
        }

        .delegate-prompt button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #ffc107;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .delegate-prompt button:hover {
            background: #ffb300;
        }

        .report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .report-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .report-section h3 {
            color: #333;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .report-section ul {
            list-style-position: inside;
            line-height: 1.8;
            color: #555;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 30px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 25px;
            }

            .roles-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }

            .rounds-selector {
                flex-direction: column;
            }

            .round-btn {
                width: 100%;
            }

            .export-buttons {
                flex-direction: column;
            }

            .export-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å¤šé­”æ±°é£æš´è¾©è®ºç³»ç»Ÿ <span class="version-tag">v3.0</span></h1>
            <div class="slogan">"åå…­ä¸ªè§’è‰²ï¼Œä¸€ä¸ªçœŸç›¸" - AIä¸“å®¶çº§å¤´è„‘é£æš´</div>
            <div id="userStatus" style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                <!-- ç”¨æˆ·çŠ¶æ€å°†é€šè¿‡JSåŠ¨æ€æ›´æ–° -->
            </div>
        </div>

        <!-- é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ (Preparation) -->
        <div id="setupArea" class="card">
            <div class="input-group">
                <label>ğŸ“ è¾“å…¥ä½ çš„é—®é¢˜æˆ–å†³ç­–å›°å¢ƒï¼š</label>
                <textarea id="topicInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘åº”è¯¥ä»èŒåœºè½¬å‹åšè‡ªåª’ä½“å—ï¼Ÿå½“å‰45å²ï¼Œæœ‰10å¹´è¡Œä¸šç»éªŒï¼Œä½†å¯¹å†…å®¹åˆ›ä½œä¸ç¡®å®š..."></textarea>
            </div>

            <div class="input-group">
                <label>ğŸ“š èƒŒæ™¯ä¿¡æ¯ï¼ˆé€‰å¡«ï¼Œå¸®åŠ©AIæ›´å¥½ç†è§£ï¼‰ï¼š</label>
                <textarea id="backgroundInput" placeholder="ä¾‹å¦‚ï¼šç›®æ ‡ç”¨æˆ·ã€å½“å‰èµ„æºã€ä¸»è¦é¡¾è™‘ã€æ—¶é—´/é¢„ç®—é™åˆ¶ç­‰..." style="min-height: 80px;"></textarea>
            </div>

            <div class="roles-section">
                <div class="roles-header">
                    <label>ğŸ‘¥ é€‰æ‹©è¾©è®ºè§’è‰²ï¼ˆå¿…é€‰8ä¸ª + å¯é€‰è§’è‰²ï¼‰ï¼š</label>
                    <div class="layer-legend">
                        <div class="layer-legend-item">
                            <div class="layer-legend-color" style="background: #007BFF;"></div>
                            <span>æ ¸å¿ƒå±‚</span>
                        </div>
                        <div class="layer-legend-item">
                            <div class="layer-legend-color" style="background: #FF4500;"></div>
                            <span>å¤–éƒ¨å±‚</span>
                        </div>
                        <div class="layer-legend-item">
                            <div class="layer-legend-color" style="background: #28A745;"></div>
                            <span>ä»·å€¼å±‚</span>
                        </div>
                    </div>
                </div>
                <div class="info-text">
                    ğŸ’¡ æç¤ºï¼šé‡‘è¾¹ä¸ºå¿…é€‰8è§’è‰²ï¼ˆå·²é»˜è®¤é€‰ä¸­ï¼‰ï¼Œå‘è¨€æŒ‰æµçº¿é¡ºåºï¼šç¬¬ä¸€æ€§â†’ç©¿è¶Šè€…â†’ä¸Šå¸â†’æ ç²¾â†’ç”¨æˆ·â†’ç«å“â†’æ‰§è¡Œâ†’é¢†è¢–
                </div>
                <div class="roles-grid" id="rolesGrid">
                    <!-- è§’è‰²å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="info-text" id="roleCount" style="margin-top: 15px;">
                    å·²é€‰æ‹© <strong>0</strong> ä¸ªè§’è‰²
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ”„ è¾©è®ºè½®æ¬¡ï¼š</label>
                <div class="rounds-selector">
                    <button class="round-btn" data-rounds="3">3è½®ï¼ˆå¿«é€Ÿï¼‰</button>
                    <button class="round-btn active" data-rounds="5">5è½®ï¼ˆå¹³è¡¡ï¼‰</button>
                    <button class="round-btn" data-rounds="8">8è½®ï¼ˆæ·±å…¥ï¼‰</button>
                    <button class="round-btn" data-rounds="10">10è½®ï¼ˆå…¨é¢ï¼‰</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="action-btn" id="startDebateBtn">ğŸš€ å¯åŠ¨å¤šé­”æ±°è¾©è®º</button>
            </div>
        </div>

        <!-- é˜¶æ®µ2-5ï¼šç­–åˆ’/ç¡®è®¤/è¾©è®º/äº¤ä»˜ -->
        <div id="debateArea"></div>

        <div class="nav-links">
            <a href="../index.html">â† è¿”å›é¦–é¡µ</a>
            <a href="../baiwen.html">ç™¾é—®è‡ªæµ‹</a>
            <a href="../Projects.html">é¡¹ç›®å±•ç¤º</a>
        </div>
    </div>

    <script src="src/config/roles.js"></script>
    <script src="src/modules/userAuth.js"></script>
    <script src="src/modules/debateEngine.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            selectedRoles: [],
            rounds: 5,
            topic: '',
            background: '',
            debateEngine: null,
            user: null
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateUserStatus();
            renderRoles();
            setupEventListeners();
        });

        // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
        function updateUserStatus() {
            const userStatus = document.getElementById('userStatus');

            if (window.UserAuth && window.UserAuth.isLoggedIn()) {
                state.user = window.UserAuth.currentUser;
                userStatus.innerHTML = `
                    <span>ğŸ‘¤ ${state.user.nickname}</span>
                    ${state.user.isTestMode ? '<span style="background: #f39c12; padding: 2px 8px; border-radius: 5px; margin-left: 10px; font-size: 0.85em;">æµ‹è¯•æ¨¡å¼</span>' : ''}
                    <button onclick="showDebateHistory()" style="margin-left: 15px; padding: 5px 15px; background: rgba(255,255,255,0.2); border: 1px solid white; border-radius: 5px; color: white; cursor: pointer;">
                        ğŸ“œ å†å²è®°å½•
                    </button>
                    <button onclick="logout()" style="margin-left: 10px; padding: 5px 15px; background: rgba(255,255,255,0.2); border: 1px solid white; border-radius: 5px; color: white; cursor: pointer;">
                        é€€å‡º
                    </button>
                `;
            } else {
                userStatus.innerHTML = `
                    <button onclick="promptLogin()" style="padding: 8px 20px; background: rgba(255,255,255,0.9); border: none; border-radius: 8px; color: #667eea; cursor: pointer; font-weight: bold;">
                        ğŸ”‘ ç™»å½•/æ³¨å†Œ
                    </button>
                    <span style="margin-left: 10px; font-size: 0.85em;">ç™»å½•åå¯ä¿å­˜è¾©è®ºè¿›åº¦</span>
                `;
            }
        }

        // æç¤ºç™»å½•
        function promptLogin() {
            if (window.UserAuth) {
                window.UserAuth.showLoginModal({
                    title: 'æ¬¢è¿æ¥åˆ°å¤šé­”æ±°',
                    message: 'ç™»å½•åå¯ä¿å­˜è¾©è®ºè¿›åº¦å’Œå†å²è®°å½•ï¼Œéšæ—¶ç»§ç»­æœªå®Œæˆçš„è¾©è®º',
                    onSuccess: (user) => {
                        updateUserStatus();
                        alert(`æ¬¢è¿å›æ¥ï¼Œ${user.nickname}ï¼`);
                    }
                });
            } else {
                alert('ç”¨æˆ·è®¤è¯æ¨¡å—æœªåŠ è½½');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿæœªä¿å­˜çš„è¾©è®ºè¿›åº¦å¯èƒ½ä¸¢å¤±ã€‚')) {
                if (window.UserAuth) {
                    window.UserAuth.logout();
                    updateUserStatus();
                }
            }
        }

        // æ˜¾ç¤ºè¾©è®ºå†å²
        async function showDebateHistory() {
            try {
                if (!window.UserAuth) {
                    alert('ç”¨æˆ·è®¤è¯æ¨¡å—æœªåŠ è½½');
                    return;
                }

                const history = await window.UserAuth.getDebateHistory();

                if (history.length === 0) {
                    alert('æ‚¨è¿˜æ²¡æœ‰è¾©è®ºå†å²è®°å½•');
                    return;
                }

                // TODO: æ˜¾ç¤ºå†å²è®°å½•å¼¹çª—
                console.log('è¾©è®ºå†å²:', history);
                alert(`æ‚¨æœ‰ ${history.length} æ¡è¾©è®ºè®°å½•`);

            } catch (error) {
                alert('è·å–è¾©è®ºå†å²å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ¸²æŸ“è§’è‰²å¡ç‰‡
        function renderRoles() {
            if (typeof DEBATE_ROLES === 'undefined') {
                console.error('è§’è‰²é…ç½®æœªåŠ è½½');
                return;
            }

            const grid = document.getElementById('rolesGrid');
            const layerNames = {
                'core': 'æ ¸å¿ƒå±‚',
                'external': 'å¤–éƒ¨å±‚',
                'value': 'ä»·å€¼å±‚',
                'system': 'ç³»ç»Ÿ'
            };

            grid.innerHTML = DEBATE_ROLES.map(role => {
                const requiredClass = role.required ? 'required' : '';
                const layerClass = `layer-${role.layer}`;
                const badges = [];

                if (role.required) {
                    badges.push('<span class="role-badge required">å¿…é€‰</span>');
                }
                badges.push(`<span class="role-badge ${layerClass}">${layerNames[role.layer]}</span>`);

                return `
                    <div class="role-card ${layerClass} ${requiredClass}" data-role-id="${role.id}">
                        <div class="role-icon">${role.icon}</div>
                        <div class="role-name">${role.shortName}</div>
                        <div class="role-desc">${role.description}</div>
                        <div class="role-badges">${badges.join('')}</div>
                    </div>
                `;
            }).join('');

            // é»˜è®¤é€‰ä¸­å¿…é€‰è§’è‰²
            DEBATE_ROLES.filter(r => r.required).forEach(role => {
                state.selectedRoles.push(role.id);
                const card = document.querySelector(`[data-role-id="${role.id}"]`);
                if (card) card.classList.add('selected');
            });

            updateRoleCount();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // è§’è‰²é€‰æ‹©
            document.getElementById('rolesGrid').addEventListener('click', (e) => {
                const card = e.target.closest('.role-card');
                if (!card) return;

                const roleId = parseInt(card.dataset.roleId);
                const role = DEBATE_ROLES.find(r => r.id === roleId);

                if (!role) return;

                const index = state.selectedRoles.indexOf(roleId);

                if (index > -1) {
                    // å–æ¶ˆé€‰æ‹©ï¼ˆä½†å¿…é€‰è§’è‰²ä¸èƒ½å–æ¶ˆï¼‰
                    if (!role.required) {
                        state.selectedRoles.splice(index, 1);
                        card.classList.remove('selected');
                    } else {
                        alert('å¿…é€‰è§’è‰²ä¸èƒ½å–æ¶ˆé€‰æ‹©');
                    }
                } else {
                    // æ·»åŠ é€‰æ‹©
                    state.selectedRoles.push(roleId);
                    card.classList.add('selected');
                }

                updateRoleCount();
            });

            // è½®æ¬¡é€‰æ‹©
            document.querySelectorAll('.round-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.round-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.rounds = parseInt(btn.dataset.rounds);
                });
            });

            // å¯åŠ¨è¾©è®º
            document.getElementById('startDebateBtn').addEventListener('click', startDebate);
        }

        // æ›´æ–°è§’è‰²è®¡æ•°
        function updateRoleCount() {
            const minRoles = typeof REQUIRED_FLOW !== 'undefined' ? REQUIRED_FLOW.length : 8;
            const countText = state.selectedRoles.length < minRoles
                ? `ï¼ˆæœ€å°‘éœ€è¦${minRoles}ä¸ªå¿…é€‰è§’è‰²ï¼‰`
                : state.selectedRoles.length === minRoles
                    ? 'ï¼ˆå·²æ»¡è¶³æœ€ä½è¦æ±‚ï¼‰'
                    : 'âœ“';

            document.getElementById('roleCount').innerHTML =
                `å·²é€‰æ‹© <strong>${state.selectedRoles.length}</strong> ä¸ªè§’è‰² ${countText}`;

            document.getElementById('startDebateBtn').disabled = state.selectedRoles.length < minRoles;
        }

        // å¯åŠ¨è¾©è®º
        async function startDebate() {
            state.topic = document.getElementById('topicInput').value.trim();
            state.background = document.getElementById('backgroundInput').value.trim();

            if (!state.topic || state.topic.length < 5) {
                alert('è¯·è¾“å…¥è‡³å°‘5ä¸ªå­—çš„é—®é¢˜ï¼');
                return;
            }

            const minRoles = typeof REQUIRED_FLOW !== 'undefined' ? REQUIRED_FLOW.length : 8;
            if (state.selectedRoles.length < minRoles) {
                alert(`è¯·è‡³å°‘é€‰æ‹©${minRoles}ä¸ªè¾©è®ºè§’è‰²ï¼ˆå¿…é€‰è§’è‰²ï¼‰ï¼`);
                return;
            }

            // éšè—è®¾ç½®åŒºåŸŸï¼Œæ˜¾ç¤ºè¾©è®ºåŒºåŸŸ
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('debateArea').style.display = 'block';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('debateArea').innerHTML = `
                <div class="card loading">
                    <div class="spinner"></div>
                    <p><strong>ğŸ§  é¢†è¢–æ­£åœ¨åˆ†æé—®é¢˜ï¼Œåˆ¶å®šè¾©è®ºç­–ç•¥...</strong></p>
                    <p style="margin-top: 10px; opacity: 0.7;">è¿™å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿï¼Œè¯·ç¨å€™</p>
                </div>
            `;

            try {
                // åˆå§‹åŒ–è¾©è®ºå¼•æ“
                if (typeof DebateEngine === 'undefined') {
                    throw new Error('è¾©è®ºå¼•æ“æœªåŠ è½½');
                }

                state.debateEngine = new DebateEngine({
                    apiEndpoint: 'http://localhost:3000/api/ai/debate',
                    maxRounds: state.rounds,
                    minRoles: minRoles
                });

                // ç›‘å¬äº‹ä»¶
                state.debateEngine.on('phaseChange', handlePhaseChange);
                state.debateEngine.on('roleSpeak', handleRoleSpeak);
                state.debateEngine.on('delegatePrompt', handleDelegatePrompt);
                state.debateEngine.on('error', handleError);

                // å¯åŠ¨å‡†å¤‡é˜¶æ®µ
                await state.debateEngine.startPreparation({
                    topic: state.topic,
                    background: state.background,
                    selectedRoles: state.selectedRoles,
                    rounds: state.rounds
                });

            } catch (error) {
                console.error('è¾©è®ºå¯åŠ¨å¤±è´¥:', error);
                alert('æŠ±æ­‰ï¼Œå¯åŠ¨è¾©è®ºæ—¶å‡ºé”™ï¼š' + error.message);
                document.getElementById('setupArea').style.display = 'block';
                document.getElementById('debateArea').style.display = 'none';
            }
        }

        // å¤„ç†é˜¶æ®µå˜åŒ–
        function handlePhaseChange(data) {
            console.log('é˜¶æ®µå˜åŒ–:', data.phase);
            // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
            updatePhaseIndicator(data.phase);
        }

        // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
        function updatePhaseIndicator(currentPhase) {
            const phases = ['preparation', 'planning', 'confirmation', 'debate', 'delivery'];
            const phaseNames = {
                'preparation': 'å‡†å¤‡',
                'planning': 'ç­–åˆ’',
                'confirmation': 'ç¡®è®¤',
                'debate': 'è¾©è®º',
                'delivery': 'äº¤ä»˜'
            };

            const indicator = phases.map(phase => {
                const index = phases.indexOf(phase);
                const currentIndex = phases.indexOf(currentPhase);
                const statusClass = index < currentIndex ? 'completed' : index === currentIndex ? 'active' : '';

                return `<div class="phase-step ${statusClass}">${phaseNames[phase]}</div>`;
            }).join('');

            const debateArea = document.getElementById('debateArea');
            let phaseIndicatorEl = debateArea.querySelector('.phase-indicator');

            if (!phaseIndicatorEl) {
                phaseIndicatorEl = document.createElement('div');
                phaseIndicatorEl.className = 'phase-indicator';
                debateArea.insertBefore(phaseIndicatorEl, debateArea.firstChild);
            }

            phaseIndicatorEl.innerHTML = indicator;
        }

        // å¤„ç†è§’è‰²å‘è¨€
        function handleRoleSpeak(data) {
            const { round, role, content, type } = data;
            const debateArea = document.getElementById('debateArea');

            // æ‰¾åˆ°æˆ–åˆ›å»ºæœ¬è½®å®¹å™¨
            let roundContainer = debateArea.querySelector(`[data-round="${round}"]`);
            if (!roundContainer) {
                roundContainer = document.createElement('div');
                roundContainer.className = 'debate-round';
                roundContainer.dataset.round = round;
                roundContainer.innerHTML = `
                    <div class="round-header">ğŸ¯ ç¬¬ ${round} è½®è¾©è®º</div>
                    <div class="speeches-container"></div>
                `;
                debateArea.appendChild(roundContainer);
            }

            const speechesContainer = roundContainer.querySelector('.speeches-container');
            const layerClass = role.layer ? `layer-${role.layer}` : '';
            const typeLabel = type === 'summary' ? 'ã€æ€»ç»“ã€‘' : '';

            const speechEl = document.createElement('div');
            speechEl.className = `speech-item ${layerClass}`;
            speechEl.innerHTML = `
                <div class="speech-header">
                    <span class="speech-role-icon">${role.icon || 'ğŸ’¬'}</span>
                    <span>${role.shortName || role.name} ${typeLabel}</span>
                </div>
                <div class="speech-content">${content}</div>
            `;

            speechesContainer.appendChild(speechEl);

            // æ»šåŠ¨åˆ°æœ€æ–°å‘è¨€
            speechEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // å¤„ç†å§”æ‰˜äººæç¤º
        function handleDelegatePrompt(data) {
            const { type, message, callback, canSkip } = data;
            const debateArea = document.getElementById('debateArea');

            const promptEl = document.createElement('div');
            promptEl.className = 'delegate-prompt';
            promptEl.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px;">ğŸ’¬ ${message}</div>
                <textarea id="delegateInput" placeholder="è¾“å…¥æ‚¨çš„è¡¥å……æˆ–å»ºè®®...${canSkip ? 'ï¼ˆå¯é€‰ï¼‰' : ''}"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="submitDelegateInput()">æäº¤</button>
                    ${canSkip ? '<button onclick="skipDelegateInput()" style="margin-left: 10px; background: #ccc;">è·³è¿‡</button>' : ''}
                </div>
            `;

            debateArea.appendChild(promptEl);
            promptEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // ä¿å­˜å›è°ƒ
            window.currentDelegateCallback = callback;
        }

        // æäº¤å§”æ‰˜äººè¾“å…¥
        function submitDelegateInput() {
            const input = document.getElementById('delegateInput');
            if (window.currentDelegateCallback) {
                window.currentDelegateCallback(input.value);
                document.querySelector('.delegate-prompt').remove();
                window.currentDelegateCallback = null;
            }
        }

        // è·³è¿‡å§”æ‰˜äººè¾“å…¥
        function skipDelegateInput() {
            if (window.currentDelegateCallback) {
                window.currentDelegateCallback('');
                document.querySelector('.delegate-prompt').remove();
                window.currentDelegateCallback = null;
            }
        }

        // å¤„ç†é”™è¯¯
        function handleError(data) {
            console.error('è¾©è®ºé”™è¯¯:', data);
            alert(`è¾©è®ºè¿‡ç¨‹å‡ºé”™ï¼š${data.error.message}`);
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport(format) {
            if (!state.debateEngine || !state.debateEngine.state.reportData) {
                alert('æŠ¥å‘Šå°šæœªç”Ÿæˆ');
                return;
            }

            if (format === 'json') {
                state.debateEngine.exportReportAsJSON();
            } else if (format === 'pdf') {
                state.debateEngine.exportReportAsPDF();
            }
        }
    </script>
</body>
</html>
