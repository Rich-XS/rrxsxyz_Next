<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šé­”æ±°é£æš´è¾©è®ºç³»ç»Ÿ V57.22 - RRXS.XYZ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å¤šé­”æ±°é£æš´è¾©è®ºç³»ç»Ÿ <span class="version-tag">V57.22</span></h1>
            <div class="slogan">"åå…­ä¸ªè§’è‰²ï¼Œä¸€ä¸ªçœŸç›¸" - AIä¸“å®¶çº§å¤´è„‘é£æš´</div>
            <div id="userStatus" style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                <!-- ç”¨æˆ·çŠ¶æ€å°†é€šè¿‡JSåŠ¨æ€æ›´æ–° -->
            </div>

            <!-- âœ… [#086] v8.2 è¯­éŸ³è¾“å‡ºæ§åˆ¶ -->
            <div id="voiceControls" style="margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 12px; opacity: 0.95;">
                <!-- è¯­éŸ³å¼€å…³æŒ‰é’® -->
                <button id="voiceOutputBtn" onclick="window.VoiceModule.toggleVoiceOutput()" style="width: 42px; height: 42px; background: linear-gradient(135deg, #999 0%, #666 100%); color: white; border: none; border-radius: 50%; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" title="ç‚¹å‡»å¼€å¯è¯­éŸ³æœ—è¯»">
                    ğŸ”‡
                </button>

                <!-- âœ… [FIX P0-02] æµ‹è¯•è¯­éŸ³æŒ‰é’® -->
                <button id="testVoiceBtn" onclick="testVoiceOutput()" style="padding: 6px 12px; background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(0,122,255,0.3); transition: all 0.3s;" title="æµ‹è¯•è¯­éŸ³è¾“å‡ºæ˜¯å¦æ­£å¸¸">
                    ğŸ§ª æµ‹è¯•è¯­éŸ³
                </button>

                <!-- è¯­é€Ÿæ§åˆ¶ï¼ˆé»˜è®¤éšè—ï¼Œå¼€å¯è¯­éŸ³åæ˜¾ç¤ºï¼‰ -->
                <div id="voiceRateControl" style="display: none; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px;">
                    <span style="color: white; font-size: 13px; font-weight: 500; margin-right: 4px;">è¯­éŸ³é€Ÿåº¦è°ƒèŠ‚</span>
                    <button onclick="window.VoiceModule.adjustVoiceRate(-1)" style="width: 28px; height: 28px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s;" title="å‡æ…¢è¯­é€Ÿï¼ˆ-1æ¡£ï¼‰">
                        -
                    </button>
                    <span id="voiceRateDisplay" style="min-width: 40px; text-align: center; color: white; font-size: 13px; font-weight: 500;">1.0x</span>
                    <button onclick="window.VoiceModule.adjustVoiceRate(1)" style="width: 28px; height: 28px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s;" title="åŠ å¿«è¯­é€Ÿï¼ˆ+1æ¡£ï¼‰">
                        +
                    </button>
                </div>

                <!-- âœ… [FIX Issue #1] æ–‡å­—é€Ÿåº¦æ§åˆ¶ -->
                <div id="textRateControl" style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px;">
                    <span style="color: white; font-size: 13px; font-weight: 500; margin-right: 4px;">æ–‡å­—é€Ÿåº¦è°ƒèŠ‚</span>
                    <button onclick="adjustTextRate(-1)" style="width: 28px; height: 28px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s;" title="å‡æ…¢æ–‡å­—é€Ÿåº¦ï¼ˆ-1æ¡£ï¼‰">
                        -
                    </button>
                    <span id="textRateDisplay" style="min-width: 40px; text-align: center; color: white; font-size: 13px; font-weight: 500;">10x</span>
                    <button onclick="adjustTextRate(1)" style="width: 28px; height: 28px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s;" title="åŠ å¿«æ–‡å­—é€Ÿåº¦ï¼ˆ+1æ¡£ï¼‰">
                        +
                    </button>
                </div>
            </div>
        </div>

        <!-- é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ (Preparation) -->
        <div id="setupArea" class="card">
            <div class="input-group">
                <label>ğŸ“ è¾“å…¥ä½ çš„é—®é¢˜æˆ–å†³ç­–å›°å¢ƒï¼š</label>
                <textarea id="topicInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘åº”è¯¥ä»èŒåœºè½¬å‹åšè‡ªåª’ä½“å—ï¼Ÿå½“å‰45å²ï¼Œæœ‰10å¹´è¡Œä¸šç»éªŒï¼Œä½†å¯¹å†…å®¹åˆ›ä½œä¸ç¡®å®š..."></textarea>
            </div>

            <div class="input-group">
                <label>ğŸ“š èƒŒæ™¯ä¿¡æ¯ï¼ˆé€‰å¡«ï¼Œå¸®åŠ©AIæ›´å¥½ç†è§£ï¼‰ï¼š</label>
                <textarea id="backgroundInput" placeholder="ä¾‹å¦‚ï¼šç›®æ ‡ç”¨æˆ·ã€å½“å‰èµ„æºã€ä¸»è¦é¡¾è™‘ã€æ—¶é—´/é¢„ç®—é™åˆ¶ç­‰..." style="min-height: 80px;"></textarea>
            </div>

            <div class="roles-section">
                <div class="roles-header">
                    <label id="rolesLabel">ğŸ‘¥ é€‰æ‹©é£æš´è¾©è®ºè§’è‰²ï¼ˆå¿…é€‰8ä¸ª + å¯é€‰è§’è‰²ï¼‰ï¼š</label>
                    <div class="layer-legend">
                        <div class="layer-legend-item">
                            <!-- âœ… [V57.6] æ–¹æ¡ˆBï¼ˆå½“å‰ï¼‰ï¼šé«˜å¯¹æ¯”åº¦æ–¹æ¡ˆ -->
                            <div class="layer-legend-color" style="background: #007AFF;"></div>
                            <span>æ ¸å¿ƒåˆ†æå±‚</span>
                        </div>
                        <div class="layer-legend-item">
                            <!-- âœ… [V57.6 Plan B] äº®çº¢è‰²ï¼ˆé«˜å¯¹æ¯”åº¦ï¼‰ -->
                            <div class="layer-legend-color" style="background: #FF3B30;"></div>
                            <span>å¤–éƒ¨å¨èƒä¸æœºé‡å±‚</span>
                        </div>
                        <div class="layer-legend-item">
                            <!-- âœ… [V57.6 Plan B] æ›´äº®çš„ç»¿è‰²ï¼ˆé«˜å¯¹æ¯”åº¦ï¼‰ -->
                            <div class="layer-legend-color" style="background: #30D158;"></div>
                            <span>ä»·å€¼ä¸è¡ŒåŠ¨å±‚</span>
                        </div>
                    </div>
                    <!-- æ–¹æ¡ˆAï¼ˆå¤‡é€‰ï¼‰ï¼š
                    Core: #007AFF (ä¿æŒ)
                    External: #FF2D55 (ç²‰çº¢)
                    Value: #34C759 (ç»¿)
                    -->
                    <!-- æ–¹æ¡ˆCï¼ˆå¤‡é€‰ï¼‰ï¼šå…¨æ–°é…è‰²
                    Core: #0A84FF (æ›´äº®çš„è“)
                    External: #FF9500 (æ©™è‰²)
                    Value: #32D74B (äº®ç»¿)
                    -->
                </div>
                <div class="info-text" id="rolesHint">
                    ğŸ’¡ æç¤ºï¼šé‡‘è¾¹ä¸ºå¿…é€‰8è§’è‰²ï¼ˆå·²é»˜è®¤é€‰ä¸­ï¼‰ï¼Œå¯é¢å¤–é€‰æ‹©å…¶ä»–è§’è‰²å‚ä¸é£æš´è¾©è®ºã€‚å‘è¨€æŒ‰æµçº¿é¡ºåºï¼šç¬¬ä¸€æ€§åŸåˆ™â†’æ—¶é—´ç©¿è¶Šâ†’ä¸Šå¸è§†è§’â†’æ ç²¾ä¸“å®¶â†’ä¹°å•å®¢æˆ·â†’ç«äº‰å‹å•†â†’è½åœ°æ‰§è¡Œè€…â†’é¢†è¢–(å§”æ‰˜ä»£ç†)
                </div>
                <div class="roles-grid" id="rolesGrid">
                    <!-- è§’è‰²å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="info-text" id="roleCount" style="margin-top: 15px;">
                    å·²é€‰æ‹© <strong>0</strong> ä¸ªè§’è‰²
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ”„ é£æš´è¾©è®ºè½®æ¬¡ï¼š</label>
                <div class="rounds-selector">
                    <button class="round-btn" data-rounds="3">3è½®ï¼ˆå¿«é€Ÿï¼‰</button>
                    <button class="round-btn active" data-rounds="5">5è½®ï¼ˆå¹³è¡¡ï¼‰</button>
                    <button class="round-btn" data-rounds="8">8è½®ï¼ˆæ·±å…¥ï¼‰</button>
                    <button class="round-btn" data-rounds="10">10è½®ï¼ˆå…¨é¢ï¼‰</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="action-btn" id="startDebateBtn">ğŸš€ å¯åŠ¨å¤šé­”æ±°é£æš´è¾©è®º</button>
            </div>
        </div>

        <!-- é˜¶æ®µ2-5ï¼šç­–åˆ’/ç¡®è®¤/è¾©è®º/äº¤ä»˜ -->
        <div id="debateArea"></div>

        <div class="nav-links">
            <a href="../index.html">â† è¿”å›é¦–é¡µ</a>
            <a href="../baiwen.html">ç™¾é—®è‡ªæµ‹</a>
            <a href="../Projects.html">é¡¹ç›®å±•ç¤º</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="src/modules/userAuth.js"></script>
    <script src="src/modules/userProfile.js"></script>
    <script src="src/config/roles.js"></script>
    <!-- âœ… [FIX P0-01] debateEngine ä¾èµ–æ¨¡å—ï¼ˆå¿…é¡»åœ¨ debateEngine.js ä¹‹å‰å¼•å…¥ï¼‰ -->
    <script src="src/modules/contextDatabase.js"></script>
    <script src="src/modules/aiCaller.js"></script>
    <script src="src/modules/reportGenerator.js"></script>
    <script src="src/modules/promptAgent.js"></script>
    <script src="src/modules/promptTemplates.js"></script>
    <script src="src/modules/summaryEngine.js"></script>
    <script src="src/modules/dataValidator.js"></script>
    <script src="src/modules/delegateHandler.js"></script>
    <script src="src/modules/debateEngine.js"></script>
    <script src="src/modules/textRateController.js"></script>
    <script src="export.js"></script>
    <script src="voice.js"></script>
    <script src="debate-ui.js"></script>
    <script src="init.js"></script>
    <script>
        // âœ… [VERSION CHECK] ç‰ˆæœ¬éªŒè¯æ ‡è®° - 2025-11-04 [V57.22: ä¿®å¤æ–‡å­—é€Ÿåº¦UIå’ŒæŒ‰é’®ç¼–ç é—®é¢˜]
        console.log('%cğŸš€ å¤šé­”æ±°ç³»ç»Ÿ V57.22 å·²åŠ è½½ï¼', 'color: #00ff00; font-size: 20px; font-weight: bold; background: #000; padding: 10px;');
        console.log('%câœ… æ–°ç‰¹æ€§: [V57.22] ä¿®å¤æ–‡å­—é€Ÿåº¦UIå’ŒæŒ‰é’®ç¼–ç é—®é¢˜', 'color: #00ff00; font-size: 16px; font-weight: bold;');
        console.log('%c   - ä¿®å¤1ï¼šæ–‡å­—é€Ÿåº¦åˆå§‹æ˜¾ç¤ºä¸å®é™…ä¸ç¬¦ï¼ˆ5xâ†’10xï¼‰', 'color: #00ffff; font-size: 12px;');
        console.log('%c   - ä¿®å¤2ï¼šæŒ‰é’®ç¬¦å·ç¼–ç é—®é¢˜ï¼ˆUnicodeå‡å·â†’æ ‡å‡†å‡å·ï¼‰', 'color: #00ffff; font-size: 12px;');
        console.log('%c   - ä¿®å¤3ï¼šè¯­éŸ³é€Ÿåº¦æŒ‰é’®åŒæ ·ä¿®æ­£ç¬¦å·ç¼–ç ', 'color: #00ffff; font-size: 12px;');
        console.log('%cğŸ”„ V57.21: ä¿®å¤ä¸“å®¶è¯­éŸ³è¢«åˆ‡æ–­é—®é¢˜', 'color: #ffff00; font-size: 12px;');
        console.log('%cğŸ”„ V57.20: ä¿®å¤å¯¼èˆªæ¡æ˜¾ç¤ºé—®é¢˜ï¼ˆP0é˜»å¡æ€§Bugï¼‰', 'color: #ffff00; font-size: 12px;');
        console.log('%cğŸ”„ V57.19: ä¸“å®¶å¯¹è¯è‡ªç„¶åœé¡¿ä¼˜åŒ–ï¼ˆ300ms â†’ 1500msï¼‰', 'color: #ffff00; font-size: 12px;');
        console.log('%cğŸ”„ V57.18: ä¿®å¤è¡¥å……æäº¤åæŒ‰é’®ä¸æ˜¾ç¤ºçš„é˜»å¡æ€§Bug', 'color: #ffff00; font-size: 12px;');
        console.log('%cğŸ”„ V57.16: ä¿®å¤V57.15çš„"é—ªä¸€ä¸‹å°±æ²¡äº†"é—®é¢˜ï¼ˆé€‰æ‹©æ€§DOMåˆ é™¤ï¼‰', 'color: #ffff00; font-size: 12px;');
        console.log('%cğŸ”„ V57.15: ä¿®å¤è¡¥å……æäº¤Race Conditionï¼ˆæ—¶åºç«æ€ï¼‰', 'color: #ffff00; font-size: 12px;');
        console.log('%cğŸ”„ V57.14: æµå¼å®Œæˆåå‘é€isComplete emit', 'color: #ffff00; font-size: 12px;');
        console.log('å‡çº§æ—¶é—´: 2025-10-28 23:58');
        console.log('å¦‚æœçœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜V57.18ç‰ˆæœ¬æ–‡ä»¶å·²æˆåŠŸåŠ è½½ï¼');


        // å…¨å±€çŠ¶æ€
        const state = {
            selectedRoles: [],
            rounds: 5,
            topic: '',
            background: '',
            debateEngine: null,
            user: null,
            userProfile: null, // âœ… [Task #042] v5 ç”¨æˆ·ç”»åƒå®ä¾‹
            speechCounter: {} // âœ… [v9.2] è¿½è¸ªæ¯è½®çš„ä¸“å®¶å‘è¨€åºå·ï¼ˆæ’é™¤é¢†è¢–çš„å¼€åœº/è½¬åœº/æ€»ç»“ï¼‰
        };

        // åˆå§‹åŒ–ï¼ˆä½¿ç”¨init.jsæ¨¡å—ï¼‰
        let initManager = null; // å…¨å±€å¼•ç”¨ï¼Œä¾›å…¶ä»–å‡½æ•°è°ƒç”¨
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.InitManager) {
                initManager = new InitManager();
                window.initManager = initManager; // âœ… [D-66 FIX #4] æš´éœ²åˆ°å…¨å±€ï¼Œä¾›userAuth.jsè°ƒç”¨
                await initManager.init(state);
                console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼ˆinit.jsæ¨¡å—ï¼‰');
            } else {
                console.error('âŒ init.js æ¨¡å—æœªåŠ è½½');
            }
        });

        // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤ºï¼ˆä»£ç†åˆ°init.jsï¼‰
        function updateUserStatus() {
            if (initManager) {
                initManager.updateUserStatus();
            }
        }

        // æç¤ºç™»å½•
        function promptLogin() {
            if (window.UserAuth) {
                window.UserAuth.showLoginModal({
                    title: 'æ¬¢è¿æ¥åˆ°å¤šé­”æ±°',
                    message: 'ç™»å½•åå¯ä¿å­˜é£æš´è¾©è®ºè¿›åº¦å’Œå†å²è®°å½•ï¼Œéšæ—¶ç»§ç»­æœªå®Œæˆçš„é£æš´è¾©è®º',
                    onSuccess: (user) => {
                        updateUserStatus();
                        alert(`æ¬¢è¿å›æ¥ï¼Œ${user.nickname}ï¼`);
                    }
                });
            } else {
                alert('ç”¨æˆ·è®¤è¯æ¨¡å—æœªåŠ è½½');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿæœªä¿å­˜çš„é£æš´è¾©è®ºè¿›åº¦å¯èƒ½ä¸¢å¤±ã€‚')) {
                if (window.UserAuth) {
                    window.UserAuth.logout();
                    updateUserStatus();
                }
            }
        }

        // æ˜¾ç¤ºé£æš´è¾©è®ºå†å²
        async function showDebateHistory() {
            try {
                if (!window.UserAuth) {
                    alert('ç”¨æˆ·è®¤è¯æ¨¡å—æœªåŠ è½½');
                    return;
                }

                const history = await window.UserAuth.getDebateHistory();

                if (history.length === 0) {
                    alert('æ‚¨è¿˜æ²¡æœ‰é£æš´è¾©è®ºå†å²è®°å½•');
                    return;
                }

                // TODO: æ˜¾ç¤ºå†å²è®°å½•å¼¹çª—
                console.log('é£æš´è¾©è®ºå†å²:', history);
                alert(`æ‚¨æœ‰ ${history.length} æ¡é£æš´è¾©è®ºè®°å½•`);

            } catch (error) {
                alert('è·å–é£æš´è¾©è®ºå†å²å¤±è´¥ï¼š' + error.message);
            }
        }

        // âœ… ä»¥ä¸‹å‡½æ•°å·²è¿ç§»è‡³ init.js æ¨¡å—ï¼š
        // - fillDefaultContentFor5758()
        // - renderRoles()
        // - setupEventListeners()
        // - updateRoleCount()
        // è¯·é€šè¿‡ window.InitManager å®ä¾‹è°ƒç”¨ç›¸å…³åŠŸèƒ½

        // å¯åŠ¨é£æš´è¾©è®º
        async function startDebate() {
            state.topic = document.getElementById('topicInput').value.trim();
            state.background = document.getElementById('backgroundInput').value.trim();

            if (!state.topic || state.topic.length < 5) {
                alert('è¯·è¾“å…¥è‡³å°‘5ä¸ªå­—çš„é—®é¢˜ï¼');
                return;
            }

            // âœ… [D-76 FIX] æ£€æµ‹æ˜¯å¦ä¸ºæµ‹è¯•ç”¨æˆ·ï¼ŒåŠ¨æ€è®¾ç½®æœ€å°è§’è‰²æ•°
            const userPhone = localStorage.getItem('userPhone');
            const isTestUser = userPhone === '13917895758';
            const minRoles = isTestUser ? 2 : 8; // âœ… æµ‹è¯•ç”¨æˆ·ï¼š2ä¸ªï¼Œæ™®é€šç”¨æˆ·ï¼š8ä¸ª

            // âœ… [DEBUG] æ˜¾ç¤ºå®é™…é€‰æ‹©çš„è§’è‰²æ•°é‡
            console.log(`ğŸ¯ [è§’è‰²éªŒè¯] å·²é€‰æ‹© ${state.selectedRoles.length} ä¸ªè§’è‰² (æµ‹è¯•ç”¨æˆ·: ${isTestUser}, æœ€å°è¦æ±‚: ${minRoles}):`, state.selectedRoles);

            // âœ… [D-76 FIX] åªæ£€æŸ¥æœ€å°æ•°é‡ï¼ˆæ— ä¸Šé™é™åˆ¶ï¼‰
            if (state.selectedRoles.length < minRoles) {
                alert(`âš ï¸ è¯·è‡³å°‘é€‰æ‹© ${minRoles} ä¸ªé£æš´è¾©è®ºè§’è‰²ï¼\nå½“å‰åªé€‰æ‹©äº† ${state.selectedRoles.length} ä¸ªã€‚\n\n${isTestUser ? 'ï¼ˆæµ‹è¯•ç”¨æˆ·æœ€å°‘2ä¸ªï¼ŒåŠ é€Ÿæµ‹è¯•ï¼‰' : 'ï¼ˆæœ€å°‘éœ€è¦8ä¸ªæ ¸å¿ƒè§’è‰²ï¼‰'}`);
                return;
            }

            console.log(`âœ… [è§’è‰²éªŒè¯é€šè¿‡] è§’è‰²æ•°é‡ç¬¦åˆè¦æ±‚ï¼š${state.selectedRoles.length} ä¸ª (æœ€å°: ${minRoles}, æ— ä¸Šé™)`);



            // éšè—è®¾ç½®åŒºåŸŸï¼Œæ˜¾ç¤ºé£æš´è¾©è®ºåŒºåŸŸ
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('debateArea').style.display = 'block';

            // âœ… [FIX] ç«‹å³æ˜¾ç¤ºå¯¼èˆªæ¡ï¼ˆè¿›å…¥è¾©è®ºé˜¶æ®µï¼‰
            const navLinks = document.querySelector('.nav-links');
            if (navLinks) {
                navLinks.classList.add('visible');
                navLinks.style.setProperty('display', 'block', 'important');
                console.log('âœ… [FIX] å¯¼èˆªæ¡å·²æ˜¾ç¤ºï¼ˆè¿›å…¥è¾©è®ºé˜¶æ®µï¼‰');
            } else {
                console.error('âŒ [FIX] å¯¼èˆªæ¡å…ƒç´ æœªæ‰¾åˆ°ï¼');
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('debateArea').innerHTML = `
                <div class="card loading">
                    <div class="spinner"></div>
                    <p><strong>ğŸ§  é¢†è¢–(å§”æ‰˜ä»£ç†)æ­£åœ¨åˆ†æé—®é¢˜ï¼Œåˆ¶å®šé£æš´è¾©è®ºç­–ç•¥...</strong></p>
                    <p id="planningProgress" style="margin-top: 10px; opacity: 0.7;">å‡†å¤‡ä¸­...</p>
                </div>
            `;

            try {
                // åˆå§‹åŒ–è¾©è®ºå¼•æ“
                if (typeof DebateEngine === 'undefined') {
                    throw new Error('è¾©è®ºå¼•æ“æœªåŠ è½½');
                }

                state.debateEngine = new DebateEngine({
                    apiEndpoint: 'http://localhost:3001/api/ai/debate',
                    maxRounds: state.rounds,
                    minRoles: minRoles,
                    userPhone: userPhone // âœ… [D-76 FIX] ä¼ å…¥ç”¨æˆ·æ‰‹æœºå·ï¼Œç”¨äºæµ‹è¯•ç”¨æˆ·æ£€æµ‹å’Œå­—æ•°å‡åŠ
                });

                // âœ… [Task #043] é›†æˆç”¨æˆ·ç”»åƒåˆ°è¾©è®ºå¼•æ“
                if (state.userProfile) {
                    state.debateEngine.setUserProfile(state.userProfile);
                    console.log('âœ… [Task #043] ç”¨æˆ·ç”»åƒå·²é›†æˆåˆ°è¾©è®ºå¼•æ“:', state.userProfile.getProfileText());
                }

                // ç›‘å¬äº‹ä»¶
                state.debateEngine.on('phaseChange', handlePhaseChange);
                state.debateEngine.on('roleSpeak', handleRoleSpeak);
                state.debateEngine.on('delegatePrompt', handleDelegatePrompt);
                state.debateEngine.on('roundPause', handleRoundPause);  // âœ… [V57-P1-3] è½®æ¬¡é—´åœé¡¿
                state.debateEngine.on('planningProgress', handlePlanningProgress);  // âœ… [V57.8 æ–¹æ¡ˆA] ç­–åˆ’è¿›åº¦å®æ—¶æ˜¾ç¤ºï¼ˆèŠ‚æµç‰ˆï¼‰
                state.debateEngine.on('error', handleError);
                state.debateEngine.on('tokenUpdate', updateTokenDisplay);  // âœ… [Task #13] Tokenç»Ÿè®¡å®æ—¶æ›´æ–°

                // å¯åŠ¨å‡†å¤‡é˜¶æ®µ
                await state.debateEngine.startPreparation({
                    topic: state.topic,
                    background: state.background,
                    selectedRoles: state.selectedRoles,
                    rounds: state.rounds
                });

            } catch (error) {
                console.error('è¾©è®ºå¯åŠ¨å¤±è´¥:', error);
                alert('æŠ±æ­‰ï¼Œå¯åŠ¨é£æš´è¾©è®ºæ—¶å‡ºé”™ï¼š' + error.message);
                document.getElementById('setupArea').style.display = 'block';
                document.getElementById('debateArea').style.display = 'none';
            }
        }

        // å¤„ç†é˜¶æ®µå˜åŒ–
        function handlePhaseChange(data) {
            console.log('é˜¶æ®µå˜åŒ–:', data.phase);
            // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
            updatePhaseIndicator(data.phase);
        }

        // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
        function updatePhaseIndicator(currentPhase) {
            const phases = ['preparation', 'planning', 'confirmation', 'debate', 'delivery'];
            const phaseNames = {
                'preparation': 'å‡†å¤‡',
                'planning': 'ç­–åˆ’',
                'confirmation': 'ç¡®è®¤',
                'debate': 'è¾©è®º',
                'delivery': 'äº¤ä»˜'
            };

            const indicator = phases.map(phase => {
                const index = phases.indexOf(phase);
                const currentIndex = phases.indexOf(currentPhase);
                const statusClass = index < currentIndex ? 'completed' : index === currentIndex ? 'active' : '';

                return `<div class="phase-step ${statusClass}">${phaseNames[phase]}</div>`;
            }).join('');

            // âœ… [Screenshot Fix] å°† phase indicator æ’å…¥åˆ° header å†…éƒ¨ï¼Œè€Œä¸æ˜¯ debateArea
            const header = document.querySelector('.header');
            let phaseIndicatorEl = document.getElementById('phaseIndicator');

            if (!phaseIndicatorEl) {
                phaseIndicatorEl = document.createElement('div');
                phaseIndicatorEl.id = 'phaseIndicator';
                phaseIndicatorEl.className = 'phase-indicator';
                header.appendChild(phaseIndicatorEl); // æ·»åŠ åˆ°headeråº•éƒ¨
            }

            phaseIndicatorEl.innerHTML = indicator;
        }

        // å¤„ç†è§’è‰²å‘è¨€ - âœ… [Task #013] æ”¯æŒæµå¼å¢é‡æ˜¾ç¤º
        function handleRoleSpeak(data) {
            // âœ… [DEBUG] å‡½æ•°å…¥å£æ—¥å¿— - éªŒè¯handleRoleSpeakæ˜¯å¦è¢«è°ƒç”¨
            console.log('%cğŸ¤ handleRoleSpeakè¢«è°ƒç”¨ï¼', 'color: #ff00ff; font-size: 16px; font-weight: bold;');
            console.log('æ¥æ”¶åˆ°çš„data:', data);

            const { round, role, content, type, phase, topic, speechId, isStreaming, isComplete } = data;

            // âœ… [DEBUG] æ£€æŸ¥è§£æ„åçš„å˜é‡å€¼
            console.log('ğŸ“Š å˜é‡å€¼æ£€æŸ¥:', {
                speechId,
                isStreaming,
                isComplete,
                hasContent: !!content,
                contentLength: content ? content.length : 0
            });

            const debateArea = document.getElementById('debateArea');

            // æ‰¾åˆ°æˆ–åˆ›å»ºæœ¬è½®å®¹å™¨
            let roundContainer = debateArea.querySelector(`[data-round="${round}"]`);
            if (!roundContainer) {
                roundContainer = document.createElement('div');
                roundContainer.className = 'debate-round';
                roundContainer.dataset.round = round;

                // âœ… [FIX V5.3] round=0æ—¶æ˜¾ç¤º"å‡†å¤‡é˜¶æ®µ"è€Œä¸æ˜¯"ç¬¬0è½®"
                const roundTitle = round === 0
                    ? 'âœ¨ é£æš´è¾©è®ºå‡†å¤‡å¼€å§‹äº†....'
                    : `ğŸ¯ ç¬¬ ${round} è½®é£æš´è¾©è®º`;

                roundContainer.innerHTML = `
                    <div class="round-header">${roundTitle}</div>
                    <div class="speeches-container"></div>
                `;
                debateArea.appendChild(roundContainer);
            }

            const speechesContainer = roundContainer.querySelector('.speeches-container');
            const layerClass = role.layer ? `layer-${role.layer}` : '';

            // âœ… [V57.1 FIX Issue#2] æ”¹è¿›ï¼šè¯†åˆ«æ‰€æœ‰summaryç±»å‹ï¼ˆsummary/pre_summary/final_summaryï¼‰å¹¶æ˜¾ç¤ºã€æ€»ç»“ã€‘æ ‡ç­¾
            // âœ… [V57.3 Issue#9] å§”æ‰˜äººè¡¥å……æ˜¾ç¤ºã€é‡è¦è¡¥å……ã€‘æ ‡ç­¾
            let typeLabel = '';
            if (type === 'summary' || type === 'pre_summary' || type === 'final_summary' || type === 'half_summary') {
                typeLabel = 'ã€æ€»ç»“ã€‘';
            } else if (role.id === 'delegate') {
                // æ£€æŸ¥æ˜¯å¦ä¸ºé«˜æƒé‡è¡¥å……ï¼ˆcontentä¸­åŒ…å«[HIGH_PRIORITY]ï¼‰
                const isHighPriority = content && typeof content === 'string' && content.includes('[HIGH_PRIORITY]');
                typeLabel = isHighPriority ? 'ã€é‡è¦è¡¥å……ã€‘' : 'ã€å§”æ‰˜äººè¡¥å……ã€‘';
            }

            // âœ… [Task #013] æµå¼æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒ speechId çš„å…ƒç´ 
            let speechEl = null;
            if (speechId) {
                speechEl = speechesContainer.querySelector(`[data-speech-id="${speechId}"]`);
            }

            // âœ… [DEBUG] æ£€æŸ¥speechElæŸ¥æ‰¾ç»“æœ
            console.log('ğŸ” speechElæŸ¥æ‰¾ç»“æœ:', {
                hasSpeechId: !!speechId,
                foundSpeechEl: !!speechEl,
                speechElTagName: speechEl ? speechEl.tagName : 'null'
            });

            // âœ… [DEBUG] æ£€æŸ¥åˆ†æ”¯æ¡ä»¶
            console.log('ğŸ”€ åˆ†æ”¯æ¡ä»¶æ£€æŸ¥:', {
                'isStreaming && speechEl': isStreaming && speechEl,
                'isComplete && speechEl': isComplete && speechEl
            });

            // âœ… [V57.5 FIX P0] æµå¼ä¼ è¾“æœŸé—´ï¼šç«‹å³æ˜¾ç¤ºç´¯ç§¯å†…å®¹ï¼ˆä¿®å¤8-10ç§’å»¶è¿Ÿé—®é¢˜ï¼‰
            // é—®é¢˜æ ¹å› ï¼šV54ç­–ç•¥åªæ˜¾ç¤º"..."ï¼Œä¸æ˜¾ç¤ºchunkï¼Œå¯¼è‡´åå°æ•°æ®å·²åˆ°ä½†UIä¸æ˜¾ç¤º
            // è§£å†³æ–¹æ¡ˆï¼šç«‹å³æ˜¾ç¤ºç´¯ç§¯å†…å®¹ï¼ŒåŒæ—¶ä¿ç•™æ‰“å­—æœºæŒ‡ç¤ºå™¨ï¼ˆæ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆï¼‰
            if (isStreaming && speechEl) {
                console.log('%cğŸ“¥ [V57.5] æµå¼ä¼ è¾“ä¸­ï¼Œç«‹å³æ˜¾ç¤ºç´¯ç§¯å†…å®¹...', 'color: #00ffff; font-size: 14px;');

                const contentEl = speechEl.querySelector('.speech-content');
                if (contentEl) {
                    // âœ… ç«‹å³æ˜¾ç¤ºç´¯ç§¯å†…å®¹ï¼ˆçº¯æ–‡æœ¬ï¼Œé¿å…HTMLæ ‡ç­¾è¢«é€å­—æ˜¾ç¤ºï¼‰
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const plainText = tempDiv.textContent || tempDiv.innerText || '';

                    contentEl.textContent = plainText;

                    // æ·»åŠ æ‰“å­—æœºæŒ‡ç¤ºå™¨ï¼ˆæ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆï¼‰
                    let typingIndicator = speechEl.querySelector('.typing-indicator');
                    if (!typingIndicator) {
                        typingIndicator = document.createElement('span');
                        typingIndicator.className = 'typing-indicator';
                        typingIndicator.innerHTML = '...';
                        contentEl.appendChild(typingIndicator);
                        console.log(`ğŸ”µ [V57.5] å·²æ·»åŠ æ‰“å­—æœºæŒ‡ç¤ºå™¨`);
                    }

                    console.log(`ğŸ“Š [V57.5] å·²æ˜¾ç¤ºç´¯ç§¯å†…å®¹ï¼Œé•¿åº¦: ${plainText.length}å­—`);
                }

                // æ»šåŠ¨åˆ°å½“å‰å‘è¨€ä½ç½®
                speechEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                return; // âœ… V57.5ç­–ç•¥ï¼šç«‹å³æ˜¾ç¤ºchunkï¼Œç­‰å¾…å®Œæˆåæ ¼å¼åŒ–
            }

            // âœ… [Task #013] å¦‚æœæ˜¯å®ŒæˆçŠ¶æ€ï¼Œæ¸…ç©ºæµå¼å†…å®¹å¹¶æ˜¾ç¤ºæ ¼å¼åŒ–çš„æœ€ç»ˆå†…å®¹
            if (isComplete && speechEl) {
                console.log('%câœ”ï¸ è¿›å…¥isCompleteåˆ†æ”¯ï¼', 'color: #00ff00; font-size: 14px; font-weight: bold;');
                // âœ… [BUG-FIX DOMç«æ€] ç«‹å³æ ‡è®°ä¸ºæœ€ç»ˆç‰ˆæœ¬ï¼Œé˜²æ­¢æ™šåˆ°çš„æµå—ç»§ç»­è¿½åŠ 
                speechEl.dataset.isFinal = 'true';
                console.log(`âœ… [BUG-FIX DOMç«æ€] æ ‡è®°speechElä¸ºæœ€ç»ˆç‰ˆæœ¬ï¼Œé˜²æ­¢æ™šåˆ°æµå—ï¼ŒspeechId=${speechId}`);

                // âœ… [FIX P0-11] ç¡®ä¿ content æ˜¯å­—ç¬¦ä¸²ï¼Œé˜²æ­¢å¯¹è±¡ä¼ é€’å¯¼è‡´çš„ replace é”™è¯¯
                const contentText = typeof content === 'string'
                    ? content
                    : (content?.content || '');

                const formattedContent = formatExpertSpeech(contentText, topic);

                // âœ… [FIX V5.3-FIX4 SYNC] æ›´æ–°æœ€ç»ˆå†…å®¹ - æ–‡å­—ä¸è¯­éŸ³åŒæ­¥
                const contentEl = speechEl.querySelector('.speech-content');
                if (contentEl) {
                    // âœ… [D-70] æ¸…ç©ºä¹‹å‰æµå¼æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ï¼Œç”¨æ ¼å¼åŒ–å†…å®¹æ›¿æ¢
                    // åŸå› ï¼šæµå¼æ˜¾ç¤ºçš„æ˜¯æœªæ ¼å¼åŒ–çš„åŸå§‹æ–‡æœ¬ï¼Œç°åœ¨éœ€è¦ç”¨å®Œæ•´æ ¼å¼åŒ–çš„ç‰ˆæœ¬æ›¿æ¢
                    contentEl.innerHTML = '';  // æ¸…ç©ºä¹‹å‰çš„æµå¼å†…å®¹
                    // âœ… [D-70 ä¼˜åŒ–] æ£€æŸ¥è¯­éŸ³æ˜¯å¦å¼€å¯ï¼Œå†³å®šæ˜¯å¦éœ€è¦å»¶è¿Ÿ
                    const isVoiceEnabled = window.VoiceModule && window.VoiceModule.isVoiceEnabled();
                    // âœ… [D-98 2025-10-29] ä¸“å®¶å¯¹è¯è‡ªç„¶åœé¡¿ï¼š300ms â†’ 1500msï¼ˆ1.5ç§’ï¼‰
                    // è¯´æ˜ï¼šTTSè½¬æ¢æ˜¯å³æ—¶çš„ï¼ˆ<0.1ç§’ï¼‰ï¼Œæ­¤å»¶è¿Ÿä»…ç”¨äºåˆ›é€ ä¸“å®¶é—´çš„è‡ªç„¶å¯¹è¯åœé¡¿æ„Ÿ
                    const syncDelay = isVoiceEnabled ? 1500 : 0; // è¯­éŸ³å¼€å¯æ—¶å»¶è¿Ÿ1.5ç§’æ¨¡æ‹Ÿè‡ªç„¶åœé¡¿ï¼Œå…³é—­æ—¶ç«‹å³æ˜¾ç¤º

                    // âœ… [FIX V5.3-FIX4] é¢†è¢–å’Œä¸“å®¶éƒ½å»¶è¿Ÿåæ˜¾ç¤ºï¼ˆä¸è¯­éŸ³åŒæ­¥ï¼‰
                    const isLeaderContent = role.key === 'facilitator';

                    if (isLeaderContent) {
                        // âœ… [ç”¨æˆ·è¦æ±‚] é¢†è¢–å†…å®¹ï¼šå»¶è¿Ÿåç›´æ¥æ˜¾ç¤ºå…¨éƒ¨ï¼ˆå†…å®¹é•¿ï¼Œä¸ç”¨æ‰“å­—æœºï¼‰
                        const displayPromise = (async () => {
                            // âœ… [D-66] æ ¹æ®è¯­éŸ³çŠ¶æ€å†³å®šå»¶è¿Ÿæ—¶é—´
                            if (syncDelay > 0) {
                                await new Promise(resolve => setTimeout(resolve, syncDelay));
                                console.log('ğŸ“ [åŒæ­¥] é¢†è¢–å†…å®¹å»¶è¿Ÿåæ˜¾ç¤º...');
                            }
                            // ç›´æ¥æ˜¾ç¤ºå…¨éƒ¨ï¼ˆä¸ç”¨æ‰“å­—æœºï¼Œé¿å…ç­‰å¾…å¤ªä¹…ï¼‰
                            contentEl.innerHTML = formattedContent;
                        })();

                        // ä¿å­˜åˆ°å…¨å±€ï¼ˆè™½ç„¶é¢†è¢–ç›´æ¥æ˜¾ç¤ºï¼Œä½†ä¹Ÿè¦ç­‰å¾…å®Œæˆï¼‰
                        window.currentTypingPromise = displayPromise;
                    } else {
                        // âœ… [D-63 Synctxt&voice] ä¸“å®¶å‘è¨€ï¼šå»¶è¿Ÿåå¯åŠ¨æ‰“å­—æœºï¼ˆä¸è¯­éŸ³åŒæ­¥ï¼‰
                        const typingPromise = (async () => {
                            // âœ… [D-66] æ ¹æ®è¯­éŸ³çŠ¶æ€å†³å®šå»¶è¿Ÿæ—¶é—´
                            if (syncDelay > 0) {
                                await new Promise(resolve => setTimeout(resolve, syncDelay));
                                console.log('ğŸ“ [åŒæ­¥] æ–‡å­—æµå»¶è¿Ÿåå¼€å§‹...');
                            }
                            // å¼€å§‹æ‰“å­—æœºæ•ˆæœ
                            return window.TextRateController.displayTextWithTyping(formattedContent, contentEl).catch(err => {
                                console.warn('âš ï¸ æ‰“å­—æœºæ•ˆæœå¤±è´¥ï¼Œé™çº§ä¸ºç›´æ¥æ˜¾ç¤º:', err);
                                contentEl.innerHTML = formattedContent;
                            });
                        })();

                        // ä¿å­˜åˆ°å…¨å±€ï¼Œä¾›waitForVoiceOrDelayä½¿ç”¨
                        window.currentTypingPromise = typingPromise;
                    }
                }

                // âœ… [V55.5 FIX] åœ¨ isComplete åˆ†æ”¯å†…è§¦å‘è¯­éŸ³ï¼ˆä¿®å¤ä¸“å®¶æ— è¯­éŸ³é—®é¢˜ï¼‰
                if (window.VoiceModule && window.VoiceModule.isVoiceEnabled()) {
                    console.log(`âœ… [V55.5] è§¦å‘è¯­éŸ³æœ—è¯»: ${role.shortName || role.name}`);
                    const priority = (role.key === 'facilitator' && type === 'introduction') ? 'high' : 'normal';
                    window.VoiceModule.speakText(contentText, role.shortName || role.name, priority);
                }

                return; // å®Œæˆæ›´æ–°ï¼Œä¸åˆ›å»ºæ–°å…ƒç´ 
            }

            // âœ… [v9.2] è®¡ç®—å‘è¨€åºå·ï¼ˆæ’é™¤é¢†è¢–çš„ç‰¹æ®Šå‘è¨€ï¼‰
            // âœ… [V57-P0-1] æ›´æ–°ä¸ºæ–°çš„speech typesï¼šupward/downward/pre_summary/half_summary
            let speechNumber = '';
            const isLeaderSpecial = role.key === 'facilitator' && (type === 'introduction' || type === 'upward' || type === 'downward' || type === 'transition' || type === 'pre_summary' || type === 'half_summary' || type === 'summary');

            if (!isLeaderSpecial) {
                // åˆå§‹åŒ–å½“å‰è½®æ¬¡çš„è®¡æ•°å™¨
                if (!state.speechCounter[round]) {
                    state.speechCounter[round] = 0;
                }
                // å¢åŠ è®¡æ•°ï¼ˆä»…åœ¨é¦–æ¬¡åˆ›å»ºæ—¶ï¼‰
                if (!speechEl) {
                    state.speechCounter[round]++;
                }
                speechNumber = `${round}.${state.speechCounter[round]}`;
            }

            // âœ… [v9.2] æ ¹æ® phase è®¾ç½®èƒŒæ™¯è‰²ï¼ˆApple é£æ ¼ï¼‰
            // âœ… [V57.3 Issue#9] å§”æ‰˜äººç‰¹æ®Šè§†è§‰æ•ˆæœ
            let backgroundColor = '#FFFFFF'; // é»˜è®¤ç™½è‰²
            let borderLeftColor = ''; // å·¦è¾¹æ¡†é¢œè‰²ï¼ˆå§”æ‰˜äººä¸“ç”¨ï¼‰

            if (role.id === 'delegate') {
                backgroundColor = '#FFF4E6'; // âœ… [V57.6] å§”æ‰˜äººï¼šæ›´é²œè‰³çš„æµ…æ©™èƒŒæ™¯
                borderLeftColor = '8px solid #FFD700'; // âœ… [V57.6] é‡‘è‰²å·¦è¾¹æ¡†åŠ å®½åˆ°8px
            } else if (role.key === 'facilitator') {
                backgroundColor = '#FFFFFF'; // é¢†è¢–ä¿æŒé»˜è®¤
            } else if (phase === 'round_robin') {
                backgroundColor = '#F5F5F7'; // è½®æµå‘è¨€ï¼šæµ…ç°è‰²
            } else if (phase === 'supplementary') {
                backgroundColor = '#FFFBEA'; // è¡¥å……å‘è¨€ï¼šæµ…æ·¡é»„è‰²
            } else if (phase === 'transition') {
                backgroundColor = '#F0F8FF'; // è½¬åœºï¼šæµ…è“è‰²
            }

            // åˆ›å»ºæ–°çš„å‘è¨€å…ƒç´ ï¼ˆé¦–æ¬¡æ˜¾ç¤ºæˆ–éæµå¼æ¨¡å¼ï¼‰
            if (!speechEl) {
                speechEl = document.createElement('div');
                speechEl.className = `speech-item ${layerClass}`;
                speechEl.style.backgroundColor = backgroundColor;
                speechEl.style.position = 'relative';

                // âœ… [V57.6] å§”æ‰˜äººé‡‘è‰²å·¦è¾¹æ¡†+é˜´å½±æ•ˆæœ
                if (borderLeftColor) {
                    speechEl.style.borderLeft = borderLeftColor;
                    speechEl.style.boxShadow = '0 2px 8px rgba(255, 215, 0, 0.3)'; // é‡‘è‰²é˜´å½±
                }

                // âœ… [Task #013] æ·»åŠ  speechId ä»¥ä¾¿æµå¼æ›´æ–°æ—¶æŸ¥æ‰¾
                if (speechId) {
                    speechEl.dataset.speechId = speechId;
                }

                // âœ… [T-304] æ•°æ®æ ¡éªŒï¼ˆä»…å¯¹ä¸“å®¶å‘è¨€è¿›è¡Œæ ¡éªŒï¼Œè·³è¿‡é¢†è¢–å’Œå§”æ‰˜äººï¼‰
                let validationBadges = '';
                if (state.debateEngine && state.debateEngine.dataValidator && role.key !== 'facilitator' && role.id !== 'delegate') {
                    try {
                        const validation = state.debateEngine.dataValidator.validate({ content: content });
                        if (validation && (validation.validated.length > 0 || validation.needsVerification.length > 0 || validation.warnings.length > 0)) {
                            validationBadges = state.debateEngine.dataValidator.generateBadges(validation);
                            console.log(`âœ… [T-304] ${role.shortName} å‘è¨€æ•°æ®æ ¡éªŒå®Œæˆ - è¯„åˆ†: ${validation.score}/100`);
                        }
                    } catch (validationError) {
                        console.warn('âš ï¸ [T-304] æ•°æ®æ ¡éªŒå¤±è´¥:', validationError);
                    }
                }

                // âœ… [D-66 ä¿®å¤é¡¿æŒ«] é¦–æ¬¡åˆ›å»ºæ—¶ä¸æ˜¾ç¤ºå†…å®¹ï¼ˆé¿å…æµå¼æ˜¾ç¤ºæ—¶å‡ºç°éƒ¨åˆ†å†…å®¹ï¼‰
                const initialContent = isStreaming
                    ? '<span class="typing-indicator" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #007AFF; margin-left: 8px; animation: pulse 1.5s infinite;"></span>'
                    : formatExpertSpeech(content, topic);

                speechEl.innerHTML = `
                    <div class="speech-header">
                        <span class="speech-role-icon">${role.icon || 'ğŸ’¬'}</span>
                        <span>${role.shortName || role.name}${role.nickname ? ` (${role.nickname.replace(/[ï¼ˆ(].*?[ï¼‰)]/, '')})` : ''} ${typeLabel}</span>
                    </div>
                    <div class="speech-content">${initialContent}</div>
                    ${validationBadges ? `<div class="data-validation-badges" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">${validationBadges}</div>` : ''}
                    ${speechNumber ? `<div class="speech-number" style="position: absolute; top: 10px; right: 15px; font-size: 12px; color: #999; font-family: -apple-system, monospace; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 8px;">${speechNumber}</div>` : ''}
                `;

                speechesContainer.appendChild(speechEl);
            }

            // âœ… [Task #128] é¢†è¢–å¼€åœºå‘è¨€æ—¶æ˜¾ç¤ºå¯¼èˆªæ¡
            if (role.key === 'facilitator' && type === 'introduction') {
                const navLinks = document.querySelector('.nav-links');
                if (navLinks) {
                    navLinks.classList.add('visible');  // ä½¿ç”¨CSSç±»è€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹æ ·å¼
                    navLinks.style.display = 'block';   // åŒé‡ä¿è¯
                    console.log('âœ… [Task #128] å¯¼èˆªæ¡å·²æ˜¾ç¤ºï¼ˆé¢†è¢–å¼€åœºå‘è¨€ï¼‰');

                    // éªŒè¯å¯¼èˆªæ¡æ˜¯å¦çœŸçš„æ˜¾ç¤ºäº†
                    setTimeout(() => {
                        const computedStyle = window.getComputedStyle(navLinks);
                        if (computedStyle.display === 'none') {
                            console.error('âŒ å¯¼èˆªæ¡è®¾ç½®åä»ç„¶éšè—ï¼å°è¯•å¼ºåˆ¶æ˜¾ç¤º...');
                            navLinks.style.setProperty('display', 'block', 'important');
                        } else {
                            console.log('âœ… å¯¼èˆªæ¡æ˜¾ç¤ºéªŒè¯é€šè¿‡');
                        }
                    }, 100);
                }
            }

            // æ»šåŠ¨åˆ°æœ€æ–°å‘è¨€
            speechEl.scrollIntoView({ behavior: 'smooth', block: 'end' });

            // âœ… [#086] v8.2 è¯­éŸ³è¾“å‡ºé›†æˆï¼šä»…åœ¨å‘è¨€å®Œæˆæ—¶æœ—è¯»ï¼ˆé¿å…æµå¼æ›´æ–°æ—¶é‡å¤æœ—è¯»ï¼‰
            // âœ… [FIX P0-02] å¢å¼ºæ—¥å¿—ï¼šè¿½è¸ª isComplete æ ‡å¿—
            console.log(`ğŸ”Š [FIX P0-02] handleRoleSpeak è¯­éŸ³è°ƒç”¨æ£€æŸ¥`, {
                isComplete,
                hasVoiceModule: !!window.VoiceModule,
                isVoiceEnabled: window.VoiceModule ? window.VoiceModule.isVoiceEnabled() : false,
                roleName: role.shortName || role.name,
                contentLength: content ? content.length : 0,
                contentPreview: content ? content.substring(0, 50) : ''
            });

            if (isComplete && window.VoiceModule && window.VoiceModule.isVoiceEnabled()) {
                console.log(`âœ… [FIX P0-02] æ¡ä»¶æ»¡è¶³ï¼Œè°ƒç”¨ speakText()`);

                // âœ… [FIX P0-08] é¢†è¢–å¼€åœºå‘è¨€ï¼ˆtype === 'introduction'ï¼‰ä½¿ç”¨é«˜ä¼˜å…ˆçº§ï¼Œæ‰“æ–­ç­–åˆ’é¡µè¯­éŸ³
                const priority = (role.key === 'facilitator' && type === 'introduction') ? 'high' : 'normal';
                window.VoiceModule.speakText(content, role.shortName || role.name, priority);
            } else {
                console.warn(`âš ï¸ [FIX P0-02] æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡è¯­éŸ³`, {
                    isComplete,
                    hasVoiceModule: !!window.VoiceModule,
                    isVoiceEnabled: window.VoiceModule ? window.VoiceModule.isVoiceEnabled() : false
                });
            }
        }

        // å¤„ç†å§”æ‰˜äººæç¤º
        function handleDelegatePrompt(data) {
            const { type, message, strategy, callback, canSkip = true, round, totalRounds, isLastRound = false } = data;
            const debateArea = document.getElementById('debateArea');

            // âœ… [FIX BUG-009] éªŒè¯å›è°ƒå‡½æ•°æ˜¯å¦å­˜åœ¨ï¼ˆæŸäº›ç±»å‹å¦‚'thanks'ä¸éœ€è¦callbackï¼‰
            const noCallbackTypes = ['thanks', 'feedback']; // åªå±•ç¤ºä¸å“åº”çš„ç±»å‹
            if (!noCallbackTypes.includes(type) && (!callback || typeof callback !== 'function')) {
                console.error('âŒ [BUG-009] handleDelegatePrompt æ¥æ”¶åˆ°æ— æ•ˆçš„ callbackï¼', {
                    type,
                    message,
                    callbackType: typeof callback,
                    callbackValue: callback
                });
                alert('ç³»ç»Ÿé”™è¯¯ï¼šå›è°ƒå‡½æ•°æ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            console.log('âœ… [BUG-009] handleDelegatePrompt æ¥æ”¶åˆ°æœ‰æ•ˆçš„ callback', {
                type,
                callbackType: typeof callback,
                message: message.substring(0, 50) + '...'
            });

            // æ¸…é™¤åŠ è½½çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const loadingEl = debateArea.querySelector('.loading');
            if (loadingEl) {
                loadingEl.remove();
            }

            const promptEl = document.createElement('div');
            promptEl.className = 'delegate-prompt';

            // âœ… [Task #129] æ„å»º HTML - ä½¿ç”¨åˆ†å±‚ç»“æ„ï¼šå¯æ»šåŠ¨å†…å®¹ + å›ºå®šåº•éƒ¨æŒ‰é’®
            // ç¬¬ä¸€å±‚ï¼šæ¶ˆæ¯æ ‡é¢˜ï¼ˆå›ºå®šï¼‰
            let htmlContent = `<div style="font-weight: bold; margin-bottom: 10px;">ğŸ’¬ ${message}</div>`;

            // ç¬¬äºŒå±‚ï¼šå¯æ»šåŠ¨å†…å®¹å®¹å™¨ï¼ˆåŒ…å«ç­–ç•¥ã€æŠ¥å‘Šã€è¾“å…¥æ¡†ï¼‰
            htmlContent += `<div style="max-height: calc(80vh - 150px); overflow-y: auto; margin-bottom: 15px; padding-right: 8px;">`;

            // å¦‚æœæœ‰ç­–åˆ’å†…å®¹ï¼Œå…ˆæ˜¾ç¤ºç­–åˆ’å†…å®¹
            if (strategy) {
                // æå–ç­–ç•¥å†…å®¹ï¼ˆå¯èƒ½æ˜¯å¯¹è±¡æˆ–å­—ç¬¦ä¸²ï¼‰
                const strategyText = typeof strategy === 'object' ? (strategy.content || JSON.stringify(strategy)) : strategy;

                // ç®€å•çš„ Markdown è½¬ HTMLï¼ˆè‹¹æœé£æ ¼ï¼‰
                const strategyHTML = markdownToHTML(strategyText);

                htmlContent += `
                    <div style="background: #FFFAF0; padding: 20px; border-radius: 16px; margin-bottom: 15px; border-left: 4px solid #007AFF; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <h4 style="margin: 0 0 15px 0; color: #007AFF; font-family: -apple-system, SF Pro Display, sans-serif; font-size: 18px; font-weight: 600;">ğŸ“‹ é¢†è¢–(å§”æ‰˜ä»£ç†)çš„é£æš´è¾©è®ºç­–ç•¥</h4>
                        <div style="line-height: 1.8; color: #333; font-family: -apple-system, SF Pro Text, sans-serif;">${strategyHTML}</div>
                    </div>
                `;
            }

            // âœ… [Task #109] å¦‚æœæœ‰æŠ¥å‘Šå†…å®¹ï¼ˆthanks ç±»å‹ï¼‰ï¼Œæ˜¾ç¤ºå®Œæ•´æŠ¥å‘Šï¼ˆæ”¯æŒ PDF å¯¼å‡ºï¼‰
            if (data.report) {
                // æ„å»ºå®Œæ•´æŠ¥å‘Šå†…å®¹
                let reportContent = `
                    <div style="line-height: 1.8; color: #333; font-family: -apple-system, SF Pro Text, sans-serif;">
                        <h3 style="color: #667eea; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">æ€»ç»“</h3>
                        <p>${data.report.summary || 'æŠ¥å‘Šç”Ÿæˆä¸­...'}</p>
                `;

                // æ·»åŠ æ ¸å¿ƒæ´å¯Ÿï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (data.report.keyInsights && data.report.keyInsights.length > 0) {
                    reportContent += `
                        <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">æ ¸å¿ƒæ´å¯Ÿ</h3>
                        <ul style="list-style-position: inside; line-height: 1.8; color: #555;">
                            ${data.report.keyInsights.map(insight => `<li>${insight}</li>`).join('')}
                        </ul>
                    `;
                }

                // æ·»åŠ è¡ŒåŠ¨è®¡åˆ’ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (data.report.actionPlan && data.report.actionPlan.length > 0) {
                    reportContent += `
                        <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">è¡ŒåŠ¨è®¡åˆ’</h3>
                        <ul style="list-style-position: inside; line-height: 1.8; color: #555;">
                            ${data.report.actionPlan.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    `;
                }

                // æ·»åŠ è¿­ä»£å»ºè®®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (data.report.iterationSuggestions && data.report.iterationSuggestions.length > 0) {
                    reportContent += `
                        <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">è¿­ä»£å»ºè®®</h3>
                        <ul style="list-style-position: inside; line-height: 1.8; color: #555;">
                            ${data.report.iterationSuggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    `;
                }

                // âœ… [Task #135] æ·»åŠ CTAåç»­æœåŠ¡éƒ¨åˆ†
                reportContent += `
                    <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">ğŸ¯ åç»­æœåŠ¡</h3>
                    <ul style="list-style-position: inside; line-height: 1.8; color: #555;">
                        <li>ğŸ“Š <strong>æ·±åº¦æŠ¥å‘Š</strong>ï¼šåŸºäºæœ¬æ¬¡é£æš´è¾©è®ºç”Ÿæˆè¯¦ç»†çš„æ•°æ®åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«é‡åŒ–æŒ‡æ ‡å’Œè¡ŒåŠ¨å»ºè®®</li>
                        <li>ğŸ“š <strong>å°ç™½æ•™ç¨‹</strong>ï¼šé’ˆå¯¹æ‚¨çš„å…·ä½“åœºæ™¯ï¼Œæä¾›ä»é›¶å¼€å§‹çš„è¯¦ç»†å®æ–½æŒ‡å—</li>
                        <li>ğŸ¯ <strong>è·Ÿè¸ªæœåŠ¡</strong>ï¼šåç»­æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŒç»­è·Ÿè¿›å’Œä¼˜åŒ–å»ºè®®</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 15px; background: #F5F5F7; border-radius: 12px; color: #666; font-size: 14px; line-height: 1.6;">
                        ğŸ’¡ å¦‚éœ€ä»¥ä¸Šæ·±åº¦æœåŠ¡ï¼Œè¯·è”ç³»æˆ‘ä»¬è·å–æ›´å¤šä¿¡æ¯ã€‚æ‰«æä¸‹æ–¹äºŒç»´ç æˆ–ç‚¹å‡»"åç»­è·Ÿè¿›"æŒ‰é’®äº†è§£è¯¦æƒ…ã€‚
                    </p>
                `;

                reportContent += `</div>`;

                htmlContent += `
                    <div class="report-section" style="background: white; padding: 30px; border-radius: 16px; margin: 15px 0; border: 2px solid #34C759; box-shadow: 0 4px 12px rgba(52,199,89,0.15);">
                        <h2 style="margin: 0 0 20px 0; color: #34C759; font-family: -apple-system, SF Pro Display, sans-serif; font-size: 22px; font-weight: 600; text-align: center; border-bottom: 2px solid #34C759; padding-bottom: 15px;">ğŸ“„ é£æš´è¾©è®ºæ€»ç»“æŠ¥å‘Š</h2>
                        ${reportContent}
                    </div>
                `;
            }

            // è¾“å…¥æ¡†å’ŒæŒ‰é’®
            if (type !== 'thanks') {
                // âœ… [T-314] è¾“å…¥æ¡† + è¯­éŸ³æŒ‰é’®ï¼ˆæ”¾åœ¨å¯æ»šåŠ¨å®¹å™¨å†…ï¼‰
                htmlContent += `
                    <div style="position: relative; width: 100%;">
                        <textarea id="delegateInput" placeholder="å¦‚æœ‰è¡¥å……æ„è§ï¼Œè¯·è¾“å…¥...ï¼ˆå¯é€‰ï¼‰" style="width: 100%; min-height: 100px; padding: 12px 60px 12px 12px; border: 1px solid #ddd; border-radius: 12px; font-family: -apple-system, sans-serif; resize: vertical;"></textarea>
                        <button id="voiceInputBtn"
                            onmousedown="window.VoiceModule.startVoiceInput()"
                            onmouseup="window.VoiceModule.stopVoiceInput()"
                            onmouseleave="window.VoiceModule.stopVoiceInput()"
                            ontouchstart="window.VoiceModule.startVoiceInput()"
                            ontouchend="window.VoiceModule.stopVoiceInput()"
                            style="position: absolute; right: 12px; top: 12px; width: 40px; height: 40px; background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 8px rgba(0,122,255,0.3);"
                            title="æŒ‰ä½è¯´è¯ï¼Œæ¾å¼€ç»“æŸ">
                            ğŸ¤
                        </button>
                    </div>
                `;
                // å…³é—­å¯æ»šåŠ¨å†…å®¹å®¹å™¨
                htmlContent += `</div>`;

                // âœ… [Screenshot Fix] ç¬¬ä¸‰å±‚ï¼šå›ºå®šåº•éƒ¨æŒ‰é’®å®¹å™¨ï¼ˆç»Ÿä¸€å®½åº¦å¸ƒå±€ + å¿«æ·é”®æç¤ºå³ä¾§å¯¹é½ï¼‰
                htmlContent += `<div style="position: relative; margin-top: 0;">`;

                // æŒ‰é’®å®¹å™¨ï¼ˆæ ¹æ®æŒ‰é’®æ•°é‡åŠ¨æ€åˆ†é…å®½åº¦ï¼‰
                htmlContent += `<div style="display: flex; width: 100%;">`;

                // âœ… [FIX T-319] æ™ºèƒ½æŒ‰é’®é€»è¾‘ï¼šä¿®å¤ä¸‰æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶
                if (type === 'planning_confirmation') {
                    // âœ… [Task #120] ç­–åˆ’é˜¶æ®µï¼š2ä¸ªæŒ‰é’®ï¼Œå„å 50%
                    htmlContent += `
                        <button onclick="submitDelegateInput()" style="width: 50%; padding: 12px 24px; background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 500; cursor: pointer; transition: transform 0.2s; font-size: 14px;">ğŸ“ æäº¤è¡¥å……å¹¶é‡æ–°è§„åˆ’</button>
                        <button onclick="confirmAndStartDebate()" style="width: 50%; padding: 12px 24px; background: linear-gradient(135deg, #34C759 0%, #2E9E4D 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 500; cursor: pointer; transition: transform 0.2s; font-size: 14px;">âœ… ç¡®è®¤ï¼Œå¼€å§‹é£æš´è¾©è®º</button>
                    `;
                } else if (type === 'before_summary' || type === 'round_opening' || type === 'transition_comment') {
                    // âœ… [FIX T-319] è¾©è®ºé˜¶æ®µï¼ˆåŒ…æ‹¬æ¯è½®å¼€åœºã€ä¸­åœºè½¬åœºã€æ€»ç»“å‰ï¼‰ï¼š3ä¸ªæŒ‰é’®ï¼Œå„å 33.3%
                    const continueText = isLastRound ? 'âœ… ç¡®è®¤å®Œæˆ' : 'âœ… ç¡®è®¤, ç»§ç»­';
                    const continueColor = isLastRound ? 'linear-gradient(135deg, #34C759 0%, #2E9E4D 100%)' : 'linear-gradient(135deg, #007AFF 0%, #0051D5 100%)';
                    const continueFunction = isLastRound ? 'confirmAndDeliver()' : 'confirmContinue()';

                    htmlContent += `
                        <button onclick="pauseDebate()" style="width: 33.3%; padding: 12px 24px; background: linear-gradient(135deg, #FF3B30 0%, #D12A22 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 500; cursor: pointer; transition: transform 0.2s; font-size: 14px;">â¸ï¸ æ‰“æ–­/æš‚åœ</button>
                        <button id="submitCommentBtn" onclick="submitDelegateCommentInDebate()" style="width: 33.3%; padding: 12px 24px; background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 500; cursor: pointer; transition: transform 0.2s; font-size: 14px;">ğŸ“ æäº¤è¡¥å……</button>
                        <button onclick="${continueFunction}" style="width: 33.4%; padding: 12px 24px; background: ${continueColor}; color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 500; cursor: pointer; transition: transform 0.2s; font-size: 14px;">${continueText}</button>
                    `;
                } else {
                    // å…¶ä»–é˜¶æ®µï¼šé»˜è®¤ç¡®è®¤æŒ‰é’®ï¼ˆå•æŒ‰é’®100%å®½åº¦ï¼‰
                    htmlContent += `
                        <button onclick="confirmContinue()" style="width: 100%; padding: 12px 24px; background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 500; cursor: pointer; transition: transform 0.2s; font-size: 14px;">âœ… ç¡®è®¤</button>
                    `;
                }

                htmlContent += `</div>`; // å…³é—­æŒ‰é’®å®¹å™¨

                // âœ… [Screenshot Fix] å¿«æ·é”®æç¤ºæ”¾åœ¨å³ä¾§æŒ‰é’®ä¸‹æ–¹ï¼Œå³åŠè¾¹å±…ä¸­å¯¹é½
                htmlContent += `
                    <div style="position: absolute; bottom: -28px; right: 0; width: 50%; display: flex; justify-content: center; align-items: center;">
                        <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: #999; font-family: -apple-system, sans-serif;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #007AFF;">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                            å¿«æ·é”®ï¼šCtrl + Enter
                        </span>
                    </div>
                `;

                htmlContent += `</div>`; // å…³é—­å¤–å±‚å®¹å™¨ï¼ˆrelative positionedï¼‰

                // æ·»åŠ padding-bottomä¸ºå¿«æ·é”®æç¤ºç•™å‡ºç©ºé—´
                htmlContent += `<div style="height: 30px;"></div>`;
            } else {
                // å…³é—­å¯æ»šåŠ¨å†…å®¹å®¹å™¨
                htmlContent += `</div>`;

                // 'thanks' ç±»å‹ï¼šåªæ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®å’Œå®ŒæˆæŒ‰é’®ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰
                htmlContent += `
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportReport('pdf')" style="border-color: #007AFF; color: #007AFF;">
                            <span style="margin-right: 5px;">ğŸ“„</span> å¯¼å‡º PDF æŠ¥å‘Š
                        </button>
                        <button class="export-btn" onclick="exportReport('json')" style="border-color: #34C759; color: #34C759;">
                            <span style="margin-right: 5px;">ğŸ’¾</span> å¯¼å‡º JSON æ•°æ®
                        </button>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="finishDebateFromPrompt()" style="flex: 1; min-width: 160px; max-width: 220px; padding: 14px 24px; background: linear-gradient(135deg, #34C759 0%, #2E9E4D 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 600; font-size: 16px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(52,199,89,0.3);">
                            âœ… è¡¨ç¤ºæ„Ÿè°¢ï¼Œç»“æŸé£æš´
                        </button>
                        <button onclick="location.reload()" style="flex: 1; min-width: 160px; max-width: 220px; padding: 14px 24px; background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 600; font-size: 16px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,122,255,0.3);">
                            ğŸ”„ å†æ¥ä¸€è½®
                        </button>
                        <button onclick="alert('ğŸ’¡ å¦‚éœ€æ·±åº¦æŠ¥å‘Šã€å°ç™½æ•™ç¨‹æˆ–è·Ÿè¸ªæœåŠ¡ï¼Œè¯·æŸ¥çœ‹æŠ¥å‘Šä¸­çš„ã€ŒğŸ¯ åç»­æœåŠ¡ã€éƒ¨åˆ†æˆ–è”ç³»æˆ‘ä»¬äº†è§£è¯¦æƒ…ã€‚')" style="flex: 1; min-width: 160px; max-width: 220px; padding: 14px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-family: -apple-system, sans-serif; font-weight: 600; font-size: 16px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                            ğŸ¯ åç»­è·Ÿè¿›è½å®æ·±å…¥
                        </button>
                    </div>
                `;
            }

            promptEl.innerHTML = htmlContent;

            debateArea.appendChild(promptEl);
            promptEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // âœ… [UX Enhancement] è¯­éŸ³è¾“å‡ºç­–åˆ’å†…å®¹
            if (strategy && window.VoiceModule && window.VoiceModule.isVoiceEnabled()) {
                const strategyText = typeof strategy === 'object' ? (strategy.content || JSON.stringify(strategy)) : strategy;
                // æ¸…ç†HTMLæ ‡ç­¾å’ŒMarkdownç¬¦å·åæœ—è¯»
                const cleanText = strategyText
                    .replace(/<[^>]+>/g, '')           // ç§»é™¤HTMLæ ‡ç­¾
                    .replace(/\*\*/g, '')               // ç§»é™¤ç²—ä½“ç¬¦å·
                    .replace(/#{1,6}\s+/g, '')          // ç§»é™¤æ ‡é¢˜ç¬¦å·
                    .replace(/^[-*â€¢]\s+/gm, '')         // ç§»é™¤åˆ—è¡¨ç¬¦å·
                    .replace(/\s+/g, ' ')               // åˆå¹¶å¤šä½™ç©ºç™½
                    .trim();

                console.log('ğŸ”Š [Planning Stage] æœ—è¯»ç­–åˆ’å†…å®¹', { length: cleanText.length, preview: cleanText.substring(0, 50) });
                window.VoiceModule.speakText(cleanText, 'é¢†è¢–(å§”æ‰˜ä»£ç†)');
            }

            // âœ… [FIX T-318] å¼ºåŒ–å›è°ƒä¿æŠ¤æœºåˆ¶ï¼šé˜²æ­¢å›è°ƒè¦†ç›–å¯¼è‡´ä¸¢å¤±
            if (callback && typeof callback === 'function') {
                // ä¿å­˜æ—§å›è°ƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰ä»¥é˜²éœ€è¦æ¢å¤
                const previousCallback = window.currentDelegateCallback;

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨callbackï¼ˆå¯èƒ½æ˜¯å‰ä¸€ä¸ªpromptDelegateæœªå®Œæˆï¼‰
                if (previousCallback && typeof previousCallback === 'function') {
                    console.warn('âš ï¸ [FIX T-318] æ£€æµ‹åˆ°å·²å­˜åœ¨å›è°ƒå‡½æ•°ï¼Œä¿å­˜ä¸ºå¤‡ä»½', {
                        previousType: window.currentDelegateCallbackType || 'unknown',
                        currentType: type,
                        timestamp: new Date().toISOString()
                    });

                    // åˆ›å»ºä»£ç†å›è°ƒï¼Œç¡®ä¿ä¸ä¸¢å¤±åŸå›è°ƒ
                    const proxyCallback = function(input) {
                        try {
                            console.log('âœ… [FIX T-318] æ‰§è¡Œä»£ç†å›è°ƒ', { type, input: input?.substring(0, 50) });
                            const result = callback(input);
                            // æ¢å¤ä¹‹å‰çš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                            window.currentDelegateCallback = null;
                            window.currentDelegateCallbackType = null;
                            return result;
                        } catch (error) {
                            console.error('âŒ [FIX T-318] ä»£ç†å›è°ƒæ‰§è¡Œå¤±è´¥:', error);
                            // å°è¯•æ¢å¤ä¹‹å‰çš„å›è°ƒ
                            window.currentDelegateCallback = previousCallback;
                            throw error;
                        }
                    };

                    // ç§»é™¤æ—§çš„delegate-prompt UI
                    const oldPrompts = debateArea.querySelectorAll('.delegate-prompt');
                    if (oldPrompts.length > 0) {
                        console.warn(`âš ï¸ [FIX T-318] ç§»é™¤ ${oldPrompts.length} ä¸ªæ—§çš„ .delegate-prompt å…ƒç´ `);
                        oldPrompts.forEach(oldPrompt => oldPrompt.remove());
                    }

                    // ä½¿ç”¨ä»£ç†å›è°ƒ
                    window.currentDelegateCallback = proxyCallback;
                    window.currentDelegateCallbackType = type;
                } else {
                    // ç›´æ¥ä¿å­˜æ–°çš„callback
                    window.currentDelegateCallback = callback;
                    window.currentDelegateCallbackType = type;
                }

                console.log('âœ… [FIX T-318] å›è°ƒå‡½æ•°å·²æˆåŠŸä¿å­˜', {
                    type,
                    callbackExists: !!window.currentDelegateCallback,
                    callbackType: window.currentDelegateCallbackType,
                    timestamp: new Date().toISOString()
                });
            } else if (noCallbackTypes.includes(type)) {
                // ä¸éœ€è¦å›è°ƒçš„ç±»å‹ï¼Œæ¸…ç©ºæ—§å›è°ƒ
                console.log('âœ… [FIX T-318] æ¸…ç©ºæ—§å›è°ƒï¼ˆå½“å‰ç±»å‹ä¸éœ€è¦å›è°ƒï¼‰', { type });
                window.currentDelegateCallback = null;
                window.currentDelegateCallbackType = null;
            } else {
                console.error('âŒ [FIX T-318] å°è¯•ä¿å­˜æ— æ•ˆçš„å›è°ƒå‡½æ•°ï¼', {
                    type,
                    callbackType: typeof callback
                });
            }
        }

        // Markdown è½¬ HTMLï¼ˆç®€åŒ–ç‰ˆï¼Œè‹¹æœé£æ ¼ï¼‰
        function markdownToHTML(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // ç¬¬ä¸€æ­¥ï¼šå¤„ç†ç²—ä½“ï¼ˆ** â†’ <strong>ï¼Œä¿ç•™åŠ ç²—æ•ˆæœï¼‰
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #007AFF; font-weight: 600;">$1</strong>');

            // âœ… [FIX V5.3-FIX3] ç¬¬äºŒæ­¥ï¼šå…³é”®è¯è‡ªåŠ¨åŠ ç²—ï¼ˆä¸formatExpertSpeechä¸€è‡´ï¼‰
            const keywords = ['å»ºè®®', 'é—®é¢˜', 'é£é™©', 'æœºä¼š', 'æ•°æ®', 'æŒ‘æˆ˜', 'ä¼˜åŠ¿', 'åŠ£åŠ¿', 'å¨èƒ', 'æ–¹æ¡ˆ', 'ç­–ç•¥', 'ç›®æ ‡', 'å…³é”®', 'æ ¸å¿ƒ', 'é‡ç‚¹', 'æ³¨æ„', 'ç»“è®º', 'åˆ†æ', 'è¯„ä¼°', 'ä¼˜åŒ–', 'å®æ–½', 'æ‰§è¡Œ', 'ç»“æœ', 'æ•ˆæœ', 'å¯è¡Œæ€§', 'å¿…è¦æ€§', 'é‡è¦æ€§', 'ç´§è¿«æ€§'];
            keywords.forEach(keyword => {
                const regexWithBoundary = new RegExp(`(?<!>)([^<>]*?)(${keyword})(?=[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿã€\\s<]|$)`, 'g');
                html = html.replace(regexWithBoundary, (match, prefix, kw) => {
                    const openTags = (prefix.match(/<strong[^>]*>/g) || []).length;
                    const closeTags = (prefix.match(/<\/strong>/g) || []).length;
                    if (openTags > closeTags) {
                        return match;  // å·²åœ¨strongæ ‡ç­¾å†…
                    }
                    return `${prefix}<strong style="color: #007AFF; font-weight: 600;">${kw}</strong>`;
                });
            });

            // ç¬¬ä¸‰æ­¥ï¼šç§»é™¤ Markdown æ ‡é¢˜ç¬¦å·ï¼ˆ### ## # ---ï¼‰ï¼Œä¿ç•™æ–‡å­—
            html = html.replace(/^#{1,6}\s+/gm, ''); // ç§»é™¤ # ç¬¦å·
            html = html.replace(/^---+$/gm, ''); // ç§»é™¤åˆ†éš”çº¿

            // âœ… [V57-P1-5] ç¬¬å››æ­¥ï¼šæ”¹è¿›åˆ—è¡¨æ ¼å¼ï¼ˆæ›´å¥½çš„è§†è§‰å±‚æ¬¡ï¼‰
            html = html.replace(/^\s*(\d+)\.\s+(.+)/gm, '<div style="margin: 10px 0 8px 24px; line-height: 1.8; border-left: 3px solid #FF9500; padding-left: 12px;"><span style="display: inline-block; width: 24px; font-weight: 700; color: #FF9500; margin-left: -36px;">$1.</span><span style="color: #333;">$2</span></div>'); // æœ‰åºåˆ—è¡¨
            html = html.replace(/^\s*[-*â€¢]\s+(.+)/gm, '<div style="margin: 8px 0; line-height: 1.8; padding-left: 20px; text-indent: -20px;"><span style="display: inline-block; width: 20px; font-weight: 600; color: #FF9500;">â—</span><span style="margin-left: 8px; color: #333;">$1</span></div>'); // æ— åºåˆ—è¡¨

            // ç¬¬äº”æ­¥ï¼šç§»é™¤ä»£ç ç¬¦å·ï¼ˆ` ï¼‰
            html = html.replace(/`([^`]+)`/g, '$1');

            // âœ… [V57-P1-5] ç¬¬å…­æ­¥ï¼šå¢å¼ºæ®µè½å¤„ç†ï¼ˆé¦–è½®å¼€åœºç»“æ„åŒ–å±•ç¤ºï¼‰
            html = html
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && line !== '---') // ç§»é™¤ç©ºè¡Œå’Œåˆ†éš”çº¿
                .map((para, index) => {
                    if (para.startsWith('<')) return para; // å·²ç»æ˜¯ HTMLï¼ˆå¦‚åˆ—è¡¨é¡¹ï¼‰

                    // æ™ºèƒ½è¯†åˆ«æ ‡é¢˜ï¼ˆé€šå¸¸è¾ƒçŸ­ä¸”åŒ…å«å…³é”®è¯ï¼‰
                    const isTitle = para.length < 50 && (
                        para.includes('è½®') ||
                        para.includes('ï¼š') ||
                        para.includes('æ ¸å¿ƒ') ||
                        para.includes('é˜¶æ®µ') ||
                        para.includes('éƒ¨åˆ†') ||  // V57-P1-5: è¯†åˆ«ç»“æ„åŒ–éƒ¨åˆ†
                        para.includes('ä»»åŠ¡') ||  // V57-P1-5: è¯†åˆ«ä»»åŠ¡æ ‡é¢˜
                        para.includes('è¦æ±‚') ||  // V57-P1-5: è¯†åˆ«è¦æ±‚æ ‡é¢˜
                        /^[1-9]\.\s/.test(para)   // V57-P1-5: åŒ¹é…æœ‰åºåˆ—è¡¨é¡¹æ ‡é¢˜
                    );

                    if (isTitle) {
                        return `<p style="margin: 16px 0 8px 0; line-height: 1.8; font-weight: 700; color: #FF9500; font-size: 1.05em; border-bottom: 2px solid #FF9500; padding-bottom: 4px;">${para}</p>`;
                    }
                    return `<p style="margin: 8px 0; line-height: 1.8; color: #333;">${para}</p>`;
                })
                .join('');

            return html;
        }

        // âœ… [v9] ä¸“å®¶å‘è¨€æ ¼å¼åŒ–ï¼ˆå…³é”®è¯åŠ ç²— + åˆ†é¡¹åˆ—è¡¨åˆ†è¡Œ + ç´§å‡‘æ˜¾ç¤ºï¼‰
        function formatExpertSpeech(content, roundTopic) {
            if (!content) return '';

            let html = content;

            // ç¬¬ä¸€æ­¥ï¼šå…ˆè°ƒç”¨ markdownToHTML å¤„ç†åŸºæœ¬ Markdown æ ¼å¼
            html = markdownToHTML(html);

            // âœ… [V57-P1-5] ç¬¬äºŒæ­¥ï¼šåŒºåˆ†å…³é”®è¯ç­‰çº§ï¼ˆé¦–è½®å¼€åœºå’Œæ™®é€šå‘è¨€æœ‰ä¸åŒæƒé‡ï¼‰
            const isFirstRoundOpening = roundTopic && (roundTopic.includes('ç¬¬1è½®') || roundTopic.includes('å¼€åœº'));

            // æ ¸å¿ƒå…³é”®è¯ï¼ˆæ‰€æœ‰å‘è¨€éƒ½éœ€è¦é«˜äº®ï¼‰
            const coreKeywords = ['å»ºè®®', 'é—®é¢˜', 'é£é™©', 'æœºä¼š', 'æ•°æ®', 'æŒ‘æˆ˜', 'ä¼˜åŠ¿', 'åŠ£åŠ¿', 'å¨èƒ', 'æ–¹æ¡ˆ', 'ç­–ç•¥', 'ç›®æ ‡', 'å…³é”®', 'æ ¸å¿ƒ', 'é‡ç‚¹', 'æ³¨æ„', 'ç»“è®º', 'åˆ†æ', 'è¯„ä¼°', 'ä¼˜åŒ–', 'å®æ–½', 'æ‰§è¡Œ', 'ç»“æœ', 'æ•ˆæœ', 'å¯è¡Œæ€§', 'å¿…è¦æ€§', 'é‡è¦æ€§', 'ç´§è¿«æ€§'];

            // âœ… [V57-P1-5] é¦–è½®å¼€åœºè¡¥å……å…³é”®è¯ï¼ˆæé«˜ç»“æ„åŒ–å†…å®¹çš„å¯è§†åŒ–ï¼‰
            const openingKeywords = isFirstRoundOpening
                ? ['æ„Ÿè°¢', 'é‚€è¯·', 'èƒŒæ™¯', 'é˜µå®¹', 'æµç¨‹', 'æœºåˆ¶', 'ç„¦ç‚¹', 'æœŸæœ›', 'å¯åŠ¨', 'æ¬¢è¿', 'è¯´æ˜', 'æ‰¿è¯º', 'å®Œæ•´', 'é€å½»', 'æ˜ç¡®', 'èšç„¦']
                : [];

            const allKeywords = [...new Set([...coreKeywords, ...openingKeywords])];

            allKeywords.forEach(keyword => {
                // âœ… [T-323] ä½¿ç”¨è´Ÿå‘åé¡¾æ–­è¨€ï¼Œé¿å…åŒ¹é…å·²åœ¨ <strong> æ ‡ç­¾å†…çš„å…³é”®è¯
                // åŒ¹é…æ¡ä»¶ï¼šå…³é”®è¯å‰ä¸æ˜¯ > å­—ç¬¦ï¼ˆé¿å…åŒ¹é…æ ‡ç­¾å†…çš„å…³é”®è¯ï¼‰ï¼Œä¸”åé¢æœ‰ä¸­æ–‡æ ‡ç‚¹ã€ç©ºæ ¼æˆ–æ ‡ç­¾
                const regexWithBoundary = new RegExp(`(?<!>)([^<>]*?)(${keyword})(?=[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿã€\\s<]|$)`, 'g');

                html = html.replace(regexWithBoundary, (match, prefix, kw) => {
                    // æ£€æŸ¥ prefix ä¸­æ˜¯å¦åŒ…å«æœªé—­åˆçš„ <strong> æ ‡ç­¾ï¼ˆé˜²æ­¢åµŒå¥—ï¼‰
                    const openTags = (prefix.match(/<strong[^>]*>/g) || []).length;
                    const closeTags = (prefix.match(/<\/strong>/g) || []).length;

                    if (openTags > closeTags) {
                        // åœ¨æœªé—­åˆçš„ strong æ ‡ç­¾å†…ï¼Œä¸å†åŠ ç²—
                        return match;
                    }

                    // âœ… [V57-P1-5] å¼€åœºå…³é”®è¯ä½¿ç”¨ç•¥å¾®ä¸åŒçš„é¢œè‰²ä»¥åŒºåˆ†
                    const isOpeningKeyword = openingKeywords.includes(kw);
                    const color = isOpeningKeyword ? '#FF9500' : '#007AFF';  // å¼€åœºå…³é”®è¯ç”¨æ©™è‰²çªæ˜¾

                    return `${prefix}<strong style="color: ${color}; font-weight: 700;">${kw}</strong>`;
                });
            });

            // âœ… [Task #132] æœ¬è½®è¯é¢˜çªæ˜¾ - å°†æœ¬è½®ä¸»é¢˜å…³é”®çŸ­è¯­åŠ ç²—
            if (roundTopic) {
                const topicPhrases = roundTopic
                    .split(/[ï¼šã€/]/)  // æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ä¸»é¢˜çŸ­è¯­
                    .map(p => p.trim())
                    .filter(p => p.length > 2);  // è¿‡æ»¤å¤ªçŸ­çš„ç‰‡æ®µ

                topicPhrases.forEach(phrase => {
                    const regex = new RegExp(`(${phrase})`, 'g');
                    html = html.replace(regex, '<strong style="color: #007AFF; font-weight: 700;">$1</strong>');
                });
            }

            // ç¬¬ä¸‰æ­¥ï¼šè¯†åˆ«å¹¶æ ¼å¼åŒ–åˆ†é¡¹åˆ—è¡¨ï¼ˆå‡çº§ç‰ˆï¼Œæ›´æ¸…æ™°çš„åˆ†è¡Œæ˜¾ç¤ºï¼‰
            // å¤„ç† "1. xxx 2. xxx 3. xxx" æ ¼å¼ï¼ˆä»…åŒ¹é…è¡Œé¦–ï¼‰
            html = html.replace(/(^|\n)\s*(\d+)\.\s*([^ã€‚ï¼ï¼Ÿ\n]+)/gm, (match, prefix, num, text) => {
                return `${prefix}<div style="margin: 10px 0 10px 25px; line-height: 1.7; border-left: 3px solid #007AFF; padding-left: 12px;">
<span style="display: inline-block; width: 28px; font-weight: 700; color: #007AFF; font-size: 15px;">${num}.</span>
${text.trim()}
</div>`;
            });

            // å¤„ç† "ï¼ˆ1ï¼‰xxxï¼ˆ2ï¼‰xxx" æ ¼å¼ï¼ˆä»…åŒ¹é…è¡Œé¦–ï¼‰
            html = html.replace(/(^|\n)\s*[ï¼ˆ(](\d+)[ï¼‰)]\s*([^ï¼ˆ(ï¼‰)\n]+)/gm, (match, prefix, num, text) => {
                return `${prefix}<div style="margin: 10px 0 10px 25px; line-height: 1.7; border-left: 3px solid #34C759; padding-left: 12px;">
<span style="display: inline-block; width: 28px; font-weight: 700; color: #34C759; font-size: 15px;">(${num})</span>
${text.trim()}
</div>`;
            });

            // ç¬¬å››æ­¥ï¼šå¤„ç†æ®µè½ï¼ˆReader-Friendly ä¼˜åŒ–ç‰ˆ + âœ… [Task #130] é‡ç‚¹æ®µè½åˆ†è¡Œä¼˜åŒ–ï¼‰
            const lines = html.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0); // ç§»é™¤ç©ºè¡Œ

            // âœ… [Task #130] é‡ç‚¹æ®µè½å…³é”®è¯ï¼ˆç”¨äºè¯†åˆ«éœ€è¦å¢å¼ºåˆ†è¡Œçš„æ®µè½ï¼‰
            const emphasisKeywords = ['å»ºè®®', 'é—®é¢˜', 'æ ¸å¿ƒ', 'é‡ç‚¹', 'å…³é”®', 'ç»“è®º', 'åˆ†æ', 'è¯„ä¼°', 'æ€»ç»“', 'æ–¹æ¡ˆ', 'ç­–ç•¥', 'ç›®æ ‡', 'æ³¨æ„', 'é£é™©', 'æœºä¼š', 'ä¼˜åŠ¿', 'åŠ£åŠ¿'];

            // åˆå¹¶ä¸ºæœ€ç»ˆ HTMLï¼ˆå·²å¤„ç†çš„åˆ—è¡¨é¡¹ä¼šä¿ç•™ divï¼Œå…¶ä»–æ–‡æœ¬åˆå¹¶ä¸ºæ®µè½ï¼‰
            html = lines.map(line => {
                if (line.startsWith('<div')) {
                    return line; // åˆ—è¡¨é¡¹ï¼Œç›´æ¥è¿”å›
                } else {
                    // âœ… [Task #130] æ£€æµ‹æ˜¯å¦ä¸ºé‡ç‚¹æ®µè½ï¼ˆå¼€å¤´åŒ…å«é‡ç‚¹å…³é”®è¯æˆ–å·²åŠ ç²—çš„å…³é”®è¯ï¼‰
                    const isEmphasisParagraph = emphasisKeywords.some(keyword =>
                        line.startsWith(keyword) ||
                        (line.startsWith('<strong') && line.includes(`>${keyword}<`))
                    );

                    // âœ… [Task #130 FIX] é‡ç‚¹æ®µè½å¢åŠ ä¸Šä¸‹è¾¹è·ï¼ˆ24px/16pxï¼‰ï¼Œå½¢æˆæ˜æ˜¾çš„è§†è§‰åˆ†éš”
                    if (isEmphasisParagraph) {
                        return `<p style="margin: 24px 0 16px 0; line-height: 1.7; color: #2C3E50; font-size: 15px; text-align: justify; font-weight: 500;">${line}</p>`;
                    } else {
                        return `<p style="margin: 8px 0 8px 0; line-height: 1.7; color: #2C3E50; font-size: 15px; text-align: justify;">${line}</p>`;
                    }
                }
            }).join('');

            return html;
        }

        // æäº¤å§”æ‰˜äººè¡¥å……æ„è§ï¼ˆç­–åˆ’é˜¶æ®µéœ€è¦é‡æ–°è§„åˆ’ï¼‰
        async function submitDelegateInput() {
            const input = document.getElementById('delegateInput');
            const feedback = input.value.trim();

            if (!feedback) {
                alert('è¯·è¾“å…¥æ‚¨çš„è¡¥å……æ„è§ï¼Œæˆ–ç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ç›´æ¥å¼€å§‹é£æš´è¾©è®º');
                return;
            }

            // ç§»é™¤å½“å‰æç¤ºæ¡†
            document.querySelector('.delegate-prompt')?.remove();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('debateArea').innerHTML += `
                <div class="card loading">
                    <div class="spinner"></div>
                    <p><strong>ğŸ§  é¢†è¢–(å§”æ‰˜ä»£ç†)æ­£åœ¨æ ¹æ®æ‚¨çš„æ„è§é‡æ–°è§„åˆ’ç­–ç•¥...</strong></p>
                    <p id="planningProgress" style="margin-top: 10px; opacity: 0.7;">å‡†å¤‡ä¸­...</p>
                </div>
            `;

            try {
                // è°ƒç”¨ debateEngine é‡æ–°è§„åˆ’
                const adjustedStrategy = await state.debateEngine.adjustStrategy(feedback);

                // âœ… [V57.16 FIX] å»¶è¿Ÿ200msåï¼Œåªç§»é™¤loadingåŠ¨ç”»ï¼Œä¿ç•™å†…å®¹å®¹å™¨
                // V57.15æ ¹å› åˆ†æï¼šå»¶è¿Ÿ200msç¡®ä¿isCompleteäº‹ä»¶å¤„ç†ï¼Œä½†éšååˆ é™¤æ•´ä¸ª.loadingå®¹å™¨å¯¼è‡´æ ¼å¼åŒ–å†…å®¹ä¹Ÿè¢«åˆ é™¤ï¼ˆ"é—ªäº†ä¸€ä¸‹å°±æ²¡äº†"ï¼‰
                // V57.16ä¿®å¤ï¼šä¸åˆ é™¤å®¹å™¨ï¼Œåªç§»é™¤loadingç±»å’Œspinnerï¼Œä¿ç•™planningProgresså…ƒç´ æ˜¾ç¤ºæ ¼å¼åŒ–å†…å®¹
                await new Promise(resolve => setTimeout(resolve, 200));

                // ç§»é™¤loadingçŠ¶æ€ï¼šåªç§»é™¤åŠ¨ç”»ï¼Œä¿ç•™å†…å®¹
                const loadingEl = document.querySelector('.loading');
                if (loadingEl) {
                    loadingEl.classList.remove('loading');  // ç§»é™¤loadingç±»
                    loadingEl.querySelector('.spinner')?.remove();  // åªåˆ é™¤spinneråŠ¨ç”»
                    loadingEl.querySelector('p:not(#planningProgress)')?.remove();  // åˆ é™¤"æ­£åœ¨é‡æ–°è§„åˆ’"æ–‡æœ¬
                    // planningProgresså…ƒç´ ä¿ç•™ï¼Œæ˜¾ç¤ºæ ¼å¼åŒ–å†…å®¹
                }

                // âœ… [V57.18 FIX] å®Œå…¨ç§»é™¤V57.16ä¿ç•™çš„æ—§å®¹å™¨ï¼Œé¿å…å¹²æ‰°æ–°UIæŒ‰é’®æ˜¾ç¤º
                // V57.16ä¿ç•™äº†å®¹å™¨è®©ç”¨æˆ·çœ‹åˆ°æ ¼å¼åŒ–å†…å®¹ï¼Œä½†åœ¨è°ƒç”¨handleDelegatePromptå‰å¿…é¡»åˆ é™¤
                // å¦åˆ™ä¼šå¯¼è‡´æŒ‰é’®ä¸æ˜¾ç¤ºï¼ˆæ—§å®¹å™¨å’Œæ–°promptElå†²çªï¼‰
                if (loadingEl) {
                    loadingEl.remove();
                }

                // å†æ¬¡æ˜¾ç¤ºç­–ç•¥è®©å§”æ‰˜äººç¡®è®¤ï¼ˆä½¿ç”¨ handleDelegatePrompt é€»è¾‘ï¼‰
                handleDelegatePrompt({
                    type: 'planning_confirmation',
                    message: 'é¢†è¢–(å§”æ‰˜ä»£ç†)å·²æ ¹æ®æ‚¨çš„æ„è§è°ƒæ•´ç­–ç•¥ï¼Œè¯·æŸ¥çœ‹ï¼š',
                    strategy: adjustedStrategy,
                    canSkip: false,
                    callback: (finalInput) => {
                        // è¿™æ¬¡å›è°ƒåªæ˜¯ç¡®è®¤ï¼Œè¿›å…¥é£æš´è¾©è®º
                        state.debateEngine.confirmAndStart(finalInput);
                    }
                });

            } catch (error) {
                console.error('é‡æ–°è§„åˆ’å¤±è´¥:', error);
                alert('ç­–ç•¥è°ƒæ•´å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ç¡®è®¤ç­–ç•¥ï¼Œå¼€å§‹é£æš´è¾©è®º
        function confirmAndStartDebate() {
            console.log('ğŸ”µ [BUG-009] confirmAndStartDebate è¢«è°ƒç”¨', {
                hasCallback: !!window.currentDelegateCallback,
                callbackType: typeof window.currentDelegateCallback,
                timestamp: new Date().toISOString()
            });

            // âœ… [FIX BUG-009] å¢å¼ºå›è°ƒéªŒè¯å’Œé”™è¯¯å¤„ç†
            if (window.currentDelegateCallback && typeof window.currentDelegateCallback === 'function') {
                console.log('âœ… [BUG-009] æ­£åœ¨æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä¼ é€’ç©ºå­—ç¬¦ä¸²ï¼ˆè¡¨ç¤ºç›´æ¥ç¡®è®¤ï¼‰');

                try {
                    window.currentDelegateCallback(''); // ä¼ ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºç›´æ¥ç¡®è®¤
                    console.log('âœ… [BUG-009] å›è°ƒå‡½æ•°æ‰§è¡ŒæˆåŠŸ');
                } catch (error) {
                    console.error('âŒ [BUG-009] å›è°ƒå‡½æ•°æ‰§è¡Œå¤±è´¥ï¼š', error);
                    alert('ç³»ç»Ÿé”™è¯¯ï¼šå›è°ƒå‡½æ•°æ‰§è¡Œå¤±è´¥ - ' + error.message);
                    return; // âœ… [FIX BUG #2] æ‰§è¡Œå¤±è´¥æ—¶ä¸ç§»é™¤å¼¹çª—ï¼Œè®©ç”¨æˆ·é‡è¯•æˆ–åˆ·æ–°
                }

                window.currentDelegateCallback = null;
                console.log('âœ… [BUG-009] å›è°ƒå‡½æ•°å·²æ¸…ç©ºï¼ŒUI å·²æ¸…ç†');
            } else {
                console.error('âŒ [BUG-009] currentDelegateCallback æ— æ•ˆï¼', {
                    exists: !!window.currentDelegateCallback,
                    type: typeof window.currentDelegateCallback,
                    value: window.currentDelegateCallback
                });
                alert('ç³»ç»Ÿé”™è¯¯ï¼šå›è°ƒå‡½æ•°ä¸¢å¤±æˆ–æ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•\n\næŠ€æœ¯è¯¦æƒ…ï¼šå›è°ƒç±»å‹ = ' + typeof window.currentDelegateCallback);
                // âœ… [FIX BUG #2] å³ä½¿å›è°ƒä¸¢å¤±ä¹Ÿç§»é™¤å¼¹çª—ï¼Œé¿å…UIå¡æ­»
            }

            // âœ… [FIX BUG #2] ç§»é™¤å¼¹çª—ï¼ˆæˆåŠŸæˆ–å¤±è´¥åéƒ½ç§»é™¤ï¼‰
            document.querySelector('.delegate-prompt')?.remove();
        }

        // ç¡®è®¤ç»§ç»­ä¸‹ä¸€è½®ï¼ˆè¾©è®ºé˜¶æ®µï¼‰
        function confirmContinue() {
            const input = document.getElementById('delegateInput');
            const feedback = input ? input.value.trim() : '';

            if (window.currentDelegateCallback) {
                window.currentDelegateCallback(feedback); // ä¼ é€’ç”¨æˆ·è¾“å…¥ï¼ˆå¯ä»¥ä¸ºç©ºï¼‰
                window.currentDelegateCallback = null;
            } else {
                // âœ… [FIX BUG #2] å›è°ƒä¸¢å¤±æ—¶æ˜¾ç¤ºæ˜ç¡®é”™è¯¯
                console.error('âŒ [BUG #2] currentDelegateCallback ä¸¢å¤±ï¼Œæ— æ³•ç»§ç»­é£æš´è¾©è®º');
                alert('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•ç»§ç»­é£æš´è¾©è®ºæµç¨‹\n\nå›è°ƒå‡½æ•°å·²ä¸¢å¤±ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹');
            }

            // âœ… [FIX BUG #2] æ— è®ºå›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œéƒ½ç§»é™¤å¼¹çª—ï¼ˆé¿å…UIå¡æ­»ï¼‰
            document.querySelector('.delegate-prompt')?.remove();
        }

        function confirmAndDeliver() {
            console.log('ğŸŸ¢ [R15] confirmAndDeliver è¢«è°ƒç”¨ï¼Œå‡†å¤‡ç»“æŸé£æš´è¾©è®º');
            const input = document.getElementById('delegateInput');
            const feedback = input ? input.value.trim() : '';

            if (window.currentDelegateCallback) {
                // ä¼ é€’ç”¨æˆ·è¾“å…¥ï¼Œå¼•æ“åº”è¯†åˆ«åˆ°è¿™æ˜¯æœ€åä¸€è½®çš„ç¡®è®¤
                window.currentDelegateCallback(feedback);

                // è®¾ç½®ç”¨æˆ·ä¸»åŠ¨å®Œæˆæ ‡å¿—
                if (window.state && window.state.debateEngine) {
                    window.state.debateEngine.state.userCompleted = true;
                    console.log('âœ… [R15] è®¾ç½® userCompleted = true');
                }

                window.currentDelegateCallback = null;

                // âœ… [FIX #138] ç§»é™¤æ‰‹åŠ¨è°ƒç”¨ startDelivery() çš„é€»è¾‘
                // æ ¹å› ï¼šLine 1714 çš„ callback è°ƒç”¨å·²ç»è§¦å‘ debateEngine å†…éƒ¨æµç¨‹
                // debateEngine.startDebate() ä¼šåœ¨ for å¾ªç¯ç»“æŸåè‡ªåŠ¨è°ƒç”¨ startDelivery()
                // æ‰‹åŠ¨è°ƒç”¨ä¼šå¯¼è‡´é‡å¤ï¼Œä¸”å¯èƒ½è§¦å‘"è¾©è®ºå¼•æ“ä¸å¯ç”¨"é”™è¯¯
                console.log('âœ… [FIX #138] å·²ç§»é™¤æ‰‹åŠ¨è°ƒç”¨ startDelivery()ï¼Œç”±å¼•æ“è‡ªåŠ¨å®Œæˆäº¤ä»˜æµç¨‹');

            } else {
                console.error('âŒ [R15] confirmAndDeliver: currentDelegateCallback æ— æ•ˆï¼');
                alert('ç³»ç»Ÿé”™è¯¯ï¼šæœ€ç»ˆç¡®è®¤å›è°ƒä¸¢å¤±ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }

            // âœ… [FIX BUG #2] ç§»é™¤å¼¹çª—
            document.querySelector('.delegate-prompt')?.remove();
        }

        // æ‰“æ–­/æš‚åœé£æš´è¾©è®º
        function pauseDebate() {
            const confirmed = confirm('â¸ï¸ ç¡®è®¤æš‚åœé£æš´è¾©è®ºï¼Ÿ\n\næš‚åœåå°†ç»“æŸå½“å‰é£æš´è¾©è®ºï¼Œç”Ÿæˆæˆªæ­¢ç›®å‰çš„æ€»ç»“æŠ¥å‘Šã€‚');

            if (confirmed) {
                if (window.currentDelegateCallback) {
                    window.currentDelegateCallback('[PAUSE]'); // ä¼ é€’ç‰¹æ®Šæ ‡è®°
                    document.querySelector('.delegate-prompt')?.remove();
                    window.currentDelegateCallback = null;
                }

                // é€šçŸ¥å¼•æ“æš‚åœï¼ˆéœ€è¦åœ¨ debateEngine ä¸­å¤„ç† [PAUSE] æ ‡è®°ï¼‰
                if (state.debateEngine) {
                    alert('âœ… é£æš´è¾©è®ºå·²æš‚åœï¼Œæ­£åœ¨ç”Ÿæˆæ€»ç»“æŠ¥å‘Š...');
                    // debateEngine ä¼šåœ¨æ”¶åˆ° [PAUSE] åè·³è½¬åˆ°äº¤ä»˜é˜¶æ®µ
                }
            }
        }

        // âœ… [FIX BUG-012] é£æš´è¾©è®ºé˜¶æ®µæäº¤è¡¥å……æ„è§
        // âœ… [FIX #018] ä»æç¤ºæ¡†ç»“æŸé£æš´è¾©è®ºå¹¶è¿›å…¥äº¤ä»˜é˜¶æ®µï¼ˆç”¨äº thanks ç±»å‹çš„å®ŒæˆæŒ‰é’®ï¼‰
        async function finishDebateFromPrompt() {
            try {
                console.log('ğŸŸ¢ finishDebateFromPrompt: ç‚¹å‡»å®Œæˆé£æš´è¾©è®ºæŒ‰é’®');

                // âœ… [FIX #018] å…ˆæ‰§è¡Œå›è°ƒé€»è¾‘ï¼Œå†ç§»é™¤UIï¼Œç¡®ä¿é€»è¾‘å®Œæ•´æ‰§è¡Œ
                if (window.currentDelegateCallback && typeof window.currentDelegateCallback === 'function') {
                    console.log('ğŸŸ¢ è°ƒç”¨ä¿å­˜çš„ callback è¿›å…¥åé¦ˆæ”¶é›†');
                    await window.currentDelegateCallback();
                    window.currentDelegateCallback = null;
                } else {
                    // å¦‚æœæ²¡æœ‰ callbackï¼Œç›´æ¥è¿›å…¥äº¤ä»˜é˜¶æ®µï¼ˆä¸æ˜¯completedï¼‰
                    console.log('ğŸŸ¢ ç›´æ¥è¿›å…¥äº¤ä»˜é˜¶æ®µ');
                    if (window.state && window.state.debateEngine) {
                        window.state.debateEngine.emit('phaseChange', { phase: 'completed', state: window.state.debateEngine.state });
                    }
                }

                // âœ… [FIX #018] é€»è¾‘æ‰§è¡Œå®Œæ¯•åå†ç§»é™¤UIï¼Œé˜²æ­¢æŒ‰é’®æ¶ˆå¤±ä½†é€»è¾‘æœªå®Œæˆ
                const promptElement = document.querySelector('.delegate-prompt');
                if (promptElement) {
                    promptElement.remove();
                }

                // âœ… [FIX #139] æ˜¾ç¤ºæœ€ç»ˆå®Œæˆé¡µé¢ï¼Œæä¾›åç»­æ“ä½œæŒ‰é’®
                const debateArea = document.getElementById('debateArea');
                const completionCard = document.createElement('div');
                completionCard.className = 'card';
                completionCard.style.marginTop = '30px';
                completionCard.style.textAlign = 'center';
                completionCard.innerHTML = `
                    <h2 style="color: #34C759; font-size: 2em; margin-bottom: 20px;">ğŸ‰ é£æš´è¾©è®ºå·²å®Œæˆ</h2>
                    <p style="font-size: 1.2em; color: #666; margin-bottom: 40px;">æ„Ÿè°¢æ‚¨ä½¿ç”¨å¤šé­”æ±°é£æš´è¾©è®ºç³»ç»Ÿï¼</p>
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="location.href='../index.html'" style="padding: 14px 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; cursor: pointer; transition: transform 0.2s;">ğŸ  è¿”å›é¦–é¡µ</button>
                        <button onclick="location.reload()" style="padding: 14px 32px; background: linear-gradient(135deg, #34C759 0%, #2E9E4D 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; cursor: pointer; transition: transform 0.2s;">ğŸ”„ å†æ¥ä¸€è½®</button>
                        <button onclick="showDebateHistory()" style="padding: 14px 32px; background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; cursor: pointer; transition: transform 0.2s;">ğŸ“œ æŸ¥çœ‹å†å²</button>
                    </div>
                `;
                debateArea.appendChild(completionCard);
                completionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (err) {
                console.error('âŒ finishDebateFromPrompt å‘ç”Ÿé”™è¯¯ï¼š', err);
                alert('ç»“æŸé£æš´è¾©è®ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯');
            }
        }

        function submitDelegateCommentInDebate() {
            console.log('ğŸ“ [BUG-012] submitDelegateCommentInDebate è¢«è°ƒç”¨');

            const input = document.getElementById('delegateInput');
            const feedback = input ? input.value.trim() : '';

            if (!feedback) {
                alert('è¯·è¾“å…¥æ‚¨çš„è¡¥å……æ„è§ï¼Œæˆ–ç›´æ¥ç‚¹å‡»"ç¡®è®¤"æŒ‰é’®ç»§ç»­');
                return;
            }

            console.log('ğŸ“ [BUG-012] å§”æ‰˜äººæäº¤è¡¥å……æ„è§:', feedback.substring(0, 50) + '...');

            // âœ… [UXä¼˜åŒ–] å…ˆåœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå§”æ‰˜äººçš„å‘è¨€ï¼ˆæ¨¡æ‹ŸçœŸå®ä¼šè®®åœºæ™¯ï¼‰
            const debateArea = document.getElementById('debateArea');
            const currentRoundContainer = debateArea.querySelector('[data-round]:last-child');

            if (currentRoundContainer) {
                const speechesContainer = currentRoundContainer.querySelector('.speeches-container');
                const delegateSpeechEl = document.createElement('div');
                delegateSpeechEl.className = 'speech-item';
                delegateSpeechEl.style.borderLeftColor = '#FFD700'; // é‡‘è‰²ï¼Œçªå‡ºæ˜¾ç¤º
                delegateSpeechEl.style.backgroundColor = '#FFFAF0'; // æš–ç±³ç™½èƒŒæ™¯
                delegateSpeechEl.innerHTML = `
                    <div class="speech-header">
                        <span class="speech-role-icon">ğŸ’¬</span>
                        <span>å§”æ‰˜äºº ã€é‡è¦è¡¥å……ã€‘</span>
                    </div>
                    <div class="speech-content">${feedback}</div>
                `;
                speechesContainer.appendChild(delegateSpeechEl);
                delegateSpeechEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }

            // âœ… [å…³è” #091] é«˜æƒé‡è®°å½•ï¼šæ ‡è®°ä¸ºé‡è¦è¡¥å……ä¿¡æ¯
            if (window.currentDelegateCallback && typeof window.currentDelegateCallback === 'function') {
                try {
                    // ä¼ é€’è¡¥å……ä¿¡æ¯ï¼ˆå¸¦ç‰¹æ®Šæ ‡è®°è¡¨ç¤ºé«˜æƒé‡ï¼‰
                    window.currentDelegateCallback(`[HIGH_PRIORITY] ${feedback}`);
                    console.log('âœ… [BUG-012] è¡¥å……æ„è§å·²æäº¤ï¼Œæ ‡è®°ä¸ºé«˜æƒé‡');

                    window.currentDelegateCallback = null;
                } catch (error) {
                    console.error('âŒ [BUG-012] æäº¤è¡¥å……æ„è§å¤±è´¥:', error);
                    alert('æäº¤å¤±è´¥ï¼š' + error.message);
                    return; // âœ… [FIX BUG #2] å¤±è´¥æ—¶ä¸ç§»é™¤å¼¹çª—ï¼Œè®©ç”¨æˆ·é‡è¯•
                }
            } else {
                console.error('âŒ [BUG-012] currentDelegateCallback æ— æ•ˆï¼');
                alert('ç³»ç»Ÿé”™è¯¯ï¼šå›è°ƒå‡½æ•°ä¸¢å¤±ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }

            // âœ… [FIX BUG #2] æˆåŠŸæˆ–å›è°ƒä¸¢å¤±åéƒ½ç§»é™¤å¼¹çª—
            document.querySelector('.delegate-prompt')?.remove();
        }

        // è·³è¿‡å§”æ‰˜äººè¾“å…¥ï¼ˆä¿ç•™æ—§å‡½æ•°ä»¥å…¼å®¹å…¶ä»–é˜¶æ®µï¼‰
        function skipDelegateInput() {
            confirmAndStartDebate();
        }

        // âœ… [æ¨¡å—åŒ–ä¼˜åŒ–] è¯­éŸ³åŠŸèƒ½å·²è¿ç§»è‡³ voice.jsï¼Œé€šè¿‡ window.VoiceModule è°ƒç”¨

        // âœ… [FIX Issue #1] æ–‡å­—é€Ÿåº¦è°ƒèŠ‚æ¡¥æ¥å‡½æ•°
        function adjustTextRate(delta) {
            if (window.TextRateController) {
                window.TextRateController.adjustRate(delta);
            } else {
                console.error('âŒ TextRateController æ¨¡å—æœªåŠ è½½');
            }
        }

        // âœ… [FIX P0-02] æµ‹è¯•è¯­éŸ³è¾“å‡ºåŠŸèƒ½
        function testVoiceOutput() {
            console.log('ğŸ§ª [FIX P0-02] testVoiceOutput è¢«è°ƒç”¨');

            // è‡ªåŠ¨å¼€å¯è¯­éŸ³ï¼ˆå¦‚æœæœªå¼€å¯ï¼‰
            if (!window.VoiceModule.isVoiceEnabled()) {
                window.VoiceModule.toggleVoiceOutput();
                console.log('âœ… [FIX P0-02] è‡ªåŠ¨å¼€å¯è¯­éŸ³');
            }

            // æµ‹è¯•æ–‡æœ¬
            const testText = 'è¯­éŸ³æµ‹è¯•ï¼šå¤šé­”æ±°é£æš´è¾©è®ºç³»ç»Ÿå·²å°±ç»ªï¼Œä¸“å®¶ä»¬å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šå»ºè®®ã€‚';

            console.log('ğŸ§ª [FIX P0-02] å‡†å¤‡æœ—è¯»æµ‹è¯•æ–‡æœ¬:', testText);

            // è°ƒç”¨è¯­éŸ³æ¨¡å—
            if (window.VoiceModule && window.VoiceModule.speakText) {
                window.VoiceModule.speakText(testText, 'ç³»ç»Ÿ');

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                const btn = document.getElementById('testVoiceBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… æœ—è¯»ä¸­...';
                btn.style.background = 'linear-gradient(135deg, #34C759 0%, #2E9E4D 100%)';

                // 3ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, #007AFF 0%, #0051D5 100%)';
                }, 3000);
            } else {
                alert('âŒ è¯­éŸ³æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // âœ… [Task #13] æ›´æ–°Tokenç»Ÿè®¡æ˜¾ç¤º
        function updateTokenDisplay(stats) {
            let tokenStatsEl = document.getElementById('tokenStats');

            // Create element if it doesn't exist
            if (!tokenStatsEl) {
                const debateArea = document.getElementById('debateArea');
                const tokenStatsHTML = `
                    <div id="tokenStats" class="token-stats">
                        <div class="token-stats-header">
                            <span>ğŸ“Š</span>
                            <span>Token æ¶ˆè€—ç»Ÿè®¡</span>
                        </div>
                        <div class="token-stats-grid">
                            <div class="token-stat-item">
                                <div class="token-stat-label">æ€»æ¶ˆè€—</div>
                                <div class="token-stat-value" id="totalTokens">0</div>
                            </div>
                            <div class="token-stat-item">
                                <div class="token-stat-label">å½“å‰è½®æ¬¡</div>
                                <div class="token-stat-value" id="currentRoundTokens">0</div>
                            </div>
                            <div class="token-stat-item">
                                <div class="token-stat-label">å¹³å‡/è½®</div>
                                <div class="token-stat-value" id="avgTokensPerRound">0</div>
                            </div>
                        </div>
                    </div>
                `;
                debateArea.insertAdjacentHTML('afterbegin', tokenStatsHTML);
                tokenStatsEl = document.getElementById('tokenStats');
            }

            // Show the component
            tokenStatsEl.classList.add('visible');

            // Update values
            document.getElementById('totalTokens').textContent = stats.total.toLocaleString();
            document.getElementById('currentRoundTokens').textContent = stats.currentRound.toLocaleString();

            const avgPerRound = stats.byRound.length > 0
                ? Math.round(stats.total / stats.byRound.length)
                : 0;
            document.getElementById('avgTokensPerRound').textContent = avgPerRound.toLocaleString();

            console.log('âœ… [Task #13] Tokenæ˜¾ç¤ºå·²æ›´æ–°', stats);
        }

        // âœ… [V57.11 FIX] å¤„ç†ç­–åˆ’è¿›åº¦ï¼ˆæ”¯æŒå¤šé˜¶æ®µåŠ¨æ€å…ƒç´ åˆ›å»ºï¼‰
        function handlePlanningProgress(data) {
            const { content, charCount, isStreaming, isComplete } = data;

            // ä¼˜å…ˆæŸ¥æ‰¾ç°æœ‰çš„è¿›åº¦å…ƒç´ 
            let progressEl = document.getElementById('planningProgress');

            // âœ… [V57.11 FIX] å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼ŒåŠ¨æ€åˆ›å»ºåˆ°å½“å‰æ´»è·ƒå®¹å™¨
            if (!progressEl) {
                // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾åˆé€‚çš„å®¹å™¨
                const activeCard = document.querySelector('.card.active') ||
                                  document.querySelector('[data-phase="confirmation"]') ||
                                  document.querySelector('.confirmation-area') ||
                                  document.querySelector('#planningArea') ||
                                  document.querySelector('.debate-container');

                if (activeCard) {
                    progressEl = document.createElement('p');
                    progressEl.id = 'planningProgress';
                    progressEl.style.marginTop = '15px';
                    progressEl.style.opacity = '0.7';
                    progressEl.style.fontSize = '0.95em';
                    progressEl.style.padding = '10px';
                    progressEl.style.backgroundColor = '#f8f9fa';
                    progressEl.style.borderRadius = '8px';
                    activeCard.appendChild(progressEl);
                    console.log('âœ… [V57.11] åŠ¨æ€åˆ›å»ºç­–åˆ’è¿›åº¦å…ƒç´ ');
                } else {
                    console.warn('âŒ [V57.11] æ‰¾ä¸åˆ°åˆé€‚çš„å®¹å™¨æ˜¾ç¤ºç­–åˆ’è¿›åº¦');
                    return;
                }
            }

            // âœ… ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–DOMæ›´æ–°
            requestAnimationFrame(() => {
                if (isStreaming) {
                    // æµå¼ä¼ è¾“ä¸­ï¼šæ˜¾ç¤ºè¿›åº¦å’Œå­—æ•°
                    progressEl.textContent = `ğŸ”„ æ­£åœ¨è°ƒæ•´ç­–ç•¥... å·²ç”Ÿæˆ ${charCount} å­—`;
                    progressEl.style.opacity = '1';
                    progressEl.style.color = '#007AFF';
                    progressEl.style.fontWeight = '500';
                } else if (isComplete) {
                    // å®Œæˆåï¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹
                    progressEl.innerHTML = content;
                    progressEl.style.color = '#333';
                    progressEl.style.fontWeight = '400';
                }
            });

            console.log(`ğŸ“ [V57.11] ç­–åˆ’è¿›åº¦æ›´æ–°: ${charCount} å­— (æµå¼: ${isStreaming})`);
        }

        // âœ… [V57-P1-3] å¤„ç†è½®æ¬¡é—´åœé¡¿
        function handleRoundPause(data) {
            console.log(`â±ï¸ [V57-P1-3] è½®æ¬¡é—´åœé¡¿:`, data);
            const { round, nextRound, pauseDuration, message } = data;

            // æ˜¾ç¤ºåœé¡¿æ¶ˆæ¯
            const debateArea = document.getElementById('debateArea');
            if (!debateArea) return;

            // åˆ›å»ºåœé¡¿æç¤ºå…ƒç´ 
            const pausePrompt = document.createElement('div');
            pausePrompt.className = 'speech-item facilitator-speech';
            pausePrompt.style.backgroundColor = '#F0F8FF';  // æµ…è“è‰²èƒŒæ™¯
            pausePrompt.style.margin = '20px 0';
            pausePrompt.style.padding = '20px';
            pausePrompt.style.borderRadius = '12px';
            pausePrompt.style.borderLeft = '4px solid #007AFF';
            pausePrompt.style.textAlign = 'center';
            pausePrompt.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 10px;">â±ï¸</div>
                <p style="font-size: 16px; font-weight: 600; color: #333; margin: 0;">
                    ${message}
                </p>
                <p style="font-size: 13px; color: #999; margin: 10px 0 0 0;">
                    ${pauseDuration / 1000}ç§’åå¼€å§‹...
                </p>
            `;
            debateArea.appendChild(pausePrompt);

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            pausePrompt.scrollIntoView({ behavior: 'smooth', block: 'end' });

            // åœé¡¿ç»“æŸåç§»é™¤æç¤º
            setTimeout(() => {
                pausePrompt.remove();
                console.log(`âœ… [V57-P1-3] è½®æ¬¡${round}â†’${nextRound}çš„åœé¡¿å·²å®Œæˆ`);
            }, pauseDuration);
        }

        // å¤„ç†é”™è¯¯
        function handleError(data) {
            console.error('è¾©è®ºé”™è¯¯:', data);
            alert(`é£æš´è¾©è®ºè¿‡ç¨‹å‡ºé”™ï¼š${data.error.message}`);
        }


        // âœ… [Task #3] å¯¼å‡ºæŠ¥å‘Š - ä½¿ç”¨ç‹¬ç«‹çš„ export.js æ¨¡å—
        function exportReport(format) {
            if (!state.debateEngine || !state.debateEngine.state.reportData) {
                alert('æŠ¥å‘Šå°šæœªç”Ÿæˆï¼Œè¯·ç­‰å¾…é£æš´è¾©è®ºå®Œæˆã€‚');
                return;
            }

            // ä½¿ç”¨ç‹¬ç«‹çš„ ExportManager æ¨¡å—
            if (!window.exportManager) {
                console.error('âŒ export.js æ¨¡å—æœªåŠ è½½');
                alert('å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            try {
                if (format === 'json') {
                    window.exportManager.exportAsJSON({
                        reportData: state.debateEngine.state.reportData
                    });
                } else if (format === 'pdf') {
                    window.exportManager.exportAsPDF({
                        reportData: state.debateEngine.state.reportData,
                        targetSelector: '.report-section'
                    });
                }
            } catch (error) {
                console.error('âŒ å¯¼å‡ºå¤±è´¥:', error);
                alert(`å¯¼å‡ºå¤±è´¥ï¼š${error.message}`);
            }
        }

        // âŒ [Task #006 - Placeholder] æ¨¡æ‹Ÿé›·è¾¾å›¾æ•°æ®å±•ç¤ºï¼ˆéœ€è¦ Rechartsï¼‰
        function showRadarChart(reportData) {
            // ç”±äºæœ¬é¡¹ç›®æœªä½¿ç”¨ React/Rechartsï¼Œæ­¤å¤„ä»…å±•ç¤ºä¸€ä¸ªå ä½ç¬¦æˆ–ç®€æ˜“ SVG/Canvas
            const debateArea = document.getElementById('debateArea');
            if (!debateArea) return;

            let chartPlaceholder = debateArea.querySelector('#radarChartPlaceholder');
            if (!chartPlaceholder) {
                chartPlaceholder = document.createElement('div');
                chartPlaceholder.id = 'radarChartPlaceholder';
                chartPlaceholder.className = 'report-section';
                debateArea.insertBefore(chartPlaceholder, debateArea.querySelector('.debate-round') || debateArea.firstChild);
            }

            chartPlaceholder.innerHTML = `
                <h2>ğŸ“Š é£æš´è¾©è®ºæ€»ç»“é›·è¾¾å›¾ï¼ˆå¯è§†åŒ–ï¼‰</h2>
                <div style="border: 1px dashed #ccc; padding: 30px; text-align: center; border-radius: 10px; margin-top: 20px;">
                    <p style="font-size: 1.1em; color: #667eea;">âš ï¸ å¯è§†åŒ–åŠŸèƒ½å¾…é›†æˆ Recharts åº“</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">
                        å½“å‰å±•ç¤ºï¼š[å‡è®¾ç”Ÿæˆé›·è¾¾å›¾] æ ¸å¿ƒæ´å¯Ÿåˆ†å¸ƒï¼ˆå¾…å®Œæ•´æ•°æ®å¡«å……ï¼‰
                    </p>
                    <!-- ç®€æ˜“ SVG å ä½ -->
                    <svg width="300" height="300" viewBox="0 0 100 100" style="margin-top: 20px;">
                        <circle cx="50" cy="50" r="45" fill="rgba(0, 122, 255, 0.1)" stroke="#007AFF" stroke-width="1"/>
                        <circle cx="50" cy="50" r="25" fill="none" stroke="#007AFF" stroke-width="0.5"/>
                        <line x1="50" y1="5" x2="50" y2="95" stroke="#007AFF" stroke-width="0.5"/>
                        <line x1="85" y1="50" x2="15" y2="50" stroke="#007AFF" stroke-width="0.5"/>
                        <text x="50" y="10" text-anchor="middle" font-size="6" fill="#333">æ´å¯Ÿ</text>
                    </svg>
                </div>
            `;
            chartPlaceholder.style.display = 'block';
            // æ»šåŠ¨åˆ°å›¾è¡¨ä½ç½®
            chartPlaceholder.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

    </script>
</body>
</html>
