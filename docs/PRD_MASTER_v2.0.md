# 多魔汰风暴辩论系统 - 产品需求文档 MASTER v2.0
> 最后更新: 2025-11-04 04:50 GMT+8
> 整合来源: ideas.md, PRD.md, PRD_DebateFlow_FINAL_v1.1.md, PRD_CONSOLIDATED_v1.md

## 📋 目录

1. [产品概述](#1-产品概述)
2. [核心功能规格](#2-核心功能规格)
3. [技术架构](#3-技术架构)
4. [用户体验设计](#4-用户体验设计)
5. [测试验证清单](#5-测试验证清单)
6. [已知问题与待优化](#6-已知问题与待优化)
7. [开发规范与约定](#7-开发规范与约定)
8. [交付计划](#8-交付计划)

---

## 1. 产品概述

### 1.1 产品定位
**多魔汰风暴辩论系统**是基于AI角色扮演的多专家决策支持系统，通过16个不同视角的专家角色进行结构化辩论，帮助用户在复杂决策场景下获得全方位的专业分析。

### 1.2 核心价值
- **多维度分析**: 16个专家角色覆盖商业、技术、市场、风险等全方位视角
- **结构化决策**: 标准化的5阶段流程确保辩论质量和深度
- **实时交互**: 委托人可在关键节点补充意见，动态调整辩论方向
- **智能总结**: 自动生成可视化报告和行动建议

### 1.3 目标用户
- **决策者**: 需要多角度专业意见的企业管理者
- **创业者**: 评估商业计划和战略方向
- **个人用户**: 面临重要人生选择需要深度分析

---

## 2. 核心功能规格

### 2.1 五阶段流程架构

#### 阶段1: 准备 (Preparation)
```
用户输入:
├── 决策问题 (5-500字)
├── 背景信息 (可选, 0-1000字)
├── 角色选择 (必选8个核心 + 可选其他)
└── 辩论轮次 (3/5/8/10轮)
```

#### 阶段2: 策划 (Planning)
```
领袖输出:
├── 问题理解与重构
├── 参与专家清单(含昵称)
├── 各轮主题规划
└── 执行方式说明
```

#### 阶段3: 确认 (Confirmation)
```
委托人操作:
├── 查看策划内容
├── 补充意见 (可选)
└── 确认开始辩论
```

#### 阶段4: 辩论 (Debate)
```
每轮标准流程:
├── 领袖开场 (150-400字)
├── Phase 1: 上半轮轮流发言 (每位300-500字)
├── 中场转场
│   ├── 领袖承上发言 (200-400字)
│   ├── 委托人中场补充 (可选)
│   └── 领袖启下发言 (200-400字)
├── Phase 2: 下半轮补充发言 (每位300-500字)
├── 预总结
│   ├── 领袖预总结 (300-500字)
│   └── 委托人本轮补充 (可选)
└── 本轮总结 (300-600字)
```

#### 阶段5: 交付 (Delivery)
```
输出内容:
├── 总结报告
├── 核心洞察
├── 行动计划
├── 迭代建议
└── 后续服务选项
```

### 2.2 角色系统设计

#### 16个专家角色配置

| 层级 | 角色 | 昵称 | 性别 | 必选 | 核心职责 |
|------|------|------|------|------|----------|
| **核心分析层** | 第一性原理专家 | Elon | 男 | ✅ | 本质分析 |
| | 时间穿越专家 | Clara | 女 | ✅ | 趋势预测 |
| | 上帝视角专家 | Zeus | 男 | ✅ | 全局洞察 |
| **外部威胁与机遇层** | 杠精专家 | Donald | 男 | ✅ | 挑战假设 |
| | 买单客户 | Chloe | 女 | ✅ | 用户视角 |
| | 竞争友商 | Eve | 女 | ✅ | 竞争分析 |
| | 潜在威胁 | Jack | 男 | ⭕ | 风险识别 |
| **价值与行动层** | 落地执行者 | Owen | 男 | ✅ | 实施方案 |
| | 风险管理者 | Rick | 男 | ⭕ | 风险控制 |
| | VC投资人 | Mark | 男 | ⭕ | 商业价值 |
| | 供应体系 | Mary | 女 | ⭕ | 资源协调 |
| | 性能追求者 | Jason | 男 | ⭕ | 技术优化 |
| | 情绪追求者 | Joy | 女 | ⭕ | 情感价值 |
| | 社会认同者 | Liam | 男 | ⭕ | 社会影响 |
| **协调层** | 领袖(委托代理) | Victoria | 女 | ✅ | 流程管理 |

### 2.3 字数控制规格

#### 测试用户 (13917895758) 字数减半配置

| 发言类型 | 标准用户 | 测试用户 | 实现位置 |
|---------|---------|---------|----------|
| 领袖首轮开场 | 400-800字 | 200-400字 | wordLimits.leaderOpening |
| 领袖其他轮开场 | 150字 | 75字 | wordLimits.leaderOtherRounds |
| 专家轮流发言 | 300-500字 | 150-250字 | wordLimits.expertSpeech |
| 专家补充发言 | 300-500字 | 150-250字 | maxTokens=900 |
| 中场转场 | 250字 | 125字 | wordLimits.transition |
| 预总结 | 300字 | 150字 | wordLimits.leaderPreSummary |
| 最终总结 | 600字 | 300字 | wordLimits.summary |

---

## 3. 技术架构

### 3.1 系统架构
```
前端 (Port 8080)
├── 单文件HTML (duomotai/index.html)
├── 模块化JS (src/modules/)
├── 样式文件 (styles.css)
└── 语音模块 (voice.js)

后端API (Port 3001)
├── Node.js + Express
├── AI服务集成
│   ├── Qwen (主)
│   ├── DeepSeek (备)
│   └── OpenAI (降级)
└── 数据存储 (JSON文件)
```

### 3.2 关键模块

#### 辩论引擎 (debateEngine.js)
- **流程控制**: 5阶段状态机管理
- **AI调用**: 统一的AI服务接口
- **流式输出**: 支持增量内容显示
- **上下文管理**: contextDatabase.js

#### 语音系统 (voice.js)
- **语音输出**: Web Speech API
- **语音输入**: 语音识别
- **同步机制**: Synctxt&voice v1.0
- **队列管理**: 防止语音被切断

#### UI系统 (debate-ui.js)
- **流式渲染**: 打字机效果
- **响应式设计**: 移动端适配
- **苹果风格**: 圆角、渐变、阴影

---

## 4. 用户体验设计

### 4.1 界面布局

#### 固定布局结构
```
┌─────────────────────────────────┐
│      顶部Banner (固定)           │
│  ├── Logo + 版本号              │
│  ├── 用户状态                   │
│  ├── 语音/文字速度控制          │
│  └── 阶段指示器                 │
├─────────────────────────────────┤
│                                 │
│      中间内容区 (可滚动)         │
│  ├── 辩论内容                   │
│  └── 实时更新                   │
│                                 │
├─────────────────────────────────┤
│      底部操作区 (固定)           │
│  ├── 输入框 + 语音按钮          │
│  └── 操作按钮 (2-3个自适应)     │
└─────────────────────────────────┘
```

### 4.2 交互设计原则

#### 按钮布局规则
- 2个按钮: 各占50%宽度
- 3个按钮: 各占33.3%宽度
- 统一高度、圆角、渐变

#### 视觉层次
- **委托人发言**: 金色左边框 + 暖米白背景
- **领袖发言**: 标准白色背景
- **专家发言**: 根据phase调整背景色
  - round_robin: #F5F5F7 (浅灰)
  - supplementary: #FFFBEA (浅黄)
  - transition: #F0F8FF (浅蓝)

### 4.3 响应式适配

```css
/* 移动端优先 */
@media (max-width: 768px) {
  .debate-round { padding: 15px; }
  .speech-item { font-size: 14px; }
  .action-btn { padding: 12px; }
}

/* 桌面端增强 */
@media (min-width: 1024px) {
  .container { max-width: 1200px; }
  .speeches-container { padding: 30px; }
}
```

---

## 5. 测试验证清单

### 5.1 功能测试 ✅

- [x] 用户登录/注册流程
- [x] 测试用户(13917895758)自动填充
- [x] 16个角色卡片显示(含昵称)
- [x] 必选8个角色验证
- [x] 策划内容生成
- [x] 委托人补充提交
- [x] 中场流程验证 (V57.22)
- [x] 专家发言字数控制
- [x] 语音同步播放
- [x] 导航条显示问题 (V57.20)
- [x] 专家语音不被切断 (V57.21)
- [x] 文字速度UI显示 (V57.22)

### 5.2 性能测试 ⏳

- [ ] 首屏加载 < 2秒
- [ ] AI响应 < 3秒
- [ ] 10用户并发测试
- [ ] 内存泄漏检测
- [ ] Token使用优化

### 5.3 兼容性测试 ⏳

- [ ] Chrome 90+
- [ ] Edge 90+
- [ ] Safari 14+
- [ ] 移动端Safari
- [ ] 移动端Chrome

---

## 6. 已知问题与待优化

### 6.1 P0 紧急问题 ✅ 已修复
- [x] 导航条不显示 (V57.20)
- [x] 专家语音被切断 (V57.21)
- [x] 文字速度UI错误 (V57.22)

### 6.2 P1 重要优化
- [ ] 自动化测试脚本 (Playwright)
- [ ] 服务器自动启动
- [ ] 完整流程测试
- [ ] 内容深度优化

### 6.3 P2 体验优化
- [ ] 顶部Banner自动隐藏
- [ ] 虚拟头像显示
- [ ] 数字人口型同步
- [ ] 深色模式支持

---

## 7. 开发规范与约定

### 7.1 版本管理
- 版本号格式: VXX.YY (如 V57.22)
- 每次修改必须更新版本号(两处同步)
- 自动触发备份 (D-97规则)

### 7.2 端口分配
- 前端: 8080
- 后端API: 3001
- 禁止使用: 6000-6999, 7000-7999

### 7.3 测试账号
- 手机号: 13917895758
- 验证码: 888888
- 特权: 字数减半、最少2个专家

### 7.4 代码保护规则
- 标记 `// PROTECTED` 的代码禁止修改
- D-87锁定的测试用户功能不可变更
- 修改前需用户确认 (D-89规则)

---

## 8. 交付计划

### 8.1 里程碑
- **2025-10-16**: 完整自测 (多魔汰v1.0)
- **2025-10-18**: 第一版交付
- **2025-11-04**: V57.22版本完成

### 8.2 交付物
1. **多魔汰系统 v1.0**
   - 完整5阶段流程
   - 16角色系统
   - 语音同步功能

2. **百问自测系统**
   - 100题评估工具
   - 分析报告生成

3. **技术文档**
   - PRD完整版
   - API文档
   - 部署指南

### 8.3 验收标准
- 所有P0问题修复
- 核心流程测试通过
- Gemba-Agent自动化验证
- 性能指标达标

---

## 附录A: 快速参考

### 启动命令
```bash
# 方式1: 批处理脚本
localhost_start.bat → 选择 [3] Full Stack

# 方式2: 手动启动
python -m http.server 8080  # 前端
cd server && npm run dev     # 后端
```

### 端口检查
```bash
netstat -ano | findstr "3001\|8080"
powershell -ExecutionPolicy Bypass -File scripts/safe_port_cleanup.ps1
```

### 版本备份
```bash
# 自动备份 (通过agent)
>>zip&"关键词"

# 手动备份
powershell -File scripts/TaskDone_BackUp_Exclude.ps1
```

---

## 附录B: 决策记录索引

| 决策号 | 内容 | 日期 | 状态 |
|--------|------|------|------|
| D-63 | 语音与文字流同步机制 | 2025-10-14 | ✅ |
| D-68 | 跨项目端口保护 | 2025-10-20 | ✅ |
| D-76 | 测试用户最少2专家 | 2025-10-25 | ✅ |
| D-77 | Gemba-Agent自动化 | 2025-10-25 | ✅ |
| D-79 | 禁止自动启动服务 | 2025-10-25 | ✅ |
| D-84 | 字数减半功能 | 2025-10-26 | ✅ |
| D-85 | 版本号管理 | 2025-10-26 | ✅ |
| D-87 | 测试用户功能锁定 | 2025-10-26 | ✅ |
| D-89 | 已锁定模块保护 | 2025-10-26 | ✅ |
| D-95 | 版本自动更新 | 2025-10-26 | ✅ |
| D-97 | 版本自动备份 | 2025-10-26 | ✅ |
| D-98 | Playwright迁移 | 2025-10-31 | ✅ |
| D-102 | 禁用>nul重定向 | 2025-10-29 | ✅ |

---

**文档版本**: v2.0
**创建时间**: 2025-11-04 04:50 GMT+8
**作者**: Claude Code Agent (Night-Auth模式)
**状态**: 📝 持续更新中