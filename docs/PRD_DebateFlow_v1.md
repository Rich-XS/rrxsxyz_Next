# PRD: 风暴辩论流程 v1.0

**基于 ideas.md L234-249 整理**
**时间**: 2025-10-25 Night-Auth
**决策**: D-77 系统性需求明确化

---

## 概述

多魔汰风暴辩论系统的完整流程包括 **策划 → 确认 → 多轮辩论 → 交付** 四个阶段。

核心特点：
- **领袖(委托代理)** 为流程的关键驱动，负责承上启下
- **每轮标准流程** 包括：开场 → 上半轮发言 → 中场转场 → 下半轮发言 → 本轮总结
- **委托人参与点** 分布在关键节点（开场补充、中场补充、本轮补充）

---

## 整体架构

### 5 阶段流程

| 阶段 | 描述 | 当前状态 |
|------|------|--------|
| 1. 准备 | 用户输入话题、选择角色 | ✅ 完成 |
| 2. 策划 | 领袖制定辩论策略 | ✅ 完成 |
| 3. 确认 | 委托人确认/补充 | ✅ 完成 |
| 4. 辩论 | 多轮风暴辩论（每轮一个完整流程） | ⚠️ 需修正 |
| 5. 交付 | 最终总结+感谢 | ✅ 完成 |

---

## 首轮开场流程

### 目的
- 介绍本次风暴辩论的核心问题和背景
- 介绍委托人、参与的专家（含昵称）
- 展示各轮主题和执行方式
- 为后续辩论建立共识基础

### 参与角色
- **领袖**: 主持人
- **委托人**: 信息提供者

### 流程步骤

```
[领袖 首轮开场] (400-800字)
  内容要求:
  - 问题点总结（核心痛点是什么）
  - 背景信息（当前现状）
  - 委托人身份（谁提出这个问题）
  - 参与专家清单（含昵称）
  - 各轮主题规划（第几轮讲什么）
  - 执行方式说明（先上半轮轮流发言，中场小结，下半轮补充发言，最后总结）

↓

[委托人 开场补充] (可选)
  - 对领袖开场的补充或澄清
```

**字数控制**: 400-800字
**参考实现**: `debateEngine.js` L420-421 中的 `leaderOpening` 字数配置

---

## 每轮标准流程

### 完整执行步骤

#### 步骤 1: 轮开场 (100-300字)
**角色**: 领袖
**内容**:
- 宣布进入第X轮
- 说明本轮主题（从策划方案中获取）
- 说明本轮目标和产出期望

**字数**: 100-300字
**实现**: 当前未单独配置（包含在轮流发言开场中）

---

#### 步骤 2: 委托人开场补充 (可选)
**角色**: 委托人
**内容**: 对本轮的特殊指示或补充

---

#### 步骤 3: 上半轮开场 (100-300字)
**角色**: 领袖
**内容**:
- 根据委托人补充，重点强调本轮要点
- 宣布进入"轮流发言"环节
- 确认发言顺序（通常按角色优先级）

**字数**: 100-300字
**实现**: 当前未单独配置（包含在首轮开场中）

---

#### 步骤 4: 上半轮轮流发言 (各专家300-500字)
**角色**: 各专家（按优先级轮流）
**内容**: 每位专家根据其角色特点发表观点

**字数**: 各专家 300-500字
**实现**: `debateEngine.js` L451-460 中的 `leaderOtherRounds` 字数配置
**问题**: ⚠️ 当前设置不清晰，需要明确专家发言的字数限制 >>>RRXS: 标准:300~500字

---

#### 步骤 5: 中场转场前 - 上半轮小结 (200-400字)
**角色**: 领袖
**内容**:
- 总结上半轮的核心观点
- 邀请委托人进行"中场补充"

**字数**: 200-400字
**实现**: 当前未单独配置（见中场转场）

---

#### 步骤 6: 委托人中场补充 (可选)
**角色**: 委托人
**内容**: 对上半轮的补充、调整或方向指引

---

#### 步骤 7: 中场转场后 - 下半轮开场 (200-400字)
**角色**: 领袖
**内容**:
- 根据委托人补充，调整下半轮重点
- 宣布进入"补充发言"环节
- 邀请部分或全部专家进行补充

**字数**: 200-400字
**实现**: `debateEngine.js` L420 中的 `transition` 字数配置
**当前设置**: maxTokens=800（对应 200-400字）✅

---

#### 步骤 8: 下半轮补充发言 (各专家300-500字)
**角色**: 各专家（自由补充）
**内容**: 基于前面讨论，进行深化或补充观点

**字数**: 各专家 300-500字
**实现**: 同步骤 4

---

#### 步骤 9: 本轮预总结 (300-500字)
**角色**: 领袖
**内容**:
- 总结下半轮的关键洞察
- 邀请委托人进行"本轮补充"

**字数**: 300-500字
**实现**: 当前未单独配置（包含在本轮总结中）

---

#### 步骤 10: 委托人本轮补充 (可选)
**角色**: 委托人
**内容**: 对本轮全部讨论的最终补充或确认

---

#### 步骤 11: 本轮最终总结 (400-600字)
**角色**: 领袖
**内容**:
- 综合上半轮、中场补充、下半轮、委托人补充
- 提炼本轮的核心共识和关键行动点
- 宣布进入下一环节

**字数**: 400-600字
**实现**: `debateEngine.js` 中的 `summary` 字数配置
**当前设置**: maxTokens=1200（对应 400-600字）✅

---

### 轮与轮之间

**间隔时间**: 2秒
**实现**: `debateEngine.js` 中的 delay 机制

---

## 专家发言字数标准

### 当前问题

**ideas.md L269**: "专家: 每次发言在300~500字"
**当前设置**: maxTokens=450（对应 ~360字）
**问题**:
- 设置值过低，无法充分发挥专家的深度思考
- 多个专家发言内容重复、缺乏差异
- 与需求的 300-500字 不符

### 修复方案

| 场景 | 需求 | 当前设置 | 修复目标 |
|------|------|--------|---------|
| 上半轮轮流发言 | 300-500字 | ❌ 不清晰 | 设定 maxTokens=900-1000 |
| 下半轮补充发言 | 300-500字 | ❌ 不清晰 | 设定 maxTokens=900-1000 |

---

## 领袖字数配置清单

### 根据测试用户动态调整

| 环节 | 标准用户 | 测试用户(减半) | maxTokens参数 | 实现状态 |
|------|--------|------------|---------------|--------|
| 策划阶段 | 700字 | 350字 | wordLimits.planning | ✅ D-76完成 |
| 首轮开场 | 900字 | 450字 | wordLimits.leaderOpening | ✅ D-76完成 | >>>RRXS: 标准:400~800字
| 其他轮开场 | 150字 | 75字 | wordLimits.leaderOtherRounds | ✅ D-76完成 |
| 中场转场 | 250字 | 125字 | wordLimits.transition | ✅ D-76完成 |
| 最终总结 | 600字 | 300字 | wordLimits.summary | ✅ D-76完成 |
| 感谢致辞 | 150字 | 75字 | wordLimits.thanks | ✅ D-76完成 |

---

## 核心问题待解决

### P0 - 关键流程问题

1. **专家发言字数不符合需求**
   - 需求: 300-500字
   - 当前: ~360字（maxTokens=450）
   - 根因: 字数限制过低，无法展示深度思考
   - 修复: 增加 maxTokens 到 900-1000

2. **中场转场时领袖无语音**
   - 问题: 转场环节缺少语音输出
   - 根因: 可能是角色声音未配置
   - 影响: 用户体验不连贯

3. **多个专家发言内容重复**
   - 问题: ideas.md L279 "很多专家的发言都是一样的"
   - 根因: 提示词不够细致，AI未能体现角色差异
   - 修复: 加强每个角色的提示词差异化

### P1 - 流程完整性问题

4. **预总结环节未单独配置**
   - 当前: 预总结内容包含在本轮总结中
   - 修复: 分离为独立环节，单独配置字数（300-500字）

5. **上半轮小结未单独配置**
   - 当前: 上半轮小结内容包含在中场转场中
   - 修复: 分离为独立环节，单独配置字数（200-400字）

---

## 验证检查清单

### Gemba-Agent 应验证的项目

- [ ] 策划阶段字数 < 350字（测试用户）
- [ ] 首轮开场字数 < 450字（测试用户）
- [ ] 专家发言字数 < 250字（测试用户时应减半）
- [ ] 中场转场时领袖是否有语音输出
- [ ] 专家发言内容是否有差异（角色特征是否体现）
- [ ] 完整流程是否按 11 个步骤执行
- [ ] 轮与轮之间是否有 2 秒间隔
- [ ] UI 显示是否有混乱（文字流式输出是否正常）

---

## 实现优先级

| 优先级 | 任务 | 文件 | 工作量 |
|-------|------|------|--------|
| P0 | 修正专家发言字数配置 | debateEngine.js | 1-2h |
| P0 | 验证中场转场领袖语音 | debateEngine.js | 1h |
| P1 | 分离预总结为独立环节 | debateEngine.js | 2-3h |
| P1 | 分离上半轮小结为独立环节 | debateEngine.js | 2-3h |
| P1 | 加强角色提示词差异化 | roles.js systemPrompt | 3-4h |

---

## 参考文档

- **ideas.md L234-249**: 风暴辩论流程原始需求
- **debateEngine.js**: 当前实现
- **promptTemplates.js**: 提示词模板
- **roles.js**: 角色定义和提示词

---

**PRD 状态**: Draft v1.0
**验证方式**: 通过 Gemba-Agent 自动化测试
**更新周期**: 每次 D-77 后续任务完成后更新
